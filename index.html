<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Unbroken Ascent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Tutorial Styles */
        .tutorial-modal {
            z-index: 10000;
            background: rgba(0, 0, 0, 0.95);
        }

        .tutorial-content {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border: 2px solid #3498db;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .tutorial-header {
            background: linear-gradient(90deg, #3498db, #2980b9);
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .tutorial-header h2 {
            margin: 0;
            color: white;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .tutorial-progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 14px;
            color: white;
            display: inline-block;
        }

        .tutorial-body {
            padding: 30px;
            text-align: center;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .tutorial-body h3 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .tutorial-body p {
            color: #bdc3c7;
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .tutorial-visual {
            margin: 20px 0;
            font-size: 48px;
            opacity: 0.8;
        }

        .tutorial-footer {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 70px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tutorial-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
            min-width: 100px;
            position: relative;
            z-index: 10001;
            pointer-events: auto;
        }

        .tutorial-btn.show {
            display: inline-block !important;
        }

        .tutorial-btn.hide {
            display: none !important;
        }

        .tutorial-next, .tutorial-finish {
            background: linear-gradient(90deg, #27ae60, #229954);
            color: white;
        }

        .tutorial-prev {
            background: linear-gradient(90deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .tutorial-skip {
            background: transparent;
            color: #bdc3c7;
            border: 1px solid #7f8c8d;
        }

        .tutorial-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9998;
            display: none;
        }

        .tutorial-highlight {
            position: fixed;
            border: 3px solid #f39c12;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.6);
            z-index: 9999;
            display: none;
            pointer-events: none;
            animation: tutorialPulse 2s infinite;
        }

        @keyframes tutorialPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(243, 156, 18, 0.6); }
            50% { box-shadow: 0 0 30px rgba(243, 156, 18, 0.9); }
        }

        .tutorial-feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .tutorial-feature {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .tutorial-feature-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .tutorial-feature-text {
            font-size: 12px;
            color: #bdc3c7;
        }

        /* Tutorial restart button in settings */
        .tutorial-restart-btn {
            background: linear-gradient(90deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        /* Mobile Responsive Tutorial Styles */
        @media (max-width: 768px) {
            .tutorial-content {
                width: 95%;
                max-width: none;
                max-height: 90vh;
                margin: 20px auto;
            }
            
            .tutorial-header {
                padding: 15px;
            }
            
            .tutorial-header h2 {
                font-size: 20px;
                margin-bottom: 6px;
            }
            
            .tutorial-progress {
                font-size: 12px;
                padding: 4px 12px;
            }
            
            .tutorial-body {
                padding: 20px 15px;
                min-height: 200px;
                max-height: 60vh;
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            .tutorial-body h3 {
                font-size: 18px;
                margin-bottom: 12px;
            }
            
            .tutorial-body p {
                font-size: 14px;
                line-height: 1.5;
                margin-bottom: 12px;
            }
            
            .tutorial-visual {
                font-size: 36px;
                margin: 15px 0;
            }
            
            .tutorial-footer {
                padding: 15px;
                flex-direction: column;
                gap: 8px;
                min-height: auto;
                flex-shrink: 0;
            }
            
            .tutorial-btn {
                width: 100%;
                max-width: 200px;
                padding: 12px 16px;
                font-size: 14px;
                min-width: auto;
            }
            
            .tutorial-feature-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                margin: 12px 0;
            }
            
            .tutorial-feature {
                padding: 8px;
            }
            
            .tutorial-feature-icon {
                font-size: 18px;
                margin-bottom: 4px;
            }
            
            .tutorial-feature-text {
                font-size: 9px;
                line-height: 1.2;
            }
        }

        @media (max-width: 480px) {
            .tutorial-content {
                width: 98%;
                max-height: 95vh;
                margin: 10px auto;
                border-radius: 8px;
            }
            
            .tutorial-header {
                padding: 12px;
                flex-shrink: 0;
            }
            
            .tutorial-header h2 {
                font-size: 18px;
                margin-bottom: 4px;
                line-height: 1.2;
            }
            
            .tutorial-progress {
                font-size: 11px;
                padding: 3px 10px;
            }
            
            .tutorial-body {
                padding: 12px 10px;
                min-height: 150px;
                max-height: 65vh;
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
            }
            
            .tutorial-body h3 {
                font-size: 16px;
                margin-bottom: 8px;
            }
            
            .tutorial-body p {
                font-size: 13px;
                line-height: 1.4;
                margin-bottom: 8px;
            }
            
            .tutorial-visual {
                font-size: 28px;
                margin: 10px 0;
            }
            
            .tutorial-footer {
                padding: 12px;
                gap: 6px;
                flex-shrink: 0;
            }
            
            .tutorial-btn {
                width: 100%;
                max-width: none;
                padding: 14px 12px;
                font-size: 13px;
                border-radius: 8px;
                font-weight: 600;
                margin: 2px 0;
                min-height: 44px; /* Minimum touch target size */
                touch-action: manipulation; /* Disable double-tap zoom */
                -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            }
            
            .tutorial-feature-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
                margin: 10px 0;
            }
            
            .tutorial-feature {
                padding: 6px;
                border-radius: 6px;
            }
            
            .tutorial-feature-icon {
                font-size: 16px;
                margin-bottom: 3px;
            }
            
            .tutorial-feature-text {
                font-size: 8px;
                line-height: 1.1;
            }
        }

        /* Ensure tutorial modal is above everything on mobile */
        @media (max-width: 768px) {
            .tutorial-modal {
                z-index: 10000 !important;
                background: rgba(0, 0, 0, 0.98) !important;
                padding: 10px;
                box-sizing: border-box;
            }
            
            .tutorial-overlay {
                z-index: 9999 !important;
            }
            
            .tutorial-highlight {
                z-index: 10001 !important;
            }
            
            /* Force button visibility on mobile - more specific selectors */
            .tutorial-footer .tutorial-btn.show {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            .tutorial-footer .tutorial-btn.hide {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
            }
        }

        .tutorial-restart-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Developer Menu Styles */
        .dev-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .dev-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .dev-btn {
            padding: 8px 12px;
            background: linear-gradient(90deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .dev-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .dev-btn.dangerous {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .dev-btn-small {
            padding: 4px 8px;
            background: linear-gradient(90deg, #27ae60, #229954);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            margin-left: 8px;
        }

        .dev-skill-controls {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }

        .skill-control {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .skill-control span {
            min-width: 120px;
            font-weight: bold;
        }

        .skill-control input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            text-align: center;
        }

        #devPasswordSection input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 6px;
        }

        #devPasswordSection input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c1426 0%, #1a2332 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 15px;
        }
        
        .app {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            color: #f4d03f;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: #85929e;
            font-size: 12px;
        }
        
        .skill-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .skill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .skill-name {
            font-size: 16px;
            font-weight: bold;
        }
        
        .skill-level {
            font-size: 12px;
            background: #f4d03f;
            color: #2c3e50;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f4d03f, #f39c12);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 11px;
            color: #bdc3c7;
            text-align: center;
        }
        
        .activity-form {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .form-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            color: #f4d03f;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 4px;
            font-size: 12px;
            color: #bdc3c7;
        }
        
        select, input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 14px;
        }
        
        select option {
            background: #2c3e50;
            color: #ffffff;
        }
        
        select option:disabled {
            background: #34495e;
            color: #7f8c8d;
            font-style: italic;
        }
        
        select option[disabled] {
            opacity: 0.5;
        }

        /* Enhanced Activity Type Dropdown Styling */
        #activity-type-select {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            font-size: 13px;
            line-height: 1.4;
            padding: 12px 40px 12px 12px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        #activity-type-select:hover {
            border-color: rgba(255, 255, 255, 0.3);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            transform: translateY(-1px);
        }

        #activity-type-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
        }

        #activity-type-select option {
            background: #2c3e50;
            color: #ffffff;
            padding: 12px 16px;
            font-size: 13px;
            line-height: 1.5;
            border: none;
            font-family: inherit;
        }

        #activity-type-select option:hover {
            background: #34495e;
        }

        #activity-type-select option:checked {
            background: linear-gradient(90deg, #3498db, #2980b9);
            color: #ffffff;
            font-weight: 500;
        }

        /* Activity Type Hint Styling */
        #activity-type-hint {
            color: #85929e;
            font-size: 11px;
            font-style: italic;
            margin-top: 6px;
            display: block;
        }

        /* Custom dropdown arrow */
        .form-group:has(#activity-type-select) {
            position: relative;
        }

        .form-group:has(#activity-type-select)::after {
            content: '▼';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #bdc3c7;
            pointer-events: none;
            font-size: 10px;
            margin-top: 8px;
        }

        /* Activity type specific styling for better organization */
        .activity-type-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .activity-type-badge {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, #f4d03f, #f39c12);
            color: #2c3e50;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }

        .btn-reset {
            background: linear-gradient(90deg, #e74c3c, #c0392b) !important;
            color: white !important;
            margin-top: 10px !important;
            padding: 8px !important;
            font-size: 12px !important;
        }
        
        .stats {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .streak {
            color: #f39c12;
            font-weight: bold;
        }
        
        .boss-status {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            color: #e74c3c;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .boss-ready {
            background: rgba(46, 204, 113, 0.2) !important;
            border-color: #2ecc71 !important;
            color: #2ecc71 !important;
        }
        
        .message {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            color: #3498db;
            font-size: 12px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .welcome {
            background: rgba(155, 89, 182, 0.2);
            border: 1px solid #9b59b6;
            color: #9b59b6;
        }
        
        .level-up {
            background: rgba(241, 196, 15, 0.3);
            border: 1px solid #f1c40f;
            color: #f1c40f;
            font-weight: bold;
        }
        
        .debug-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 10px;
            color: #f39c12;
            text-align: center;
        }

        /* Skill Tree Modal Styles */
        .skill-tree-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .skill-tree-content {
            background: linear-gradient(135deg, #0c1426 0%, #1a2332 100%);
            margin: 20px auto;
            padding: 25px;
            border-radius: 12px;
            max-width: 500px;
            min-height: 80vh;
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
        }

        .skill-tree-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .skill-tree-title {
            font-size: 20px;
            font-weight: bold;
            color: #f4d03f;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: #e74c3c;
            cursor: pointer;
            padding: 5px;
        }

        .close-modal:hover {
            color: #c0392b;
        }

        .tier-section {
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #f4d03f;
        }

        .tier-title {
            font-size: 16px;
            font-weight: bold;
            color: #f4d03f;
            margin-bottom: 10px;
        }

        .ability-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .ability-item.unlocked {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
        }

        .ability-item.locked {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0.6;
        }

        .ability-level {
            font-weight: bold;
            color: #f4d03f;
            min-width: 45px;
            text-align: center;
            background: rgba(244, 208, 63, 0.2);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 12px;
        }

        .ability-details {
            flex: 1;
            margin-left: 10px;
        }

        .ability-name {
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 2px;
        }

        .ability-description {
            font-size: 12px;
            color: #bdc3c7;
            line-height: 1.3;
        }

        .milestone-ability {
            border: 2px solid #f39c12 !important;
            background: rgba(243, 156, 18, 0.2) !important;
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.3);
        }

        .ultimate-ability {
            border: 2px solid #e74c3c !important;
            background: rgba(231, 76, 60, 0.2) !important;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.4);
        }

        .skill-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .skill-card:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #f4d03f;
            transform: translateY(-2px);
        }

        .milestone-rewards {
            background: rgba(231, 76, 60, 0.15);
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .milestone-title {
            font-size: 14px;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .skill-tree-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .skill-tree-content {
            background: linear-gradient(135deg, #0c1426 0%, #1a2332 100%);
            border-radius: 15px;
            padding: 20px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid #f4d03f;
        }
        
        .skill-tree-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .skill-tree-title {
            font-size: 24px;
            color: #f4d03f;
            margin-bottom: 10px;
        }
        
        .skill-tree-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .tier-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #f4d03f;
        }
        
        .tier-title {
            font-size: 18px;
            color: #f4d03f;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .ability-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 12px;
        }
        
        .ability-unlocked {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            color: #2ecc71;
        }
        
        .ability-locked {
            background: rgba(127, 140, 141, 0.2);
            border: 1px solid #7f8c8d;
            color: #7f8c8d;
        }
        
        .ability-close {
            background: rgba(241, 196, 15, 0.2);
            border: 1px solid #f1c40f;
            color: #f1c40f;
        }
        
        .ability-level {
            font-weight: bold;
            min-width: 40px;
        }
        
        .ability-name {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .ability-description {
            flex: 1;
            opacity: 0.8;
        }
        
        .milestone-section {
            background: rgba(155, 89, 182, 0.2);
            border: 2px solid #9b59b6;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .milestone-title {
            color: #9b59b6;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        /* Settings Tab Styles */
        .settings-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .settings-section h3 {
            color: #f4d03f;
            margin: 0 0 15px 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Integration Styles */
        .integration-group {
            margin-bottom: 20px;
        }
        
        .integration-header {
            font-size: 14px;
            font-weight: bold;
            color: #f4d03f;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .integration-item {
            margin-bottom: 8px;
        }
        
        .integration-btn {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
        }
        
        .integration-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #f4d03f;
        }
        
        .integration-btn.connected {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
        }
        
        .integration-btn.connected:hover {
            background: rgba(46, 204, 113, 0.3);
        }
        
        .integration-icon {
            font-size: 16px;
            margin-right: 8px;
        }
        
        .integration-name {
            flex: 1;
            text-align: left;
        }
        
        .integration-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .integration-status.connected {
            background: #2ecc71;
            color: white;
        }
        
        .sync-indicator {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 10px;
            color: #3498db;
            font-size: 11px;
            text-align: center;
        }
        
        /* PC Sync Styles */
        .sync-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .sync-section h3 {
            margin: 0 0 10px 0;
            color: #ecf0f1;
            font-size: 14px;
        }
        
        .sync-status-card {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 12px;
            gap: 12px;
        }
        
        .sync-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            flex-shrink: 0;
        }
        
        .sync-status-indicator.connected {
            background: #2ecc71;
        }
        
        .sync-status-indicator.syncing {
            background: #f39c12;
            animation: pulse 1.5s infinite;
        }
        
        .sync-status-text {
            flex: 1;
        }
        
        .sync-status-main {
            font-weight: bold;
            color: #ecf0f1;
            font-size: 13px;
        }
        
        .sync-status-sub {
            color: #bdc3c7;
            font-size: 11px;
            margin-top: 2px;
        }
        
        .sync-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .sync-actions .btn {
            flex: 1;
            min-width: 120px;
            font-size: 11px;
            padding: 8px 12px;
        }
        
        .data-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .data-actions .btn {
            flex: 1;
            font-size: 11px;
            padding: 8px 12px;
        }
        
        .sync-history {
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 8px;
        }
        
        .sync-history-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 11px;
        }
        
        .sync-history-item:last-child {
            border-bottom: none;
        }
        
        .sync-history-time {
            color: #bdc3c7;
            min-width: 60px;
        }
        
        .sync-history-action {
            color: #ecf0f1;
        }
        
        .sync-settings {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .sync-setting {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #ecf0f1;
            cursor: pointer;
        }
        
        .sync-setting input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Tab System Styles */
        .tab-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .tab-nav {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px 12px 0 0;
            padding: 6px;
            gap: 3px;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .tab-nav::-webkit-scrollbar {
            display: none;
        }
        
        .tab-btn {
            flex: 1;
            min-width: 70px;
            max-width: 100px;
            padding: 8px 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #bdc3c7;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            text-align: center;
            position: relative;
        }
        
        .tab-btn.active {
            color: #1a2332;
            background: linear-gradient(135deg, #f4d03f, #f39c12);
            border-color: #f4d03f;
            box-shadow: 0 2px 8px rgba(244, 208, 63, 0.3);
            transform: translateY(-1px);
        }
        
        .tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        /* Desktop tab optimization */
        @media (min-width: 769px) {
            .tab-nav {
                overflow-x: visible;
                justify-content: center;
            }
            
            .tab-btn {
                flex: 0 0 auto;
                min-width: 70px;
                max-width: 90px;
                font-size: 10px;
                padding: 8px 6px;
            }
        }
        
        /* Mobile tab optimization */
        @media (max-width: 768px) {
            .tab-nav {
                padding: 3px;
                gap: 1px;
                overflow-x: auto;
                justify-content: flex-start;
            }
            
            .tab-btn {
                flex: 0 0 auto;
                min-width: 65px;
                max-width: 80px;
                padding: 6px 4px;
                font-size: 9px;
                border-radius: 4px;
            }
        }
        
        @media (max-width: 480px) {
            .tab-nav {
                padding: 2px;
                gap: 1px;
            }
            
            .tab-btn {
                min-width: 58px;
                max-width: 70px;
                padding: 8px 3px;
                font-size: 8px;
                line-height: 1.1;
                overflow: hidden;
                text-indent: -9999px; /* Hide text completely */
            }
            
            /* Clean emoji-only labels on small screens */
            .tab-btn:nth-child(1)::after { content: "📊"; }
            .tab-btn:nth-child(2)::after { content: "⚔️"; }
            .tab-btn:nth-child(3)::after { content: "➕"; }
            .tab-btn:nth-child(4)::after { content: "📖"; }
            .tab-btn:nth-child(5)::after { content: "📜"; }
            .tab-btn:nth-child(6)::after { content: "⚙️"; }
            
            .tab-btn::after {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: #bdc3c7;
                font-size: 16px;
                text-indent: 0; /* Reset text-indent for pseudo-element */
            }
            
            .tab-btn.active::after {
                color: #1a2332;
                font-size: 18px;
            }
        }
        
        .tab-content {
            padding: 20px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dashboard-card h3 {
            color: #f4d03f;
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .notification-item {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid #3498db;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 12px;
            color: #3498db;
        }
        
        .notification-item.success {
            background: rgba(46, 204, 113, 0.1);
            border-color: #2ecc71;
            color: #2ecc71;
        }
        
        .notification-item.warning {
            background: rgba(241, 196, 15, 0.1);
            border-color: #f1c40f;
            color: #f1c40f;
        }
        
        .quick-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .quick-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }
        
        .quick-stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #f4d03f;
        }
        
        .quick-stat-label {
            font-size: 10px;
            color: #bdc3c7;
            margin-top: 4px;
        }
        
        /* Journal Styles */
        .journal-section {
            margin-bottom: 25px;
        }
        
        .journal-prompt-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .journal-prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .journal-prompt-time {
            background: linear-gradient(135deg, #f4d03f, #f39c12);
            color: #1a2332;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .journal-prompt-title {
            font-size: 16px;
            font-weight: bold;
            color: #ffffff;
        }
        
        .journal-prompt-text {
            font-size: 14px;
            color: #bdc3c7;
            line-height: 1.6;
            margin-bottom: 15px;
            font-style: italic;
        }
        
        .journal-textarea {
            width: 100%;
            min-height: 120px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            color: #ffffff;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            margin-bottom: 15px;
        }
        
        .journal-textarea:focus {
            outline: none;
            border-color: #f4d03f;
            box-shadow: 0 0 0 2px rgba(244, 208, 63, 0.2);
        }
        
        .journal-textarea::placeholder {
            color: #7f8c8d;
        }
        
        .journal-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .journal-char-count {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .journal-submit-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            border: none;
            font-weight: bold;
        }
        
        .journal-submit-btn:hover {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .journal-entries {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .journal-entry {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #f4d03f;
        }
        
        .journal-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .journal-entry-date {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .journal-entry-prompt {
            font-size: 12px;
            color: #f4d03f;
            font-weight: bold;
        }
        
        .journal-entry-text {
            font-size: 14px;
            color: #ecf0f1;
            line-height: 1.6;
        }
        
        .journal-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }
        
        .journal-empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .journal-empty-text {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .journal-empty-subtext {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .journal-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .journal-filters select {
            flex: 1;
        }
        
        .journal-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .journal-stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .journal-stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #f4d03f;
            margin-bottom: 5px;
        }
        
        .journal-stat-label {
            font-size: 12px;
            color: #bdc3c7;
        }
        
        .time-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .time-indicator .status {
            font-weight: bold;
            color: #95a5a6;
        }
        
        .time-indicator.completed .status {
            color: #27ae60;
        }
        
        .time-indicator.current .status {
            color: #f39c12;
        }
        
        /* Lore Tab Styles */
        .lore-section {
            background: rgba(52, 73, 94, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(52, 73, 94, 0.2);
        }
        
        .lore-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .lore-header h3 {
            color: #ecf0f1;
            margin: 0;
            font-size: 18px;
        }
        
        .lore-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #bdc3c7;
        }
        
        .lore-streak {
            background: rgba(231, 76, 60, 0.2);
            padding: 4px 12px;
            border-radius: 15px;
            color: #e74c3c;
            font-weight: bold;
            font-size: 12px;
        }
        
        .lore-content-container {
            background: rgba(44, 62, 80, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        /* Quiz Styles */
        .lore-quiz {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .quiz-header h4 {
            color: #3498db;
            margin: 0 0 8px 0;
            font-size: 16px;
        }
        
        .quiz-subtitle {
            color: #bdc3c7;
            font-size: 12px;
            margin: 0 0 15px 0;
        }
        
        .quiz-question {
            color: #ecf0f1;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .quiz-options {
            display: grid;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .quiz-option {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 15px;
            color: #ecf0f1;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            text-align: left;
        }
        
        .quiz-option:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #3498db;
        }
        
        .quiz-option.selected {
            background: rgba(52, 152, 219, 0.3);
            border-color: #3498db;
            color: #3498db;
        }
        
        .quiz-option.correct {
            background: rgba(46, 204, 113, 0.3);
            border-color: #2ecc71;
            color: #2ecc71;
        }
        
        .quiz-option.incorrect {
            background: rgba(231, 76, 60, 0.3);
            border-color: #e74c3c;
            color: #e74c3c;
        }
        
        .quiz-result {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .quiz-result.correct {
            background: rgba(46, 204, 113, 0.2);
            color: #27ae60;
            border: 1px solid #2ecc71;
        }
        
        .quiz-result.incorrect {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .lore-passage {
            color: #ecf0f1;
            line-height: 1.6;
            font-size: 14px;
            margin-bottom: 20px;
            min-height: 120px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .lore-passage h4 {
            color: #3498db !important;
            margin-bottom: 15px !important;
            font-size: 16px !important;
        }
        
        .lore-passage div {
            margin-bottom: 15px;
        }
        
        .loading-lore {
            text-align: center;
            color: #95a5a6;
            font-style: italic;
            padding: 40px 0;
        }
        
        .lore-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .lore-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
            justify-content: center;
        }
        
        .lore-btn.primary {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }
        
        .lore-btn.primary:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
            transform: translateY(-2px);
        }
        
        .lore-btn.primary:disabled {
            background: rgba(149, 165, 166, 0.3);
            color: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .lore-btn.secondary {
            background: rgba(52, 73, 94, 0.4);
            color: #ecf0f1;
            border: 1px solid rgba(52, 73, 94, 0.6);
        }
        
        .lore-btn.secondary:hover {
            background: rgba(52, 73, 94, 0.6);
            transform: translateY(-2px);
        }
        
        .lore-stats-section, .lore-unlocks-section {
            background: rgba(52, 73, 94, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(52, 73, 94, 0.2);
        }
        
        .lore-stats-section h3, .lore-unlocks-section h3 {
            color: #ecf0f1;
            margin: 0 0 15px 0;
            font-size: 16px;
        }
        
        .lore-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        @media (max-width: 480px) {
            .lore-stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        .lore-stat-card {
            background: rgba(44, 62, 80, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(44, 62, 80, 0.4);
        }
        
        .lore-stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }
        
        .lore-stat-label {
            font-size: 11px;
            color: #bdc3c7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .lore-unlocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .lore-unlock-card {
            background: rgba(44, 62, 80, 0.3);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(44, 62, 80, 0.4);
            border-left: 4px solid #f39c12;
        }
        
        .lore-unlock-title {
            color: #f39c12;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .lore-unlock-content {
            color: #ecf0f1;
            font-size: 12px;
            line-height: 1.4;
        }
        
        @media (max-width: 480px) {
            .lore-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .lore-progress {
                width: 100%;
                justify-content: space-between;
            }
            
            .lore-actions {
                flex-direction: column;
            }
            
            .lore-btn {
                min-width: 100%;
            }
            
            .lore-stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .lore-unlocks-grid {
                grid-template-columns: 1fr;
            }
            
            .quiz-options {
                gap: 8px;
            }
            
            .quiz-option {
                padding: 10px 12px;
                font-size: 12px;
            }
        }

        /* Ability Detail Toggle Styles */
        .ability-details-toggle {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid #3498db;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            margin-top: 5px;
            transition: all 0.2s ease;
        }
        
        .ability-details-toggle:hover {
            background: rgba(52, 152, 219, 0.3);
        }
        
        .ability-mechanical-details {
            display: none;
            margin-top: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            border-left: 3px solid #f39c12;
        }
        
        .ability-mechanical-details.show {
            display: block;
        }
        
        .mechanical-benefit {
            font-size: 11px;
            color: #f39c12;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .mechanical-detail {
            font-size: 10px;
            color: #bdc3c7;
            line-height: 1.3;
        }

        /* Global Settings Toggle */
        .details-preference-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }
        
        .details-preference-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .details-preference-toggle label {
            font-size: 12px;
            color: #ecf0f1;
            cursor: pointer;
            margin: 0;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 80px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(127, 140, 141, 0.4);
            transition: all 0.3s ease;
            border-radius: 26px;
            border: 2px solid rgba(127, 140, 141, 0.6);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 1px;
            top: 1px;
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            transition: all 0.3s ease;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-color: #3498db;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2), 0 0 8px rgba(52, 152, 219, 0.3);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
            background: linear-gradient(135deg, #ffffff, #ecf0f1);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .toggle-slider:hover {
            border-color: rgba(52, 152, 219, 0.8);
        }
        
        input:checked + .toggle-slider:hover {
            background: linear-gradient(135deg, #2980b9, #3498db);
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="title">🏔️ The Unbroken Ascent</div>
            <div class="subtitle">Real Habit Building RPG - Working Version!</div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('dashboard')">📊 Home</button>
                <button class="tab-btn" onclick="switchTab('skills')">⚔️ Skills</button>
                <button class="tab-btn" onclick="switchTab('activity')">➕ Train</button>
                <button class="tab-btn" onclick="switchTab('journal')">📖 Journal</button>
                <button class="tab-btn" onclick="switchTab('lore')">� Lore</button>
                <button class="tab-btn" onclick="switchTab('settings')">⚙️ Settings</button>
            </div>
            
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="dashboard-grid">
                    <!-- Quick Stats -->
                    <div class="dashboard-card">
                        <h3>� Today's Progress</h3>
                        <div class="quick-stats">
                            <div class="quick-stat">
                                <div class="quick-stat-value" id="dash-activities">0</div>
                                <div class="quick-stat-label">Activities</div>
                            </div>
                            <div class="quick-stat">
                                <div class="quick-stat-value" id="dash-xp">0</div>
                                <div class="quick-stat-label">XP Gained</div>
                            </div>
                            <div class="quick-stat">
                                <div class="quick-stat-value" id="dash-streak">0</div>
                                <div class="quick-stat-label">Day Streak</div>
                            </div>
                            <div class="quick-stat">
                                <div class="quick-stat-value" id="dash-goal">0%</div>
                                <div class="quick-stat-label">Daily Goal</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Notifications -->
                    <div class="dashboard-card">
                        <h3>🔔 Recent Activity</h3>
                        <div id="notification-feed">
                            <div class="notification-item">
                                Welcome to The Unbroken Ascent! Start your journey by logging your first activity.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="dashboard-card">
                        <h3>⚡ Quick Actions</h3>
                        <button class="btn" onclick="switchTab('activity')" style="margin-bottom: 10px;">
                            🔥 Log New Activity
                        </button>
                        <button class="btn" onclick="switchTab('skills')" style="background: linear-gradient(90deg, #9b59b6, #8e44ad); margin-bottom: 10px;">
                            ⚔️ View Skill Trees
                        </button>
                        <button class="btn" onclick="switchTab('settings')" style="background: linear-gradient(90deg, #3498db, #2980b9);">
                            ⚙️ Settings & Sync
                        </button>
                    </div>
                    
                    <!-- Current Level Overview -->
                    <div class="dashboard-card">
                        <h3>🎯 Level Overview</h3>
                        <div id="dash-level-overview">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Skills Tab -->
            <div id="skills-tab" class="tab-content">
                <div class="form-title">⚔️ Your Skills</div>
                <div id="skills-container"></div>
                <div id="boss-status" class="boss-status">
                    Keep training to unlock boss battles!
                </div>
            </div>
            
            <!-- Activity Logging Tab -->
            <div id="activity-tab" class="tab-content">
                <div class="activity-form">
                    <div class="form-title">⚔️ Log Activity</div>
                    <div class="form-group">
                        <label>Skill</label>
                        <select id="skill-select">
                            <option value="power">💪 Power (Fitness)</option>
                            <option value="clarity">🧠 Clarity (Mental)</option>
                            <option value="balance">🧘 Balance (Mindfulness)</option>
                            <option value="spirit">🤝 Spirit (Social)</option>
                            <option value="harmony">🎨 Harmony (Creative)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Activity</label>
                        <input type="text" id="activity-input" placeholder="e.g., workout, meditation, reading">
                    </div>
                    <div class="form-group">
                        <div class="activity-type-label">
                            <label>Activity Type</label>
                            <span class="activity-type-badge">UNLOCK BONUSES</span>
                        </div>
                        <select id="activity-type-select">
                            <!-- Options will be populated dynamically based on unlocked abilities -->
                        </select>
                        <div id="activity-type-hint">
                            💡 Choose the type that matches your activity to unlock XP bonuses and special abilities!
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Duration (minutes)</label>
                        <input type="number" id="duration-input" min="3" max="240" value="20">
                        <div style="font-size: 10px; color: #85929e; margin-top: 4px;">
                            <span id="duration-hint">Duration limits adjust based on activity type</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Effort Level 
                            <span style="font-size: 10px; color: #85929e; cursor: help;" title="Click for effort guide">ℹ️</span>
                        </label>
                        <select id="intensity-input">
                            <option value="1">😌 Easy (Light effort, relaxed pace)</option>
                            <option value="2" selected>⚡ Moderate (Steady effort, focused work)</option>
                            <option value="3">🔥 Hard (High effort, challenging push)</option>
                            <option value="4">💪 Extreme (Maximum effort, peak performance)</option>
                        </select>
                        <div id="intensity-guide" style="font-size: 10px; color: #85929e; margin-top: 4px; display: none;">
                            <strong>Effort Level Guide:</strong><br>
                            <span id="effort-examples">Examples will appear here based on activity type</span>
                        </div>
                    </div>
                    <button class="btn" onclick="logActivity()">🔥 Log Activity & Gain XP</button>
                    <button class="btn" onclick="showCurrentLimits()" style="margin-top: 10px; background: linear-gradient(90deg, #f39c12, #e67e22);">
                        📊 Check My Current Limits
                    </button>
                    <button class="btn" onclick="testLimitEnforcement()" style="margin-top: 10px; background: linear-gradient(90deg, #8e44ad, #9b59b6);">
                        🧪 Test Error Popup System
                    </button>
                </div>
            </div>
            
            <!-- Settings Tab (Combined Integrations + Sync + Profile) -->
            <div id="settings-tab" class="tab-content">
                <div class="form-title">⚙️ Settings & Profile</div>
                
                <!-- Profile Stats Section -->
                <div class="settings-section">
                    <h3>📊 Your Profile</h3>
                    <div class="stats" id="stats-container">
                        <div class="stat-item">
                            <span>Current Streak:</span>
                            <span class="streak" id="streak-display">0 days</span>
                        </div>
                        <div class="stat-item">
                            <span>Total XP Earned:</span>
                            <span id="total-xp">0</span>
                        </div>
                        <div class="stat-item">
                            <span>Activities Today:</span>
                            <span id="today-activities">0</span>
                        </div>
                        <div class="stat-item" id="goal-status">
                            <!-- Daily goal progress will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Daily Limits Tracker -->
                    <div class="stats" style="margin-top: 15px;">
                        <div style="font-size: 12px; font-weight: bold; color: #f4d03f; margin-bottom: 8px;">🔒 Daily Limits & Anti-Exploit</div>
                        <div id="daily-limits-tracker" style="font-size: 11px; line-height: 1.4;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- UI Display Settings Section -->
                <div class="settings-section">
                    <h3>🔧 Display Settings</h3>
                    <div style="font-size: 12px; color: #bdc3c7; margin-bottom: 15px; text-align: center;">
                        Customize how ability information is displayed
                    </div>
                    
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(44, 62, 80, 0.3); border-radius: 8px; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: bold; font-size: 13px; color: #ecf0f1;">Show Mechanical Details</div>
                            <div style="font-size: 11px; color: #bdc3c7; line-height: 1.3; margin-top: 2px;">
                                Display XP bonuses, percentages, and other stat details for abilities
                            </div>
                        </div>
                        <label class="toggle-switch" style="margin-left: 15px;">
                            <input type="checkbox" id="show-details-toggle" onchange="toggleShowDetails(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- App Integrations Section -->
                <div class="settings-section">
                    <h3>🔗 App Integrations</h3>
                    <div style="font-size: 12px; color: #bdc3c7; margin-bottom: 15px; text-align: center;">
                        Connect your favorite apps for automatic activity logging
                    </div>
                    
                    <!-- Power (Fitness) Integrations -->
                    <div class="integration-group">
                        <div class="integration-header">💪 Power (Fitness)</div>
                        <div class="integration-item">
                            <button class="integration-btn" id="strava-btn" onclick="toggleIntegration('strava')">
                                <span class="integration-icon">🚴</span>
                                <span class="integration-name">Strava</span>
                                <span class="integration-status" id="strava-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="garmin-btn" onclick="toggleIntegration('garmin')">
                                <span class="integration-icon">📍</span>
                                <span class="integration-name">Garmin Connect</span>
                                <span class="integration-status" id="garmin-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="fitbit-btn" onclick="toggleIntegration('fitbit')">
                                <span class="integration-icon">⌚</span>
                                <span class="integration-name">Fitbit</span>
                                <span class="integration-status" id="fitbit-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="apple-health-btn" onclick="toggleIntegration('apple-health')">
                                <span class="integration-icon">🍎</span>
                                <span class="integration-name">Apple Health</span>
                                <span class="integration-status" id="apple-health-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="myfitnesspal-btn" onclick="toggleIntegration('myfitnesspal')">
                                <span class="integration-icon">🍽️</span>
                                <span class="integration-name">MyFitnessPal</span>
                                <span class="integration-status" id="myfitnesspal-status">Connect</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Clarity (Mental) Integrations -->
                    <div class="integration-group">
                        <div class="integration-header">🧠 Clarity (Mental)</div>
                        <div class="integration-item">
                            <button class="integration-btn" id="toggl-btn" onclick="toggleIntegration('toggl')">
                                <span class="integration-icon">⏰</span>
                                <span class="integration-name">Toggl Track</span>
                                <span class="integration-status" id="toggl-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="notion-btn" onclick="toggleIntegration('notion')">
                                <span class="integration-icon">📝</span>
                                <span class="integration-name">Notion</span>
                                <span class="integration-status" id="notion-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="rescue-time-btn" onclick="toggleIntegration('rescue-time')">
                                <span class="integration-icon">⏱️</span>
                                <span class="integration-name">RescueTime</span>
                                <span class="integration-status" id="rescue-time-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="forest-btn" onclick="toggleIntegration('forest')">
                                <span class="integration-icon">🌲</span>
                                <span class="integration-name">Forest App</span>
                                <span class="integration-status" id="forest-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="goodreads-btn" onclick="toggleIntegration('goodreads')">
                                <span class="integration-icon">📚</span>
                                <span class="integration-name">Goodreads</span>
                                <span class="integration-status" id="goodreads-status">Connect</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Balance (Mindfulness) Integrations -->
                    <div class="integration-group">
                        <div class="integration-header">🧘 Balance (Mindfulness)</div>
                        <div class="integration-item">
                            <button class="integration-btn" id="headspace-btn" onclick="toggleIntegration('headspace')">
                                <span class="integration-icon">🎧</span>
                                <span class="integration-name">Headspace</span>
                                <span class="integration-status" id="headspace-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="calm-btn" onclick="toggleIntegration('calm')">
                                <span class="integration-icon">🌙</span>
                                <span class="integration-name">Calm</span>
                                <span class="integration-status" id="calm-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="insight-timer-btn" onclick="toggleIntegration('insight-timer')">
                                <span class="integration-icon">⏳</span>
                                <span class="integration-name">Insight Timer</span>
                                <span class="integration-status" id="insight-timer-status">Connect</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Spirit (Social) Integrations -->
                    <div class="integration-group">
                        <div class="integration-header">🤝 Spirit (Social)</div>
                        <div class="integration-item">
                            <button class="integration-btn" id="discord-btn" onclick="toggleIntegration('discord')">
                                <span class="integration-icon">💬</span>
                                <span class="integration-name">Discord</span>
                                <span class="integration-status" id="discord-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="meetup-btn" onclick="toggleIntegration('meetup')">
                                <span class="integration-icon">👥</span>
                                <span class="integration-name">Meetup</span>
                                <span class="integration-status" id="meetup-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="linkedin-btn" onclick="toggleIntegration('linkedin')">
                                <span class="integration-icon">💼</span>
                                <span class="integration-name">LinkedIn</span>
                                <span class="integration-status" id="linkedin-status">Connect</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Harmony (Creative) Integrations -->
                    <div class="integration-group">
                        <div class="integration-header">🎨 Harmony (Creative)</div>
                        <div class="integration-item">
                            <button class="integration-btn" id="spotify-btn" onclick="toggleIntegration('spotify')">
                                <span class="integration-icon">🎵</span>
                                <span class="integration-name">Spotify</span>
                                <span class="integration-status" id="spotify-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="github-btn" onclick="toggleIntegration('github')">
                                <span class="integration-icon">💻</span>
                                <span class="integration-name">GitHub</span>
                                <span class="integration-status" id="github-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="dribbble-btn" onclick="toggleIntegration('dribbble')">
                                <span class="integration-icon">🏀</span>
                                <span class="integration-name">Dribbble</span>
                                <span class="integration-status" id="dribbble-status">Connect</span>
                            </button>
                        </div>
                        <div class="integration-item">
                            <button class="integration-btn" id="behance-btn" onclick="toggleIntegration('behance')">
                                <span class="integration-icon">🎭</span>
                                <span class="integration-name">Behance</span>
                                <span class="integration-status" id="behance-status">Connect</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- PC Game Sync Section -->
                <div class="settings-section">
                    <h3>🎮 PC Game Sync</h3>
                    <div style="font-size: 12px; color: #bdc3c7; margin-bottom: 15px; text-align: center;">
                        Synchronize with The Unbroken Ascent PC game
                    </div>
                    
                    <!-- Connection Status -->
                    <div class="sync-section">
                        <div class="sync-status-card">
                            <div class="sync-status-indicator" id="sync-status-dot"></div>
                            <div class="sync-status-text">
                                <div class="sync-status-main" id="sync-status-main">Not Connected</div>
                                <div class="sync-status-sub" id="sync-status-sub">Connect to sync your progress</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sync Actions -->
                    <div class="sync-actions">
                        <button class="btn" onclick="connectToPC()" style="background: linear-gradient(90deg, #3498db, #2980b9);">
                            🔗 Connect to PC
                        </button>
                        <button class="btn" onclick="exportSaveData()" style="background: linear-gradient(90deg, #f39c12, #e67e22);">
                            📤 Export Data
                        </button>
                    </div>
                </div>
                
                <!-- Data Management Section -->
                <div class="settings-section">
                    <h3>💾 Data Management</h3>
                    <div class="data-actions">
                        <button class="btn" onclick="resetProgress()" style="background: linear-gradient(90deg, #e74c3c, #c0392b);">
                            🔄 Reset Progress
                        </button>
                        <button class="btn" onclick="resetProfile()" style="background: linear-gradient(90deg, #8e44ad, #9b59b6);">
                            🔥 Reset All Data
                        </button>
                    </div>
                    
                    <div class="debug-info">
                        ✅ <strong>1.2M XP SYSTEM:</strong> Massive satisfying numbers for 100-level journey!<br>
                        📊 Level 1→2 needs 3,000 XP = ~1-2 activities, Level 100 = 1.2M total!<br>
                        🎯 Power = 3K+ XP, Clarity = 1.7K+ XP per activity - BIG GAINS!<br>
                        ⚡ <strong>NEW:</strong> Activity types unlock ability bonuses! Deep Work = 2x XP!<br>
                        <div id="activity-usage-tracker" style="margin-top: 10px; font-size: 12px; opacity: 0.8;"></div>
                    </div>
                </div>

                <!-- Developer Testing Section -->
                <div class="settings-section" style="border: 2px dashed #f39c12; background: rgba(243, 156, 18, 0.1);">
                    <h3>🚀 Developer Testing</h3>
                    <p style="color: #f39c12; font-size: 13px; margin-bottom: 15px;">
                        <strong>⚠️ Testing Tools:</strong> Use these to quickly test all features with maxed stats
                    </p>
                    <div class="data-actions">
                        <button class="btn" onclick="window.game.devMaxStats()" style="background: linear-gradient(90deg, #f39c12, #e67e22);">
                            🚀 Max All Stats (Testing)
                        </button>
                        <button class="btn" onclick="showDevMenu()" style="background: linear-gradient(90deg, #9b59b6, #8e44ad); margin-left: 10px;">
                            🔧 Advanced Dev Menu
                        </button>
                    </div>
                    <div class="debug-info" style="margin-top: 10px;">
                        Sets all skills to Level 100, maxes streaks, XP, and unlocks all content including advanced activity types.
                    </div>
                </div>

                <!-- Tutorial Section -->
                <div class="settings-section">
                    <h3>📚 Tutorial & Help</h3>
                    <p style="color: #bdc3c7; font-size: 13px; margin-bottom: 15px;">
                        Need a refresher? Replay the interactive tutorial anytime.
                    </p>
                    <button onclick="startTutorial()" class="tutorial-restart-btn">
                        🎯 Replay Tutorial
                    </button>
                </div>
            </div>

            <!-- Hidden Developer Menu Modal -->
            <div id="devMenuModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <span class="close" onclick="hideDevMenu()">&times;</span>
                    <h2 style="color: #f39c12; margin-bottom: 20px;">🔧 Developer Cheat Menu</h2>
                    
                    <div id="devPasswordSection">
                        <div style="margin-bottom: 20px;">
                            <label style="color: #bdc3c7; margin-bottom: 10px; display: block;">Enter Developer Password:</label>
                            <input type="password" id="devPassword" placeholder="Password..." style="width: 100%; padding: 10px; margin-bottom: 10px;">
                            <button onclick="checkDevPassword()" style="width: 100%; padding: 10px; background: linear-gradient(90deg, #3498db, #2980b9); color: white; border: none; border-radius: 6px;">
                                🔓 Unlock Dev Menu
                            </button>
                            <div style="font-size: 11px; color: #7f8c8d; margin-top: 8px; text-align: center;">
                                Hint: What ascent are we on? (lowercase)
                            </div>
                        </div>
                    </div>

                    <div id="devMenuContent" style="display: none;">
                        <!-- Quick Stats Section -->
                        <div class="dev-section">
                            <h3 style="color: #3498db; border-bottom: 1px solid #3498db; padding-bottom: 8px;">⚡ Quick Stats</h3>
                            <div class="dev-buttons">
                                <button onclick="devSetSkillLevels(10)" class="dev-btn">Set All Skills to Level 10</button>
                                <button onclick="devSetSkillLevels(25)" class="dev-btn">Set All Skills to Level 25</button>
                                <button onclick="devSetSkillLevels(50)" class="dev-btn">Set All Skills to Level 50</button>
                                <button onclick="devSetSkillLevels(100)" class="dev-btn">Max All Skills (100)</button>
                            </div>
                        </div>

                        <!-- Individual Skills Section -->
                        <div class="dev-section">
                            <h3 style="color: #e74c3c; border-bottom: 1px solid #e74c3c; padding-bottom: 8px;">🎯 Individual Skills</h3>
                            <div class="dev-skill-controls">
                                <div class="skill-control">
                                    <span>💪 Power:</span>
                                    <input type="number" id="powerLevel" min="1" max="100" value="1" style="width: 60px;">
                                    <button onclick="devSetIndividualSkill('power')" class="dev-btn-small">Set</button>
                                </div>
                                <div class="skill-control">
                                    <span>🧠 Clarity:</span>
                                    <input type="number" id="clarityLevel" min="1" max="100" value="1" style="width: 60px;">
                                    <button onclick="devSetIndividualSkill('clarity')" class="dev-btn-small">Set</button>
                                </div>
                                <div class="skill-control">
                                    <span>🧘 Balance:</span>
                                    <input type="number" id="balanceLevel" min="1" max="100" value="1" style="width: 60px;">
                                    <button onclick="devSetIndividualSkill('balance')" class="dev-btn-small">Set</button>
                                </div>
                                <div class="skill-control">
                                    <span>🤝 Spirit:</span>
                                    <input type="number" id="spiritLevel" min="1" max="100" value="1" style="width: 60px;">
                                    <button onclick="devSetIndividualSkill('spirit')" class="dev-btn-small">Set</button>
                                </div>
                                <div class="skill-control">
                                    <span>🎨 Harmony:</span>
                                    <input type="number" id="harmonyLevel" min="1" max="100" value="1" style="width: 60px;">
                                    <button onclick="devSetIndividualSkill('harmony')" class="dev-btn-small">Set</button>
                                </div>
                            </div>
                        </div>

                        <!-- XP & Streaks Section -->
                        <div class="dev-section">
                            <h3 style="color: #f39c12; border-bottom: 1px solid #f39c12; padding-bottom: 8px;">📈 XP & Streaks</h3>
                            <div class="dev-buttons">
                                <button onclick="devAddXP(1000)" class="dev-btn">Add 1,000 XP</button>
                                <button onclick="devAddXP(10000)" class="dev-btn">Add 10,000 XP</button>
                                <button onclick="devAddXP(50000)" class="dev-btn">Add 50,000 XP</button>
                                <button onclick="devSetStreak(7)" class="dev-btn">7-Day Streak</button>
                                <button onclick="devSetStreak(30)" class="dev-btn">30-Day Streak</button>
                                <button onclick="devSetStreak(100)" class="dev-btn">100-Day Streak</button>
                            </div>
                        </div>

                        <!-- Content Unlocks Section -->
                        <div class="dev-section">
                            <h3 style="color: #9b59b6; border-bottom: 1px solid #9b59b6; padding-bottom: 8px;">🔓 Content Unlocks</h3>
                            <div class="dev-buttons">
                                <button onclick="devUnlockAllActivities()" class="dev-btn">Unlock All Activity Types</button>
                                <button onclick="devCompleteLore()" class="dev-btn">Complete All Lore</button>
                                <button onclick="devMaxJournal()" class="dev-btn">Max Journal Stats</button>
                                <button onclick="devUnlockAllIntegrations()" class="dev-btn">Enable All Integrations</button>
                            </div>
                        </div>

                        <!-- Reset Options Section -->
                        <div class="dev-section">
                            <h3 style="color: #e67e22; border-bottom: 1px solid #e67e22; padding-bottom: 8px;">🔄 Reset Options</h3>
                            <div class="dev-buttons">
                                <button onclick="devResetToday()" class="dev-btn">Reset Today's Activities</button>
                                <button onclick="devResetSkills()" class="dev-btn">Reset All Skills to Level 1</button>
                                <button onclick="devResetEverything()" class="dev-btn dangerous">⚠️ Reset Everything</button>
                            </div>
                        </div>

                        <!-- Quick Test Scenarios -->
                        <div class="dev-section">
                            <h3 style="color: #27ae60; border-bottom: 1px solid #27ae60; padding-bottom: 8px;">🧪 Test Scenarios</h3>
                            <div class="dev-buttons">
                                <button onclick="devNewPlayerTest()" class="dev-btn">New Player Experience</button>
                                <button onclick="devMidGameTest()" class="dev-btn">Mid-Game Player</button>
                                <button onclick="devEndGameTest()" class="dev-btn">End-Game Player</button>
                                <button onclick="devRandomProgress()" class="dev-btn">Random Progression</button>
                            </div>
                        </div>

                        <div style="margin-top: 20px; padding: 10px; background: rgba(231, 76, 60, 0.1); border-left: 3px solid #e74c3c; font-size: 12px; color: #e74c3c;">
                            <strong>⚠️ Developer Mode Active:</strong> These changes are for testing only. Use responsibly!
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Integrations Tab (Legacy - now redirects to settings) -->
            <div id="integrations-tab" class="tab-content">
                <div class="form-title">🔄 Moved to Settings</div>
                <div style="text-align: center; padding: 40px;">
                    <p style="color: #bdc3c7; margin-bottom: 20px;">App Integrations have moved to the Settings tab for better organization.</p>
                    <button class="btn" onclick="switchTab('settings')" style="background: linear-gradient(90deg, #3498db, #2980b9);">
                        ⚙️ Go to Settings
                    </button>
                </div>
            </div>
            
            <!-- Journal Tab -->
            <div id="journal-tab" class="tab-content">
                <div class="form-title">📖 Daily Reflection Journal</div>
                <div style="font-size: 12px; color: #bdc3c7; margin-bottom: 20px; text-align: center;">
                    Gain clarity through guided reflection. Up to 3 entries per day (morning, midday, evening). Each entry gives Clarity XP!
                </div>
                
                <!-- Journal Notifications -->
                <div id="journal-notifications" class="journal-notifications" style="display: none; margin-bottom: 15px; padding: 12px; border-radius: 8px; background: rgba(46, 204, 113, 0.1); border: 1px solid rgba(46, 204, 113, 0.3);">
                    <div id="journal-notification-text" style="color: #27ae60; font-weight: bold; text-align: center;">
                        ✅ Notification will appear here
                    </div>
                </div>
                
                <!-- Daily Progress Tracker -->
                <div id="daily-progress" style="background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.3); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #3498db;">📅 Today's Journal Progress</div>
                    <div id="progress-indicators" style="display: flex; gap: 10px;">
                        <div class="time-indicator" data-type="morning">
                            <span>🌅</span> <span class="status">○</span>
                        </div>
                        <div class="time-indicator" data-type="midday">
                            <span>☀️</span> <span class="status">○</span>
                        </div>
                        <div class="time-indicator" data-type="evening">
                            <span>🌙</span> <span class="status">○</span>
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #bdc3c7; margin-top: 5px;">
                        ○ = Not completed | ✓ = Completed | 🔥 = Current time period
                    </div>
                </div>
                
                <!-- Current Prompt -->
                <div class="journal-section">
                    <div class="journal-prompt-card">
                        <div class="journal-prompt-header">
                            <div class="journal-prompt-time" id="current-prompt-time">🌅 Morning</div>
                            <div class="journal-prompt-title" id="current-prompt-title">Morning Intention Setting</div>
                        </div>
                        <div class="journal-prompt-text" id="current-prompt-text">
                            What are the 3 most important things you want to accomplish today, and why do they matter to you?
                        </div>
                        <textarea 
                            id="journal-input" 
                            class="journal-textarea" 
                            placeholder="Take a moment to reflect and write your thoughts... (minimum 20 characters, 5 words)"
                            maxlength="300"
                            oninput="updateCharCount()"
                        ></textarea>
                        <div class="journal-controls">
                            <div class="journal-char-count">
                                <span id="journal-char-count">0</span>/300 characters (minimum 20)
                            </div>
                            <button class="btn journal-submit-btn" onclick="window.submitJournalEntry();">
                                💫 Submit Reflection (+50 Clarity XP)
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Today's Entries -->
                <div class="journal-section">
                    <h3>📝 Today's Entries</h3>
                    <div id="today-entries" class="journal-entries">
                        <div class="journal-empty-state">
                            <div class="journal-empty-icon">✨</div>
                            <div class="journal-empty-text">No entries yet today</div>
                            <div class="journal-empty-subtext">Complete your first reflection to start building clarity!</div>
                        </div>
                    </div>
                </div>
                
                <!-- Past Entries -->
                <div class="journal-section">
                    <h3>📚 Past Reflections</h3>
                    <div class="journal-filters">
                        <select id="journal-date-filter" onchange="filterJournalEntries()">
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 3 months</option>
                            <option value="all">All entries</option>
                        </select>
                        <select id="journal-prompt-filter" onchange="filterJournalEntries()">
                            <option value="all">All time periods</option>
                            <option value="morning">🌅 Morning</option>
                            <option value="midday">☀️ Midday</option>
                            <option value="evening">🌙 Evening</option>
                        </select>
                    </div>
                    <div id="past-entries" class="journal-entries">
                        <div class="journal-empty-state">
                            <div class="journal-empty-icon">📖</div>
                            <div class="journal-empty-text">No past entries yet</div>
                            <div class="journal-empty-subtext">Start journaling to build a record of your growth!</div>
                        </div>
                    </div>
                </div>
                
                <!-- Journal Stats -->
                <div class="journal-section">
                    <h3>📊 Reflection Stats</h3>
                    <div class="journal-stats-grid">
                        <div class="journal-stat-card">
                            <div class="journal-stat-number" id="journal-streak">0</div>
                            <div class="journal-stat-label">Day Streak</div>
                        </div>
                        <div class="journal-stat-card">
                            <div class="journal-stat-number" id="journal-total">0</div>
                            <div class="journal-stat-label">Total Entries</div>
                        </div>
                        <div class="journal-stat-card">
                            <div class="journal-stat-number" id="journal-xp">0</div>
                            <div class="journal-stat-label">Clarity XP</div>
                        </div>
                        <div class="journal-stat-card">
                            <div class="journal-stat-number" id="journal-words">0</div>
                            <div class="journal-stat-label">Words Written</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lore Tab -->
            <div id="lore-tab" class="tab-content">
                <div class="form-title">📜 Chronicles of Vitalon</div>
                <div style="font-size: 12px; color: #bdc3c7; margin-bottom: 20px; text-align: center;">
                    Daily wisdom and lore from the realm of Vitalon
                </div>
                
                <!-- Daily Lore Reading Section -->
                <div class="lore-section">
                    <div class="lore-header">
                        <h3 id="lore-title">Today's Chronicle</h3>
                        <div class="lore-progress">
                            <span id="lore-day-counter">Day 1</span>
                            <div class="lore-streak">
                                🔥 <span id="lore-streak-count">0</span> day streak
                            </div>
                        </div>
                    </div>
                    
                    <div class="lore-content-container">
                        <div class="lore-passage" id="lore-passage">
                            <div class="loading-lore">Loading today's chronicle...</div>
                        </div>
                        
                        <!-- Quiz Section -->
                        <div class="lore-quiz" id="lore-quiz" style="display: none;">
                            <div class="quiz-header">
                                <h4>📝 Knowledge Check</h4>
                                <p class="quiz-subtitle">Answer correctly to gain your Clarity XP!</p>
                            </div>
                            <div class="quiz-question" id="quiz-question"></div>
                            <div class="quiz-options" id="quiz-options"></div>
                            <div class="quiz-result" id="quiz-result" style="display: none;"></div>
                        </div>
                        
                        <div class="lore-actions">
                            <button class="lore-btn primary" id="lore-read-btn" onclick="showLoreQuiz()">
                                <span class="btn-icon">📖</span>
                                <span class="btn-text">I've Read This (+100 Clarity XP)</span>
                            </button>
                            <button class="lore-btn secondary" id="lore-reread-btn" onclick="rereadLore()" style="display: none;">
                                <span class="btn-icon">🔄</span>
                                <span class="btn-text">Read Again</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Lore Stats Section -->
                <div class="lore-stats-section">
                    <h3>📊 Reading Progress</h3>
                    <div class="lore-stats-grid">
                        <div class="lore-stat-card">
                            <div class="lore-stat-number" id="lore-total-read">0</div>
                            <div class="lore-stat-label">Chronicles Read</div>
                        </div>
                        <div class="lore-stat-card">
                            <div class="lore-stat-number" id="lore-xp-earned">0</div>
                            <div class="lore-stat-label">XP Earned</div>
                        </div>
                        <div class="lore-stat-card">
                            <div class="lore-stat-number" id="lore-max-streak">0</div>
                            <div class="lore-stat-label">Best Streak</div>
                        </div>
                        <div class="lore-stat-card">
                            <div class="lore-stat-number" id="lore-cycle-progress">0/30</div>
                            <div class="lore-stat-label">Cycle Progress</div>
                        </div>
                    </div>
                </div>
                
                <!-- Unlocked Content Section -->
                <div class="lore-unlocks-section" id="lore-unlocks" style="display: none;">
                    <h3>🔓 Unlocked Wisdom</h3>
                    <div class="lore-unlocks-grid" id="lore-unlocks-grid">
                        <!-- Unlocked content will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- PC Sync Tab -->
            <!-- Sync Tab (Legacy - now part of Settings) -->
            <div id="sync-tab" class="tab-content">
                <div class="form-title">🔄 Moved to Settings</div>
                <div style="text-align: center; padding: 40px;">
                    <p style="color: #bdc3c7; margin-bottom: 20px;">PC Sync has moved to the Settings tab for better organization.</p>
                    <button class="btn" onclick="switchTab('settings')" style="background: linear-gradient(90deg, #3498db, #2980b9);">
                        ⚙️ Go to Settings
                    </button>
                </div>
            </div>

        <div id="message-container"></div>
    </div>

    <!-- Skill Tree Modal -->
    <div id="skillTreeModal" class="skill-tree-modal">
        <div class="skill-tree-content">
            <div class="skill-tree-header">
                <div id="skillTreeTitle" class="skill-tree-title">Skill Tree</div>
                <button class="close-modal" onclick="game.closeSkillTree()">&times;</button>
            </div>
            <div id="skillTreeAbilities" class="skill-tree-abilities">
                <!-- Abilities will be dynamically populated here -->            </div>
        </div>
    </div>

    <!-- Tutorial Modal & Overlay -->
    <div id="tutorialOverlay" class="tutorial-overlay"></div>
    <div id="tutorialHighlight" class="tutorial-highlight"></div>
    <div id="tutorialModal" class="tutorial-modal" style="display: none; position: fixed; top:0; left:0; width:100vw; height:100vh; align-items:center; justify-content:center;">
        <div class="tutorial-content">
            <div class="tutorial-header">
                <h2 id="tutorialTitle"></h2>
                <div class="tutorial-progress">
                    Step <span id="tutorialStep">1</span> of <span id="tutorialTotal">7</span>
                </div>
            </div>
            <div class="tutorial-body">
                <div id="tutorialContent"></div>
            </div>
            <div class="tutorial-footer">
                <button id="tutorialPrev" class="tutorial-btn tutorial-prev hide" onclick="tutorialPreviousStep()">Previous</button>
                <button id="tutorialNext" class="tutorial-btn tutorial-next show" onclick="tutorialNextStep()">Next</button>
                <button id="tutorialFinish" class="tutorial-btn tutorial-finish hide" onclick="tutorialFinish()">Finish</button>
                <button class="tutorial-btn tutorial-skip show" onclick="tutorialSkip()">Skip Tutorial</button>
            </div>
        </div>
    </div>

    <script>
        // Global functions defined first
        function submitJournalEntry() {
            const textArea = document.getElementById('journal-input');
            if (!textArea) {
                showJournalNotification('❌ Error: Could not find text input area. Please refresh the page.', 'error');
                return;
            }
            
            const entryText = textArea.value.trim();
            const promptType = textArea.getAttribute('data-prompt-type') || 'morning';
            const promptTitle = textArea.getAttribute('data-prompt-title') || 'Morning Reflection';
            
            // Simple validation
            if (entryText.length < 20) {
                showJournalNotification('❌ Please write at least 20 characters for a meaningful reflection.', 'error');
                return;
            }
            
            if (window.game && typeof window.game.submitJournalEntry === 'function') {
                const success = window.game.submitJournalEntry(promptType, promptTitle, entryText);
                
                if (success) {
                    textArea.value = '';
                    updateCharCount();
                    
                    // Force refresh all journal displays immediately
                    window.game.renderJournalPrompt();
                    window.game.renderTodayEntries();
                    window.game.renderJournalStats();
                    window.game.updateDisplay(); // Also update main display for XP
                } else {
                    showJournalNotification('❌ Journal submission failed. Please check the requirements and try again.', 'error');
                }
            } else {
                showJournalNotification('❌ Error: Game system not ready. Please refresh the page and try again.', 'error');
            }
        }
        
        // Show notification in journal tab
        function showJournalNotification(message, type = 'success') {
            const notificationContainer = document.getElementById('journal-notifications');
            const notificationText = document.getElementById('journal-notification-text');
            
            if (notificationContainer && notificationText) {
                notificationText.textContent = message;
                
                // Update colors based on type
                if (type === 'error') {
                    notificationContainer.style.background = 'rgba(231, 76, 60, 0.1)';
                    notificationContainer.style.borderColor = 'rgba(231, 76, 60, 0.3)';
                    notificationText.style.color = '#e74c3c';
                } else {
                    notificationContainer.style.background = 'rgba(46, 204, 113, 0.1)';
                    notificationContainer.style.borderColor = 'rgba(46, 204, 113, 0.3)';
                    notificationText.style.color = '#27ae60';
                }
                
                // Show notification
                notificationContainer.style.display = 'block';
                
                // Hide after 5 seconds
                setTimeout(() => {
                    notificationContainer.style.display = 'none';
                }, 5000);
            }
        }
        
        function updateCharCount() {
            const textArea = document.getElementById('journal-input');
            const countElement = document.getElementById('journal-char-count');
            
            if (textArea && countElement) {
                const count = textArea.value.length;
                const words = textArea.value.trim().split(/\s+/).filter(word => word.length > 1).length;
                
                countElement.textContent = count;
                
                // Update color based on length and quality
                if (count < 20) {
                    countElement.style.color = '#e74c3c'; // Red for too short
                } else if (count < 50 || words < 5) {
                    countElement.style.color = '#f39c12'; // Orange for short or few words
                } else {
                    countElement.style.color = '#27ae60'; // Green for good length
                }
                
                // Update submit button state
                const submitBtn = document.querySelector('.journal-submit-btn');
                if (submitBtn && !submitBtn.disabled) {
                    if (count >= 20 && words >= 5) {
                        submitBtn.style.opacity = '1';
                        submitBtn.style.cursor = 'pointer';
                    } else {
                        submitBtn.style.opacity = '0.6';
                        submitBtn.style.cursor = 'not-allowed';
                    }
                }
            }
        }
        
        function filterJournalEntries() {
            if (window.game && typeof window.game.filterJournalEntries === 'function') {
                window.game.filterJournalEntries();
            }
        }
        
        function initializeJournal() {
            if (window.game && typeof window.game.renderJournalPrompt === 'function') {
                window.game.renderJournalPrompt();
                window.game.renderTodayEntries();
                window.game.renderJournalStats();
                window.game.filterJournalEntries();
                updateCharCount();
            } else {
                // Retry after a short delay if game isn't ready
                setTimeout(() => initializeJournal(), 200);
            }
        }
        
        // Attach to window immediately
        window.submitJournalEntry = submitJournalEntry;
        window.updateCharCount = updateCharCount;
        window.filterJournalEntries = filterJournalEntries;
        window.initializeJournal = initializeJournal;
        window.showJournalNotification = showJournalNotification;
        
        // Global lore functions
        function markLoreAsRead() {
            if (window.game && typeof window.game.markLoreAsRead === 'function') {
                window.game.markLoreAsRead();
            } else {
                console.error('Game system not ready for lore reading');
            }
        }
        
        function showLoreQuiz() {
            if (window.game && typeof window.game.showLoreQuiz === 'function') {
                window.game.showLoreQuiz();
            } else {
                console.error('Game system not ready for lore quiz');
            }
        }
        
        function rereadLore() {
            if (window.game && typeof window.game.rereadLore === 'function') {
                window.game.rereadLore();
            } else {
                console.error('Game system not ready for lore rereading');
            }
        }
        
        function initializeLoreTab() {
            if (window.game && typeof window.game.initializeLoreSystem === 'function') {
                window.game.initializeLoreSystem();
            } else {
                // Retry after a short delay if game isn't ready
                setTimeout(() => initializeLoreTab(), 200);
            }
        }
        
        // Attach lore functions to window
        window.markLoreAsRead = markLoreAsRead;
        window.showLoreQuiz = showLoreQuiz;
        window.rereadLore = rereadLore;
        window.initializeLoreTab = initializeLoreTab;
        
        // The Unbroken Ascent - Working Version
        class UnbrokenAscent {
            constructor() {
                this.skills = {
                    power: { name: 'Power', level: 1, xp: 0, emoji: '💪', totalXP: 0 },
                    clarity: { name: 'Clarity', level: 1, xp: 0, emoji: '🧠', totalXP: 0 },
                    balance: { name: 'Balance', level: 1, xp: 0, emoji: '🧘', totalXP: 0 },
                    spirit: { name: 'Spirit', level: 1, xp: 0, emoji: '🤝', totalXP: 0 },
                    harmony: { name: 'Harmony', level: 1, xp: 0, emoji: '🎨', totalXP: 0 }
                };
                this.streak = 0;
                this.lastActivity = null;
                this.totalXP = 0;
                this.todayActivities = 0;
                this.skillsTrained = new Set();
                this.dailyXP = 0;
                this.dailyGoalMet = false;
                this.consistencyStreak = 0;
                this.dailyGoal = 2; // Reduced to 2 activities per day (more realistic)
                
                // Journal system
                this.journalEntries = [];
                this.journalStreak = 0;
                this.journalStats = {
                    totalEntries: 0,
                    totalWords: 0,
                    totalXP: 0
                };
                
                // Lore system
                this.loreData = {
                    currentDay: 1,
                    totalRead: 0,
                    xpEarned: 0,
                    streak: 0,
                    maxStreak: 0,
                    lastReadDate: null,
                    completedCycles: 0,
                    unlockedContent: []
                };
                
                // Integration system
                this.integrations = {
                    // Power integrations
                    strava: { connected: false, lastSync: null, skill: 'power' },
                    fitbit: { connected: false, lastSync: null, skill: 'power' },
                    garmin: { connected: false, lastSync: null, skill: 'power' },
                    'apple-health': { connected: false, lastSync: null, skill: 'power' },
                    myfitnesspal: { connected: false, lastSync: null, skill: 'power' },
                    // Clarity integrations  
                    toggl: { connected: false, lastSync: null, skill: 'clarity' },
                    notion: { connected: false, lastSync: null, skill: 'clarity' },
                    'rescue-time': { connected: false, lastSync: null, skill: 'clarity' },
                    forest: { connected: false, lastSync: null, skill: 'clarity' },
                    goodreads: { connected: false, lastSync: null, skill: 'clarity' },
                    // Balance integrations
                    headspace: { connected: false, lastSync: null, skill: 'balance' },
                    calm: { connected: false, lastSync: null, skill: 'balance' },
                    'insight-timer': { connected: false, lastSync: null, skill: 'balance' },
                    // Spirit integrations
                    discord: { connected: false, lastSync: null, skill: 'spirit' },
                    meetup: { connected: false, lastSync: null, skill: 'spirit' },
                    linkedin: { connected: false, lastSync: null, skill: 'spirit' },
                    // Harmony integrations
                    github: { connected: false, lastSync: null, skill: 'harmony' },
                    spotify: { connected: false, lastSync: null, skill: 'harmony' },
                    dribbble: { connected: false, lastSync: null, skill: 'harmony' },
                    behance: { connected: false, lastSync: null, skill: 'harmony' }
                };
                
                // UI Settings
                this.settings = {
                    showMechanicalDetails: false
                };
                
                this.loadData();
                this.render();
                this.showWelcome();
                this.startAutoSync();
                
                // Initialize journal display after a brief delay
                setTimeout(() => {
                    this.renderJournalPrompt();
                    this.renderTodayEntries();
                    this.renderJournalStats();
                    this.initializeLoreSystem();
                }, 200);
            }
            
            // GAMIFIED XP Formula: 1.2 million XP total for satisfying progression!
            xpForLevel(level) {
                // Designed for 1.2M total XP across 100 levels over 18 months
                if (level <= 10) return 2000 + (level * 1000); // Levels 1-10: 3K, 4K, 5K... 12K XP
                if (level <= 25) return 12000 + (level - 10) * 2000; // Levels 11-25: 14K, 16K... 42K XP
                if (level <= 50) return 42000 + (level - 25) * 4000; // Levels 26-50: 46K, 50K... 142K XP
                if (level <= 75) return 142000 + (level - 50) * 8000; // Levels 51-75: 150K, 158K... 342K XP
                return 342000 + (level - 75) * 12000; // Levels 76-100: 354K, 366K... 642K XP
            }
            
            // BOOSTED XP values for satisfying 1.2M journey!
            getActivityBaseXP(duration, skillType) {
                let baseXP;
                if (duration <= 15) baseXP = 800 + Math.floor(duration * 40); // 800-1400 XP
                else if (duration <= 30) baseXP = 1200 + Math.floor((duration - 15) * 60); // 1200-2100 XP
                else if (duration <= 60) baseXP = 2000 + Math.floor((duration - 30) * 40); // 2000-3200 XP
                else baseXP = 2800 + Math.floor((duration - 60) * 20); // 2800-4200 XP max
                
                // Skill-specific multipliers based on realistic daily frequency
                const skillMultipliers = {
                    'power': 1.4,     // 40% bonus - harder to do daily, more intensive
                    'clarity': 0.8,   // 20% less - can be done daily, more accessible  
                    'balance': 0.9,   // 10% less - daily practice, but important for wellbeing
                    'spirit': 1.2,    // 20% bonus - requires coordination with others
                    'harmony': 1.1    // 10% bonus - requires dedicated creative time
                };
                
                return Math.floor(baseXP * (skillMultipliers[skillType] || 1.0));
            }

            // Complete skill tree data for all 5 skills
            getSkillTrees() {
                return {
                    power: {
                        name: "Power",
                        color: "#e74c3c",
                        abilities: [
                            { level: 1, name: "Daily Momentum", description: "Habit Effect: Build momentum - consecutive workout days feel more energizing and motivating. +5% XP bonus per consecutive day (max 5 days). RPG: +5% movement speed per consecutive day." },
                            { level: 3, name: "Steady Foundation", description: "Habit Effect: Longer workouts (20+ min) create lasting strength - you'll feel stronger all week. +10% XP for activities over 20 minutes. RPG: +10% base health." },
                            { level: 5, name: "High Intensity Mastery", description: "Habit Effect: Challenging workouts boost confidence - hard training makes everything else feel easier. +15% XP for high-intensity activities. RPG: +15% critical hit chance." },
                            { level: 7, name: "Unshakeable Routine", description: "Habit Effect: Unlocks 'combo' activity type. Physical fitness becomes ingrained - prevents habit decay for 3 days after breaks. RPG: Cannot be disarmed or knocked down." },
                            { level: 10, name: "Power Reserve", description: "Habit Effect: +20% XP bonus for second Power activity of the day. Multiple activities compound benefits. RPG: Regain 25% stamina when health drops below 30%." },
                            { level: 12, name: "Morning Victory", description: "Habit Effect: +25% XP bonus for first Power activity of the day (60s cooldown on bonus). Early activity sets winning tone. RPG: +20% damage for 10 seconds (60s cooldown)." },
                            { level: 15, name: "Cross-Training Genius", description: "Habit Effect: Unlocks 'skill_combo' activity type. +30% XP when combining physical activity with mental/social skills. RPG: Can smash through weak walls and barriers." },
                            { level: 17, name: "Mind-Body Unity", description: "Habit Effect: +15% XP to all skills when Power activities exceed 30 minutes. Physical fitness stabilizes emotions. RPG: Immune to knockback effects." },
                            { level: 20, name: "Endurance Foundation", description: "Habit Effect: +25% maximum daily activity limit for Power skill. Long sessions (45+ min) build life endurance. RPG: +25% maximum stamina." },
                            { level: 22, name: "Perfect Form", description: "Habit Effect: Next Power activity after mastering technique has +50% critical XP chance. Safety and efficiency improve. RPG: Next attack has +50% critical chance." },
                            { level: 25, name: "Inspiration Catalyst", description: "Habit Effect: +20% XP bonus to group activities. Visible fitness progress motivates others - unlocks 'leadership' activity type. RPG: Hit all enemies in front arc.", milestone: true },
                            { level: 27, name: "Recovery Master", description: "Habit Effect: 30% faster cooldown recovery between Power activities. Enhanced recovery between sessions. RPG: Stamina regenerates 30% faster." },
                            { level: 30, name: "Reliable Strength", description: "Habit Effect: XP variance reduced by 50% - consistent performance regardless of external factors. RPG: Damage variance reduced by 50%." },
                            { level: 32, name: "Explosive Initiative", description: "Habit Effect: First Power activity of combat/challenge phase deals double XP. Instant high-intensity engagement. RPG: First attack in combat deals double damage." },
                            { level: 35, name: "Iron Health", description: "Habit Effect: Immune to negative status effects from environmental factors (stress, fatigue). Dramatically improved resilience. RPG: Immune to poison and disease." },
                            { level: 37, name: "Effortless Movement", description: "Habit Effect: All Power abilities cost 20% less stamina/effort. Daily activities require less energy. RPG: All Power abilities cost 20% less stamina." },
                            { level: 40, name: "Momentum Chain", description: "Habit Effect: Movement speed increases with each completed Power activity (stacks up to 5x). Success builds momentum. RPG: Movement speed increases with each kill." },
                            { level: 42, name: "Plateau Breaker", description: "Habit Effect: Power activities ignore 50% of difficulty penalties when pushing limits. Break through training walls. RPG: Attacks ignore 50% of enemy armor." },
                            { level: 45, name: "Limitless Endurance", description: "Habit Effect: Can perform extended Power activities without stamina drain (45+ minutes). Sustainable effort for hours. RPG: Can sprint without stamina drain." },
                            { level: 47, name: "Ground Slam", description: "Habit Effect: Explosive power affects multiple skill areas. +15% XP to all skills when Power exceeds intensity 3. RPG: AoE attack that staggers nearby enemies." },
                            { level: 50, name: "Unstoppable Force", description: "Habit Effect: Elite fitness level - break through ANY barrier or limitation. All Power activity restrictions removed. RPG: Break through ANY barrier.", milestone: true },
                            { level: 52, name: "Sustained Assault", description: "Habit Effect: Consistency builds exponential gains. RPG: +5% damage per consecutive hit (max 50%)." },
                            { level: 55, name: "Adaptive Training", description: "Habit Effect: Daily bonuses based on workout variety. RPG: Daily bonuses based on workout variety." },
                            { level: 57, name: "Multi-Strike", description: "Habit Effect: Can efficiently combine multiple exercises. RPG: Attack twice in one action." },
                            { level: 60, name: "Regenerative Effort", description: "Habit Effect: Exercise actually heals and energizes you. RPG: Slowly heal during combat." },
                            { level: 62, name: "Devastating Blow", description: "Habit Effect: Peak power output in crucial moments. RPG: Charged attack dealing 5x damage." },
                            { level: 65, name: "Perfect Technique", description: "Habit Effect: All movements have optimal timing and form. RPG: All attacks have optimal timing." },
                            { level: 67, name: "Limitless Energy", description: "Habit Effect: Brief periods of seemingly infinite stamina. RPG: 'Infinite Stamina' mode for 30 seconds." },
                            { level: 70, name: "Earthquake", description: "Habit Effect: Your presence creates powerful impact. RPG: Massive AoE that affects entire battlefield." },
                            { level: 72, name: "Strength Echo", description: "Habit Effect: Your power resonates beyond the immediate. RPG: Physical attacks create damaging shockwaves." },
                            { level: 75, name: "Titan Form", description: "Habit Effect: Achieve legendary strength levels. RPG: Double size and power for 60 seconds.", milestone: true },
                            { level: 77, name: "Unbreakable", description: "Habit Effect: Immunity to ALL negative physical effects. RPG: Immunity to ALL debuffs." },
                            { level: 80, name: "Momentum Master", description: "Habit Effect: Each action builds unstoppable forward progress. RPG: Each action builds unstoppable momentum." },
                            { level: 82, name: "Force Multiplier", description: "Habit Effect: Double the impact of all physical efforts. RPG: Physical attacks deal +100% damage." },
                            { level: 85, name: "Perpetual Motion", description: "Habit Effect: Energy regenerates while being active. RPG: Stamina regenerates while sprinting." },
                            { level: 87, name: "Spirit Strike", description: "Habit Effect: Attack problems others can't even see. RPG: Attacks can damage incorporeal enemies." },
                            { level: 90, name: "Legendary Strength", description: "Habit Effect: Can handle extremely challenging tasks. RPG: Can lift/throw extremely heavy objects." },
                            { level: 92, name: "Seismic Impact", description: "Habit Effect: Your efforts create lasting change. RPG: Heavy attacks create small shockwaves." },
                            { level: 95, name: "Efficient Mastery", description: "Habit Effect: All abilities require minimal energy. RPG: All abilities cost 50% less stamina." },
                            { level: 97, name: "Crushing Blow", description: "Habit Effect: Devastating effectiveness against weakened problems. RPG: Deals massive damage to weakened enemies." },
                            { level: 100, name: "Unbreakable Will", description: "Habit Effect: Ultimate resilience and determination. RPG: Take 50% less damage, immune to instant death.", ultimate: true }
                        ]
                    },
                    clarity: {
                        name: "Clarity",
                        color: "#3498db",
                        abilities: [
                            { level: 1, name: "Sharp Focus", description: "Focused mental work creates lasting concentration - your work sessions become more productive." },
                            { level: 3, name: "Learning Acceleration", description: "Study sessions stick better - information connects to previous learning and stays with you longer." },
                            { level: 5, name: "Distraction Shield", description: "Mental training builds resistance to interruptions - maintain focus despite noise and chaos." },
                            { level: 7, name: "Deep Work State", description: "Habit Effect: Unlocks 'deep_work' activity type with dynamic XP bonus (scales with session length). RPG: Enter concentration mode that filters distractions." },
                            { level: 10, name: "Pattern Master", description: "Habit Effect: +15% XP bonus for 'problem_solving' activities. Enhanced ability to see connections in daily life. RPG: Spot hidden connections and predict outcomes." },
                            { level: 12, name: "Stress-Proof Mind", description: "Habit Effect: Mental clarity remains stable under pressure - no XP penalties from stress or deadlines. RPG: Mind stays steady under pressure." },
                            { level: 15, name: "Strategic Thinking", description: "Habit Effect: Cross-skill XP bonus from 'problem_solving' activities. +10% XP to all skills when solving complex problems. RPG: Quickly identify optimal solutions." },
                            { level: 17, name: "Mindfulness Integration", description: "Habit Effect: 'mindfulness' activities provide global +5% XP boost to all subsequent activities for 2 hours. RPG: Mental energy recovers quickly." },
                            { level: 20, name: "Memory Palace", description: "Habit Effect: +25% XP bonus for 'reading' activity type with dynamic scaling. Perfect information recall. RPG: Perfect recall of important information." },
                            { level: 22, name: "Predictive Reflexes", description: "Habit Effect: Anticipate habit-breaking obstacles - +20% resistance to negative environmental factors. RPG: Dodge chance based on enemy observation." },
                            { level: 25, name: "Mental Fortitude", description: "Habit Effect: Mental fatigue no longer reduces activity effectiveness. Use Clarity level instead of stamina for activity restrictions. RPG: Use Clarity instead of Stamina for abilities.", milestone: true },
                            { level: 27, name: "Speed Reading", description: "Habit Effect: 'reading' activities take 50% less time but give full XP. Rapid information absorption. RPG: Instantly absorb written information." },
                            { level: 30, name: "Perfect Recall", description: "Habit Effect: Remember all successful habit strategies - +30% consistency bonus to streak multipliers. RPG: Remember all NPC dialogue and clues." },
                            { level: 32, name: "Weakness Exploit", description: "Habit Effect: Critical XP hits on identified weak skill areas - +100% XP when addressing lowest skill. RPG: Critical hits on identified weak points." },
                            { level: 35, name: "Meditation Master", description: "Habit Effect: 'mindfulness' activities give +15% XP bonuses to ALL skills for 4 hours. RPG: Can meditate in combat for buffs." },
                            { level: 37, name: "Universal Language", description: "Habit Effect: +25% XP when learning any new skill through pattern recognition. Accelerated skill acquisition. RPG: Understand all forms of communication." },
                            { level: 40, name: "Time Dilation", description: "Habit Effect: Feel like you have more time - activities can exceed normal duration limits by 25%. RPG: Extend slow-time to 5 seconds." },
                            { level: 42, name: "Truth Sight", description: "Habit Effect: See through excuses and false justifications - immune to self-deception penalties on tracking. RPG: See through all illusions." },
                            { level: 45, name: "Strategic Genius", description: "Habit Effect: Predict optimal habit combinations - preview XP outcomes before committing to activities. RPG: Preview outcomes of major choices." },
                            { level: 47, name: "Mental Mapping", description: "Habit Effect: Map optimal daily routines - +20% efficiency bonus to all planned activity sequences. RPG: Know optimal path to any objective." },
                            { level: 50, name: "Omniscient Eye", description: "Habit Effect: Complete awareness of all patterns and triggers - see full activity history and analytics. +50% XP from all activities. RPG: See entire area layout.", milestone: true },
                            { level: 52, name: "Puzzle Master", description: "Habit Effect: Complex problems become simple to solve. RPG: Instantly see puzzle solutions." },
                            { level: 55, name: "Combat Precognition", description: "Habit Effect: Anticipate and prevent habit failures before they happen. RPG: See enemy attacks 1 second early." },
                            { level: 57, name: "Knowledge Network", description: "Habit Effect: Access collective wisdom and best practices. RPG: Access memories of nearby NPCs." },
                            { level: 60, name: "Reality Check", description: "Habit Effect: Distinguish between productive and destructive thought patterns. RPG: Distinguish between real and Languor illusions." },
                            { level: 62, name: "Future Sight", description: "Habit Effect: See the long-term consequences of daily choices. RPG: Preview next 10 seconds of combat." },
                            { level: 65, name: "Universal Understanding", description: "Habit Effect: Comprehend the deepest principles behind growth. RPG: Comprehend alien/ancient knowledge." },
                            { level: 67, name: "Mind Over Matter", description: "Habit Effect: Mental clarity boosts physical performance. RPG: Use Clarity to boost physical abilities." },
                            { level: 70, name: "Perfect Strategy", description: "Habit Effect: Always know the optimal next action for growth. RPG: Always know optimal action." },
                            { level: 72, name: "Temporal Awareness", description: "Habit Effect: Brief ability to undo recent poor decisions. RPG: Limited time rewind (5 seconds)." },
                            { level: 75, name: "Third Eye Open", description: "Habit Effect: Perceive multiple paths to the same goal. RPG: Perceive multiple realities.", milestone: true },
                            { level: 77, name: "Infinite Knowledge", description: "Habit Effect: Access all information about optimal habits instantly. RPG: Access all area information instantly." },
                            { level: 80, name: "Quantum Thinking", description: "Habit Effect: Process multiple improvement strategies simultaneously. RPG: Process multiple timelines simultaneously." },
                            { level: 82, name: "Perfect Understanding", description: "Habit Effect: Deep comprehension accelerates all learning. RPG: +50% XP from all activities." },
                            { level: 85, name: "Rapid Analysis", description: "Habit Effect: Instantly understand complex situations. RPG: Process information 3x faster." },
                            { level: 87, name: "Memory Master", description: "Habit Effect: Perfect recall of successful strategies. RPG: Perfect recall of last 24 hours." },
                            { level: 90, name: "Strategic Oracle", description: "Habit Effect: See optimal path through any challenge. RPG: See best path for complex challenges." },
                            { level: 92, name: "Mental Overdrive", description: "Habit Effect: Thinking speed doubles during peak focus. RPG: Double cast speed for abilities." },
                            { level: 95, name: "Clarity Overflow", description: "Habit Effect: Your clarity helps others think more clearly. RPG: Abilities grant clarity to allies." },
                            { level: 97, name: "Mind's Eye", description: "Habit Effect: Complete situational awareness at all times. RPG: See 360 degrees, through walls (limited range)." },
                            { level: 100, name: "Enlightened One", description: "Habit Effect: Ultimate mental efficiency - all thoughts perfectly aligned. RPG: All abilities have 25% shorter cooldowns.", ultimate: true }
                        ]
                    },
                    balance: {
                        name: "Balance",
                        color: "#f39c12",
                        abilities: [
                            { level: 1, name: "Grounded Presence", description: "Physical balance creates emotional stability - feel more centered and less reactive throughout the day." },
                            { level: 3, name: "Emotional Equilibrium", description: "Mindfulness practice builds resilience - difficult situations don't throw you off balance as easily." },
                            { level: 5, name: "Social Stability", description: "Inner balance shields against social pressure - maintain your values despite others' opinions." },
                            { level: 7, name: "Graceful Integration", description: "Habit Effect: Cross-skill integration bonus - +5% XP when combining Balance activities with other skills. RPG: Your presence becomes calmer and more mindful." },
                            { level: 10, name: "Steady Progress", description: "Habit Effect: Unlocks 'movement' activity type with +15% XP bonus. Maintain consistency through chaos. RPG: Emotional turbulence passes through quickly without taking hold." },
                            { level: 12, name: "Confident Composure", description: "Habit Effect: Physical poise translates to social confidence - +15% XP bonus for social activities requiring presence. RPG: Your confidence and presence improve significantly." },
                            { level: 15, name: "Mindful Movement", description: "Habit Effect: Movement activities become restorative - gain energy instead of losing it (+10% stamina recovery). RPG: Even routine activities restore your energy." },
                            { level: 17, name: "Emotional Mastery", description: "Habit Effect: Strong emotions enhance progress - convert negative emotions into +20% XP fuel for next activity. RPG: Respond thoughtfully rather than react impulsively." },
                            { level: 20, name: "Unshakeable Core", description: "Habit Effect: Life challenges don't destabilize routines - maintain essential habits through major disruptions. +50% streak protection. RPG: Remain steady through all storms." },
                            { level: 22, name: "Flow State", description: "Habit Effect: Unlocks 'flow_state' activity type - all activities feel effortless when in optimal challenge zone. +20% XP in flow. RPG: All actions feel effortless." },
                            { level: 25, name: "Environmental Adaptation", description: "Habit Effect: External circumstances don't derail habits - no XP penalties from terrain/environmental factors. RPG: No penalties from terrain.", milestone: true },
                            { level: 27, name: "Balanced Offense", description: "Habit Effect: Aggressive goal pursuit doesn't sacrifice other areas - maintain all skill progress simultaneously. RPG: Attacks don't leave you vulnerable." },
                            { level: 30, name: "Serene Mind", description: "Habit Effect: Mental chaos doesn't affect habit performance - no XP penalties from mental debuffs or distractions. RPG: Mental debuffs have no effect." },
                            { level: 32, name: "Gravity Defiance", description: "Habit Effect: Overcome seemingly impossible challenges - +100% XP bonus when tackling highest difficulty activities. RPG: Run on walls briefly." },
                            { level: 35, name: "Perfect Timing", description: "Habit Effect: All actions have optimal rhythm and timing - +25% XP bonus for activities performed at ideal daily times. RPG: All actions have optimal rhythm." },
                            { level: 37, name: "Elemental Balance", description: "Habit Effect: Resist all types of setbacks equally well - 25% resistance to all negative modifiers and penalties. RPG: Resist all elemental damage equally." },
                            { level: 40, name: "Untouchable", description: "Habit Effect: Brief periods of perfect execution after mastering a challenge - next activity after achieving new level has +200% XP. RPG: Brief invincibility after perfect dodge." },
                            { level: 42, name: "Feather Step", description: "Habit Effect: Navigate delicate situations with ease - no XP penalties for attempting difficult social or complex activities. RPG: Walk on water/air briefly." },
                            { level: 45, name: "Yin-Yang Strike", description: "Habit Effect: Actions that help you also benefit others - group activities provide +30% XP to all participants. RPG: Attacks heal allies while damaging enemies." },
                            { level: 47, name: "Reality Anchor", description: "Habit Effect: Immune to being derailed by chaos - maintain all streaks regardless of external disruption. RPG: Immune to displacement/teleportation." },
                            { level: 50, name: "Perfect Balance", description: "Habit Effect: Maintain equilibrium in any situation - can perform any activity type with any skill. Remove all restrictions. RPG: Defy physics at will.", milestone: true },
                            { level: 52, name: "Momentum Redirect", description: "Habit Effect: Turn obstacles into opportunities. RPG: Turn enemy attacks back on them." },
                            { level: 55, name: "Gravitational Control", description: "Habit Effect: Alter the weight of challenges around you. RPG: Alter gravity in small area." },
                            { level: 57, name: "Spatial Awareness", description: "Habit Effect: Always know exactly where you stand. RPG: Always know your exact position." },
                            { level: 60, name: "Harmony Field", description: "Habit Effect: Create zones of perfect balance in your life. RPG: Create zones of perfect balance." },
                            { level: 62, name: "Dimensional Step", description: "Habit Effect: Move between different aspects of life seamlessly. RPG: Short-range teleportation." },
                            { level: 65, name: "Absolute Stability", description: "Habit Effect: Cannot be affected by any external force. RPG: Cannot be affected by any force." },
                            { level: 67, name: "Reality Balance", description: "Habit Effect: Stabilize chaotic areas of your life. RPG: Stabilize chaotic areas." },
                            { level: 70, name: "Gravity Master", description: "Habit Effect: Full control over the weight of your responsibilities. RPG: Full gravitational control." },
                            { level: 72, name: "Phase Walking", description: "Habit Effect: Move between different life phases smoothly. RPG: Move between dimensions." },
                            { level: 75, name: "Eye of the Storm", description: "Habit Effect: Create perfect calm in any chaos. RPG: Create perfect calm.", milestone: true },
                            { level: 77, name: "Universal Equilibrium", description: "Habit Effect: Balance all forces in your environment. RPG: Balance all forces around you." },
                            { level: 80, name: "Paradox Resolution", description: "Habit Effect: Exist in multiple states of progress simultaneously. RPG: Exist in multiple states." },
                            { level: 82, name: "Perfect Equilibrium", description: "Habit Effect: Master of all defensive strategies. RPG: +25% to all defensive stats." },
                            { level: 85, name: "Momentum Master", description: "Habit Effect: Convert setbacks into forward motion. RPG: Convert enemy force into movement." },
                            { level: 87, name: "Stability Field", description: "Habit Effect: Others around you become more stable. RPG: Allies near you can't be stunned." },
                            { level: 90, name: "Gravity Well", description: "Habit Effect: Draw opportunities toward you or push problems away. RPG: Pull enemies toward you or push them away." },
                            { level: 92, name: "Balanced Counter", description: "Habit Effect: Perfect responses deal return value. RPG: Perfect blocks deal return damage." },
                            { level: 95, name: "Zen Mastery", description: "Habit Effect: Regenerate motivation during stressful times by staying calm. RPG: Regenerate health during combat if calm." },
                            { level: 97, name: "Universal Balance", description: "Habit Effect: Redistribute effort among your goals. RPG: Redistribute damage among party." },
                            { level: 100, name: "Perfect Center", description: "Habit Effect: Become immovable for brief periods, reflecting all negativity. RPG: Become immovable for 10 seconds, reflecting all attacks.", ultimate: true }
                        ]
                    },
                    spirit: {
                        name: "Spirit",
                        color: "#9b59b6",
                        abilities: [
                            { level: 1, name: "Warm Presence", description: "Habit Effect: +5% XP bonus for 'social' activity type. Your presence makes others comfortable. RPG: People naturally feel comfortable around you." },
                            { level: 3, name: "Empathic Link", description: "Habit Effect: +10% XP bonus when helping others with their habits. Better understand motivations. RPG: Read others' emotions accurately." },
                            { level: 5, name: "Inspiring Words", description: "Habit Effect: +15% XP bonus for 'helping_others' activity type. Helping others with habits gives bonus XP. RPG: Your encouragement genuinely lifts others up." },
                            { level: 7, name: "Trust Building", description: "Habit Effect: Unlocks deeper social interactions - access to 'group' activity type. People share struggles. RPG: People quickly see you as reliable and trustworthy." },
                            { level: 10, name: "Calming Aura", description: "Habit Effect: +10% XP bonus to all skills when in group settings. Your presence helps others maintain habits. RPG: Your presence soothes tensions and agitation." },
                            { level: 12, name: "Social Network", description: "Habit Effect: Build supportive communities - +20% XP bonus to group activities with dynamic scaling. RPG: People open up to you more readily." },
                            { level: 15, name: "Healing Touch", description: "Habit Effect: Your support helps others overcome obstacles - cross-skill XP bonus when helping others succeed. RPG: Your emotional support has tangible positive effects." },
                            { level: 17, name: "Rally Cry", description: "Habit Effect: Can motivate groups to take on challenges - unlock 'leadership' activity type with group bonuses. RPG: Your enthusiasm becomes contagious and energizing." },
                            { level: 20, name: "Natural Leader", description: "Habit Effect: Others look to you for guidance - +25% XP bonus for leadership and mentoring activities. RPG: Leadership feels natural and effortless." },
                            { level: 22, name: "Emotional Healing", description: "Habit Effect: Help others overcome past failures - remove negative status effects from group activities. RPG: Remove trauma from NPCs." },
                            { level: 25, name: "Persuasive Voice", description: "Habit Effect: Can convince others to adopt healthier habits - unlock 'mastery_project' activity type for major influence. RPG: Change NPC decisions.", milestone: true },
                            { level: 27, name: "Morale Boost", description: "Habit Effect: Groups you're part of gain +50% XP effectiveness - dynamic group bonus scaling. RPG: Allies fight 50% more effectively." },
                            { level: 30, name: "Heart Reading", description: "Habit Effect: Know what truly motivates each person - perfect activity type recommendations for others. RPG: Know NPC true motivations." },
                            { level: 32, name: "Shared Experience", description: "Habit Effect: Temporarily share your successful strategies - grant your skill bonuses to group members. RPG: Transfer your abilities briefly." },
                            { level: 35, name: "Community Builder", description: "Habit Effect: Improve group dynamics and collective growth - +30% XP to all group members' activities. RPG: Improve settlement faster." },
                            { level: 37, name: "Diplomatic Immunity", description: "Habit Effect: Former critics become neutral or supportive. RPG: Former enemies become neutral." },
                            { level: 40, name: "Soul Bond", description: "Habit Effect: Share motivation and energy with close allies. RPG: Share health/stamina with allies." },
                            { level: 42, name: "Mass Inspiration", description: "Habit Effect: Affect entire groups with your example. RPG: Affect entire groups at once." },
                            { level: 45, name: "Redemption Touch", description: "Habit Effect: Convert hostile people to supporters. RPG: Convert hostile NPCs." },
                            { level: 47, name: "Emotional Shield", description: "Habit Effect: Protect allies from despair and giving up. RPG: Protect allies from despair." },
                            { level: 50, name: "Beacon of Hope", description: "Habit Effect: Cure apathy and depression in your area. RPG: Cure Languor in area.", milestone: true },
                            { level: 52, name: "Unity Command", description: "Habit Effect: Perfect coordination with your team. RPG: Perfect coordination with allies." },
                            { level: 55, name: "Memory Restoration", description: "Habit Effect: Help others remember their goals and dreams. RPG: Return lost memories to NPCs." },
                            { level: 57, name: "Collective Strength", description: "Habit Effect: Pool group resources for major goals. RPG: Pool party resources." },
                            { level: 60, name: "Spirit Network", description: "Habit Effect: Instantly communicate and support across distance. RPG: Instantly communicate across distance." },
                            { level: 62, name: "Soul Healing", description: "Habit Effect: Repair the deepest emotional wounds in others. RPG: Repair deepest spiritual wounds." },
                            { level: 65, name: "Mass Awakening", description: "Habit Effect: Free groups from apathy and stagnation. RPG: Free groups from Languor." },
                            { level: 67, name: "Empathic Overflow", description: "Habit Effect: Your emotions positively affect the environment. RPG: Your emotions affect environment." },
                            { level: 70, name: "Divine Inspiration", description: "Habit Effect: Grant permanent improvements to others. RPG: Grant permanent stat boosts." },
                            { level: 72, name: "Resurrection Touch", description: "Habit Effect: Revive abandoned hopes and dreams in others. RPG: Revive fallen NPCs." },
                            { level: 75, name: "Avatar of Hope", description: "Habit Effect: Become a living cure for despair. RPG: Become living cure.", milestone: true },
                            { level: 77, name: "Universal Connection", description: "Habit Effect: Link all conscious beings in mutual support. RPG: Link all conscious beings." },
                            { level: 80, name: "Miracle Worker", description: "Habit Effect: Achieve impossible social transformations. RPG: Achieve impossible social outcomes." },
                            { level: 82, name: "Master Motivator", description: "Habit Effect: Grant significant improvements to allies. RPG: Grant allies significant stat boosts." },
                            { level: 85, name: "Collective Strength", description: "Habit Effect: Share your highest skill with the team. RPG: Share your highest stat with party." },
                            { level: 87, name: "Unbreakable Bonds", description: "Habit Effect: Linked allies share resilience and determination. RPG: Linked allies share damage reduction." },
                            { level: 90, name: "Inspiration Overflow", description: "Habit Effect: Your presence cures minor depression and apathy. RPG: Your presence cures minor Languor." },
                            { level: 92, name: "Rally Master", description: "Habit Effect: Revive fallen motivation once per major challenge. RPG: Revive fallen allies once per battle." },
                            { level: 95, name: "Beacon of Hope", description: "Habit Effect: Create zones immune to despair and giving up. RPG: Create anti-Languor zones." },
                            { level: 97, name: "United We Stand", description: "Habit Effect: More allies means stronger collective bonuses. RPG: More allies = stronger buffs." },
                            { level: 100, name: "Heart of the Team", description: "Habit Effect: While you persevere, allies cannot fall below 20% motivation. RPG: While alive, allies cannot fall below 20% HP.", ultimate: true }
                        ]
                    },
                    harmony: {
                        name: "Harmony",
                        color: "#27ae60",
                        abilities: [
                            { level: 1, name: "Skill Synergy", description: "Habit Effect: +5% XP bonus when training multiple skills in the same day. Cross-training bonuses activated. RPG: Your different skills begin to complement each other." },
                            { level: 3, name: "Creative Solutions", description: "Habit Effect: Unlocks 'creative' activity type with dynamic XP bonus scaling. Innovation becomes natural. RPG: Innovative approaches to problems become natural." },
                            { level: 5, name: "Aesthetic Sense", description: "Habit Effect: +8% XP bonus for 'environment' activity type. Arranged environment improves habit success. RPG: Beauty enhances your performance and mood." },
                            { level: 7, name: "Combo Basics", description: "Habit Effect: Smoothly transition between different skills - unlocks advanced combo activities. RPG: Smoothly transition between different activities and skills." },
                            { level: 10, name: "Resource Efficiency", description: "Habit Effect: Always active +10% XP bonus to all activities. Accomplish more with less effort. RPG: Every action becomes more purposeful and effective." },
                            { level: 12, name: "Artistic Expression", description: "Habit Effect: Creative activities provide +15% XP boost to all other skills for 3 hours. Deep satisfaction unlocked. RPG: Creative activities become deeply satisfying." },
                            { level: 15, name: "System Understanding", description: "Habit Effect: See how all habits work together - gain analytics dashboard for habit interconnections. RPG: See how all your skills work together as a unified system." },
                            { level: 17, name: "Fluid Transitions", description: "Habit Effect: Moving between activities feels seamless - no cooldown penalties between different skill activities. RPG: Daily rhythm becomes effortlessly smooth." },
                            { level: 20, name: "Integration Novice", description: "Habit Effect: Actively combine two different skills in one session - +20% XP bonus for skill combination activities. RPG: Actively combine two different skill areas in focused sessions." },
                            { level: 22, name: "Creative Combat", description: "Habit Effect: Improvise new approaches to challenges - unlock experimental activity types with high risk/reward. RPG: Improvise new attack patterns." },
                            { level: 25, name: "Environmental Artist", description: "Habit Effect: Reshape environment for optimal habit success - unlock 'environment' mastery with +25% XP bonus. RPG: Reshape areas aesthetically.", milestone: true },
                            { level: 27, name: "Skill Fusion", description: "Habit Effect: Merge different skill approaches for new effects - create custom hybrid activity types. RPG: Merge abilities for new effects." },
                            { level: 30, name: "Inspiration Strike", description: "Habit Effect: Random brilliant solutions to obstacles - 10% chance for double XP on any activity. RPG: Random brilliant solutions." },
                            { level: 32, name: "Efficiency Master", description: "Habit Effect: All habits become 25% more effective - permanent +25% XP multiplier to all activities. RPG: All actions 25% more effective." },
                            { level: 35, name: "Reality Painting", description: "Habit Effect: Make minor changes to create optimal conditions - modify activity type restrictions dynamically. RPG: Minor environmental changes." },
                            { level: 37, name: "Perfect Timing", description: "Habit Effect: All skill combinations flow in perfect rhythm. RPG: All skill combinations flow perfectly." },
                            { level: 40, name: "Innovation Engine", description: "Habit Effect: Create temporary new approaches to challenges. RPG: Create temporary new abilities." },
                            { level: 42, name: "Grand Design", description: "Habit Effect: See optimal path through complex challenges. RPG: See optimal path through challenges." },
                            { level: 45, name: "Creative Genius", description: "Habit Effect: Solutions that no one else sees become obvious. RPG: Solutions no one else sees." },
                            { level: 47, name: "Reality Sculptor", description: "Habit Effect: Major reshaping of your life environment. RPG: Major environmental reshaping." },
                            { level: 50, name: "Perfect Harmony", description: "Habit Effect: All skills work as one integrated whole - maximum synergy bonus, can use any activity type with any skill. RPG: All skills work as one.", milestone: true },
                            { level: 52, name: "Synthesis Master", description: "Habit Effect: Combine 3+ skills simultaneously for multiplicative effects. RPG: Combine 3+ skills simultaneously." },
                            { level: 55, name: "Living Art", description: "Habit Effect: Your creations become self-sustaining systems. RPG: Creations become autonomous." },
                            { level: 57, name: "Universal Rhythm", description: "Habit Effect: Everything in your life follows your optimal tempo. RPG: Everything follows your tempo." },
                            { level: 60, name: "Creative Field", description: "Habit Effect: Area around you where anything seems possible. RPG: Area where anything is possible." },
                            { level: 62, name: "Reality Composer", description: "Habit Effect: Orchestrate environmental changes for optimal growth. RPG: Orchestrate environmental changes." },
                            { level: 65, name: "Impossible Combinations", description: "Habit Effect: Break the normal rules of skill development. RPG: Break skill system rules." },
                            { level: 67, name: "Creative Singularity", description: "Habit Effect: Infinite innovative solutions to any problem. RPG: Infinite innovative solutions." },
                            { level: 70, name: "World Canvas", description: "Habit Effect: Entire regions of your life become your artistic expression. RPG: Entire regions become your art." },
                            { level: 72, name: "Perfection Synthesis", description: "Habit Effect: All actions achieve ideal outcomes. RPG: All actions achieve ideal outcome." },
                            { level: 75, name: "Creation Ex Nihilo", description: "Habit Effect: Make something meaningful from nothing. RPG: Make something from nothing.", milestone: true },
                            { level: 77, name: "Universal Harmony", description: "Habit Effect: All systems work in your favor naturally. RPG: All systems work in your favor." },
                            { level: 80, name: "Reality Artist", description: "Habit Effect: Fundamental reshaping of how you experience life. RPG: Fundamental world reshaping." },
                            { level: 82, name: "Master Integrator", description: "Habit Effect: All abilities flow together seamlessly. RPG: All abilities flow together seamlessly." },
                            { level: 85, name: "Creative Genius", description: "Habit Effect: Find unique solutions to any life challenge. RPG: Find unique solutions to any problem." },
                            { level: 87, name: "Perfect Efficiency", description: "Habit Effect: All actions use minimal resources for maximum effect. RPG: All actions use minimal resources." },
                            { level: 90, name: "Synthesis Master", description: "Habit Effect: Combine any 3 skills into one powerful action. RPG: Combine any 3 abilities into one action." },
                            { level: 92, name: "Adaptive Excellence", description: "Habit Effect: Abilities automatically adjust to any situation. RPG: Abilities adjust to situation." },
                            { level: 95, name: "Harmonic Resonance", description: "Habit Effect: All skills boost each other by 20% constantly. RPG: All skills boost each other by 20%." },
                            { level: 97, name: "Flow State Mastery", description: "Habit Effect: Perfect execution of all actions becomes natural. RPG: Perfect execution of all actions." },
                            { level: 100, name: "The Complete One", description: "Habit Effect: Ultimate life transformation - activate all skills simultaneously for massive synergy bonuses. +100% XP to all activities. RPG: Activate all skills simultaneously for 30 seconds.", ultimate: true }
                        ]
                    }
                };
            }

            // Milestone rewards for reaching certain levels across all skills
            getMilestoneRewards() {
                return [
                    { level: 25, title: "Habit Master", description: "All skills Lv25: Unlock weekly challenges and 2x XP weekend events" },
                    { level: 50, title: "Life Transformer", description: "All skills Lv50: Unlock monthly themes and habit coaching features" },
                    { level: 75, title: "Legendary Practitioner", description: "All skills Lv75: Unlock custom habit creation and advanced analytics" },
                    { level: 100, title: "Avatar of Growth", description: "All skills Lv100: Unlock mentorship mode and legacy tracking system" }
                ];
            }
            
            // Enhanced multipliers with consistency bonuses and skill balance
            calculateXP(skillType, duration, intensity, activityType = 'normal') {
                const baseXP = this.getActivityBaseXP(duration, skillType);
                
                // Effort level multiplier for new 1-4 scale: 0.8x to 1.5x
                // 1 (Easy) = 0.8x, 2 (Moderate) = 1.0x, 3 (Hard) = 1.25x, 4 (Extreme) = 1.5x
                const effortMultipliers = [0, 0.8, 1.0, 1.25, 1.5];
                const intensityMultiplier = effortMultipliers[intensity] || 1.0;
                
                // Streak multiplier
                const streakMultiplier = this.getStreakMultiplier();
                
                // Consistency bonus for hitting daily goals
                const consistencyMultiplier = this.getConsistencyMultiplier();
                
                // NEW: Ability bonuses based on unlocked abilities
                const abilityMultiplier = this.getAbilityMultiplier(skillType, duration, intensity, activityType);
                
                const finalXP = Math.floor(baseXP * intensityMultiplier * streakMultiplier * consistencyMultiplier * abilityMultiplier);
                
                return {
                    baseXP,
                    intensityMultiplier,
                    streakMultiplier,
                    consistencyMultiplier,
                    abilityMultiplier,
                    finalXP
                };
            }
            
            // NEW: Calculate ability-based multipliers
            getAbilityMultiplier(skillType, duration, intensity, activityType) {
                const skill = this.skills[skillType];
                let multiplier = 1.0;
                let bonuses = [];
                
                // Check for unlocked abilities and apply their bonuses
                const skillTree = this.getSkillTrees()[skillType];
                
                skillTree.abilities.forEach(ability => {
                    if (skill.level >= ability.level) {
                        // Apply ability bonuses based on activity context
                        const bonus = this.getAbilityBonus(ability, skillType, duration, intensity, activityType);
                        if (bonus > 0) {
                            multiplier *= (1 + bonus);
                            bonuses.push(`${ability.name}: +${Math.round(bonus * 100)}%`);
                        }
                    }
                });
                
                // Store bonus details for display
                this.lastAbilityBonuses = bonuses;
                
                return multiplier;
            }
            
            // NEW: Define specific ability bonuses with balanced values and anti-exploit measures
            getAbilityBonus(ability, skillType, duration, intensity, activityType) {
                // Check for exploit prevention first
                if (!this.canUseActivityType(activityType, duration, intensity)) {
                    return 0; // No bonus if exploit prevention triggers
                }
                
                const bonusMap = {
                    // POWER abilities
                    'Basic Strike': () => this.isConsecutiveDay(skillType) ? 0.05 : 0,
                    'Steady Pace': () => duration >= 20 ? 0.10 : 0,
                    'Heavy Lifter': () => intensity >= 7 ? 0.15 : 0,
                    'Power Surge': () => this.isFirstActivityToday(skillType) ? 0.20 : 0,
                    'Breakthrough': () => activityType === 'combo' ? 0.25 : 0,
                    'Stable Stance': () => skillType === 'power' ? 0 : 0, // Cross-skill XP handled separately
                    'Endurance Base': () => duration >= 45 ? 0.25 : 0,
                    
                    // CLARITY abilities
                    'Clear Sight': () => activityType === 'focus' ? 0.05 : 0,
                    'Quick Study': () => activityType === 'learning' ? 0.10 : 0,
                    'Focus Mode': () => activityType === 'deep_work' ? this.getDeepWorkBonus() : 0, // Dynamic deep work bonus
                    'Tactical Analysis': () => activityType === 'problem_solving' ? 0 : 0, // Cross-skill XP
                    'Deep Breathing': () => activityType === 'mindfulness' ? 0 : 0, // Global boost handled separately
                    'Speed Reading': () => activityType === 'reading' ? this.getReadingBonus() : 0, // Dynamic reading bonus
                    
                    // BALANCE abilities
                    'Steady Footing': () => activityType === 'balance_physical' ? 0.05 : 0,
                    'Graceful Movement': () => skillType === 'balance' ? 0 : 0, // Cross-skill XP
                    'Perfect Posture': () => activityType === 'social' ? 0.10 : 0,
                    'Zen Walking': () => activityType === 'movement' ? 0.15 : 0,
                    'Flow State': () => this.isInFlow() ? 0.20 : 0,
                    
                    // SPIRIT abilities
                    'Warm Presence': () => activityType === 'social' ? 0.05 : 0,
                    'Inspiring Words': () => activityType === 'helping_others' ? 0.15 : 0,
                    'Morale Boost': () => activityType === 'group' ? this.getGroupBonus() : 0, // Dynamic group bonus
                    
                    // HARMONY abilities
                    'Skill Synergy': () => this.hasMultipleSkillsToday() ? 0.05 : 0,
                    'Creative Solutions': () => activityType === 'creative' ? this.getCreativeBonus() : 0, // Dynamic creative bonus
                    'Aesthetic Sense': () => activityType === 'environment' ? 0.08 : 0,
                    'Artistic Expression': () => activityType === 'creative' ? this.getCreativeBonus() * 1.5 : 0, // 1.5x creative bonus
                    'Efficiency Master': () => 0.10, // Always active 10% bonus
                };
                
                const bonusFunction = bonusMap[ability.name];
                return bonusFunction ? bonusFunction() : 0;
            }
            
            // COMPREHENSIVE Anti-exploit system
            canUseActivityType(activityType, duration, intensity, activityTier = 'self-reported') {
                const today = new Date().toDateString();
                
                // GLOBAL DAILY LIMITS (apply to ALL activities, but with different tiers)
                const globalLimits = this.checkGlobalDailyLimits(activityTier);
                if (!globalLimits.canLog) {
                    return false;
                }
                
                // BASIC VALIDATION
                if (duration < 5 || duration > 180 || intensity < 1 || intensity > 10) {
                    return false;
                }
                
                // TIME FRAUD DETECTION
                if (!this.validateRealisticTiming(duration)) {
                    return false;
                }
                
                // INTENSITY FRAUD DETECTION
                if (!this.validateIntensityRealism(activityType, duration, intensity)) {
                    return false;
                }
                
                // SKILL-BASED & REALISTIC ACTIVITY TYPE RESTRICTIONS
                // Based on what an average person can realistically sustain
                const restrictions = {
                    // GENERAL ACTIVITIES (reasonable daily limits)
                    'normal': { 
                        maxPerDay: 6,      // 6 general activities per day max
                        minDuration: 10,   // Minimum 10 minutes
                        minIntensity: 1, 
                        cooldownMinutes: 30, // 30 minute cooldown between normal activities
                        maxDurationPerDay: 300, // 5 hours max per day
                        skill: 'Any',
                        description: 'General activities: max 6x/day, 10min+, 30min cooldown'
                    },
                    
                    // POWER SKILL ACTIVITIES
                    'combo': { 
                        maxPerDay: 1,      // High-intensity multi-skill activities are rare
                        minDuration: 45, 
                        minIntensity: 7,
                        cooldownHours: 6,  // Need significant recovery
                        maxDurationPerDay: 120, // 2 hours max combo work
                        skill: 'Power',
                        description: 'Power combo: 45+ min, intensity 7+, max 1x/day, 6h cooldown'
                    },
                    
                    // CLARITY SKILL ACTIVITIES  
                    'deep_work': { 
                        maxPerDay: 2,      // Average knowledge worker: 2 deep work sessions
                        minDuration: 45,   // Minimum for true deep work
                        minIntensity: 7, 
                        cooldownHours: 3,  // Need recovery time
                        maxDurationPerDay: 180, // 3 hours max deep work per day
                        skill: 'Clarity',
                        description: 'Deep Work: 45+ min, intensity 7+, max 2x/day, 3h cooldown'
                    },
                    'learning': { 
                        maxPerDay: 3,      // Average person can handle 3 learning sessions
                        minDuration: 20, 
                        minIntensity: 4,
                        cooldownMinutes: 60,
                        maxDurationPerDay: 180, // 3 hours max learning per day
                        skill: 'Clarity',
                        description: 'Learning: 20+ min, intensity 4+, max 3x/day, 1h cooldown'
                    },
                    'reading': { 
                        maxPerDay: 4,      // Most avid readers: 3-4 reading sessions
                        minDuration: 15, 
                        minIntensity: 2,
                        cooldownMinutes: 30,
                        maxDurationPerDay: 180, // 3 hours reading per day
                        skill: 'Clarity',
                        description: 'Reading: 15+ min, intensity 2+, max 4x/day, 30min cooldown'
                    },
                    'mindfulness': { 
                        maxPerDay: 4,      // Can be done multiple times throughout day
                        minDuration: 5, 
                        minIntensity: 2,
                        cooldownMinutes: 30,
                        maxDurationPerDay: 90, // 1.5 hours max mindfulness
                        skill: 'Clarity',
                        description: 'Mindfulness: 5+ min, intensity 2+, max 4x/day, 30min cooldown'
                    },
                    
                    // SPIRIT SKILL ACTIVITIES
                    'social': { 
                        maxPerDay: 3,      // General social interactions
                        minDuration: 15, 
                        minIntensity: 3,
                        cooldownMinutes: 45,
                        maxDurationPerDay: 180, // 3 hours social time
                        skill: 'Spirit',
                        description: 'Social activities: 15+ min, intensity 3+, max 3x/day, 45min cooldown'
                    },
                    'group': { 
                        maxPerDay: 2,      // Average person: 1-2 group activities per day
                        minDuration: 30, 
                        minIntensity: 4,
                        cooldownHours: 2,
                        maxDurationPerDay: 240, // 4 hours max group activities
                        skill: 'Spirit',
                        description: 'Group activities: 30+ min, intensity 4+, max 2x/day, 2h cooldown'
                    },
                    
                    // HARMONY SKILL ACTIVITIES
                    'creative': { 
                        maxPerDay: 3,      // Average creative person: 2-3 creative sessions
                        minDuration: 25, 
                        minIntensity: 5,
                        cooldownMinutes: 90,
                        maxDurationPerDay: 240, // 4 hours max creative work
                        skill: 'Harmony',
                        description: 'Creative work: 25+ min, intensity 5+, max 3x/day, 90min cooldown'
                    }
                };
                
                // Get usage tracking keys
                const usageKey = `activity_usage_${activityType}_${today}`;
                const lastUsedKey = `activity_last_${activityType}`;
                
                const restriction = restrictions[activityType] || restrictions['normal'];
                
                // Check minimum requirements
                if (duration < restriction.minDuration || intensity < restriction.minIntensity) {
                    return false;
                }
                
                // Check daily count limit
                const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
                if (currentUsage >= restriction.maxPerDay) {
                    return false;
                }
                
                // Check daily duration limit for this activity type
                if (restriction.maxDurationPerDay) {
                    const durationKey = `activity_duration_${activityType}_${today}`;
                    const currentDuration = parseInt(localStorage.getItem(durationKey) || '0');
                    if (currentDuration + duration > restriction.maxDurationPerDay) {
                        return false;
                    }
                }
                
                // Check cooldown period
                const lastUsed = localStorage.getItem(lastUsedKey);
                if (lastUsed) {
                    const lastUsedTime = new Date(lastUsed);
                    const now = new Date();
                    const minutesSinceLastUse = (now - lastUsedTime) / (1000 * 60);
                    
                    const cooldownMinutes = restriction.cooldownHours ? 
                        restriction.cooldownHours * 60 : 
                        restriction.cooldownMinutes || 0;
                    
                    if (minutesSinceLastUse < cooldownMinutes) {
                        return false;
                    }
                }
                
                return true;
            }
            
            // Check global daily limits based on realistic average user behavior with anti-exploit tiers
            checkGlobalDailyLimits(activityTier = 'self-reported') {
                const today = new Date().toDateString();
                
                // Tiered global limits based on verification level
                const tierLimits = {
                    'verified': {
                        // Hardware-tracked activities get much higher limits (but still realistic)
                        MAX_ACTIVITIES_PER_DAY: 15,      // Can log more verified activities
                        MAX_TOTAL_DURATION_PER_DAY: 12 * 60, // 12 hours (athletes/professionals)
                        MAX_XP_PER_DAY: 40000,           // Higher XP ceiling
                        MAX_ACTIVITIES_PER_HOUR: 6,      // More frequent verified activities
                        description: 'Verified (hardware-tracked)'
                    },
                    'time-tracked': {
                        // Time-tracked get relaxed limits but still reasonable
                        MAX_ACTIVITIES_PER_DAY: 12,      // More than self-reported
                        MAX_TOTAL_DURATION_PER_DAY: 9 * 60, // 9 hours of tracked time
                        MAX_XP_PER_DAY: 25000,           // Higher than normal
                        MAX_ACTIVITIES_PER_HOUR: 4,      // Slightly more frequent
                        description: 'Time-tracked (app-verified)'
                    },
                    'self-reported': {
                        // Standard limits for self-reported activities
                        MAX_ACTIVITIES_PER_DAY: 8,       // Average person: 6-8 activities
                        MAX_TOTAL_DURATION_PER_DAY: 6 * 60, // 6 hours focused work
                        MAX_XP_PER_DAY: 15000,           // Encourage consistency
                        MAX_ACTIVITIES_PER_HOUR: 3,      // Realistic pacing
                        description: 'Self-reported (standard)'
                    }
                };
                
                const limits = tierLimits[activityTier];
                
                // For verified activities, only check the most basic anti-abuse limits
                if (activityTier === 'verified') {
                    // Even verified activities shouldn't exceed physical reality
                    const totalDurationToday = parseInt(localStorage.getItem(`total_duration_${today}`) || '0');
                    if (totalDurationToday >= 16 * 60) { // 16 hours - absolute maximum
                        return { canLog: false, reason: `Even verified activities can't exceed 16 hours/day - That's physically impossible!` };
                    }
                    
                    const activitiesToday = parseInt(localStorage.getItem(`total_activities_${today}`) || '0');
                    if (activitiesToday >= 20) { // 20 activities - absolute maximum
                        return { canLog: false, reason: `Maximum 20 activities per day (even verified) - Take a break!` };
                    }
                    
                    return { canLog: true, tier: activityTier };
                }
                
                // Check total activities today
                const activitiesToday = parseInt(localStorage.getItem(`total_activities_${today}`) || '0');
                if (activitiesToday >= limits.MAX_ACTIVITIES_PER_DAY) {
                    return { 
                        canLog: false, 
                        reason: `${limits.description} daily activity limit reached (${limits.MAX_ACTIVITIES_PER_DAY}/day) - Quality over quantity!`,
                        tier: activityTier 
                    };
                }
                
                // Check total duration today
                const totalDurationToday = parseInt(localStorage.getItem(`total_duration_${today}`) || '0');
                if (totalDurationToday >= limits.MAX_TOTAL_DURATION_PER_DAY) {
                    return { 
                        canLog: false, 
                        reason: `${limits.description} daily time limit reached (${limits.MAX_TOTAL_DURATION_PER_DAY/60}h/day) - Rest is important too!`,
                        tier: activityTier 
                    };
                }
                
                // Check total XP today
                const totalXPToday = parseInt(localStorage.getItem(`total_xp_${today}`) || '0');
                if (totalXPToday >= limits.MAX_XP_PER_DAY) {
                    return { 
                        canLog: false, 
                        reason: `${limits.description} daily XP limit reached (${limits.MAX_XP_PER_DAY.toLocaleString()}/day) - Sustainable growth wins!`,
                        tier: activityTier 
                    };
                }
                
                // Check hourly activity rate
                const currentHour = new Date().getHours();
                const hourKey = `activities_hour_${today}_${currentHour}`;
                const activitiesThisHour = parseInt(localStorage.getItem(hourKey) || '0');
                if (activitiesThisHour >= limits.MAX_ACTIVITIES_PER_HOUR) {
                    return { 
                        canLog: false, 
                        reason: `${limits.description} hourly activity limit reached (${limits.MAX_ACTIVITIES_PER_HOUR}/hour) - Take time to focus!`,
                        tier: activityTier 
                    };
                }
                
                return { canLog: true, tier: activityTier };
            }
            
            // Validate realistic timing patterns
            validateRealisticTiming(duration) {
                const now = new Date();
                const todayKey = new Date().toDateString();
                
                // Check if user is claiming more hours than physically possible
                const totalDurationToday = parseInt(localStorage.getItem(`total_duration_${todayKey}`) || '0');
                const hoursClaimedToday = (totalDurationToday + duration) / 60;
                
                // Maximum 8 hours of focused activities per day (realistic for average person)
                if (hoursClaimedToday > 8) {
                    return false;
                }
                
                // Check for suspicious rapid-fire logging - increased to 5 minutes for more realistic spacing
                const lastActivityTime = localStorage.getItem('last_activity_timestamp');
                if (lastActivityTime) {
                    const timeSinceLastActivity = now - new Date(lastActivityTime);
                    const minutesSinceLastActivity = timeSinceLastActivity / (1000 * 60);
                    
                    // Must wait at least 5 minutes between activities (time to transition, reflect, record)
                    if (minutesSinceLastActivity < 5) {
                        return false;
                    }
                }
                
                return true;
            }
            
            // Validate intensity claims are realistic for average users
            validateIntensityRealism(activityType, duration, intensity) {
                // More realistic intensity limits - average people can't sustain max intensity for long
                const intensityLimits = {
                    10: { maxDuration: 30, description: "Maximum intensity can only be sustained for 30 minutes" },
                    9: { maxDuration: 60, description: "Very high intensity limited to 1 hour" },
                    8: { maxDuration: 90, description: "High intensity limited to 1.5 hours" },
                    7: { maxDuration: 120, description: "Moderately high intensity limited to 2 hours" }
                };
                
                const limit = intensityLimits[intensity];
                if (limit && duration > limit.maxDuration) {
                    return false;
                }
                
                // Activity type specific intensity limits (more realistic for average users)
                const activityIntensityLimits = {
                    'reading': { maxIntensity: 6, reason: "Reading is typically a calm, focused activity" },
                    'mindfulness': { maxIntensity: 5, reason: "Mindfulness emphasizes relaxed awareness" },
                    'learning': { maxIntensity: 7, reason: "Learning can be mentally intense but not physically" },
                    'social': { maxIntensity: 8, reason: "Social activities can be energetic but not extreme" }
                };
                
                const activityLimit = activityIntensityLimits[activityType];
                if (activityLimit && intensity > activityLimit.maxIntensity) {
                    return false;
                }
                
                return true;
            }
            
            // Track usage of ALL activity types + global limits (with tier tracking)
            trackActivityTypeUsage(activityType, duration, xpGained, tier = 'self-reported') {
                const today = new Date().toDateString();
                const now = new Date();
                const currentHour = now.getHours();
                
                // Track specific activity type usage
                const usageKey = `activity_usage_${activityType}_${today}`;
                const lastUsedKey = `activity_last_${activityType}`;
                const durationKey = `activity_duration_${activityType}_${today}`;
                
                // Increment daily usage counter for this activity type
                const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
                localStorage.setItem(usageKey, (currentUsage + 1).toString());
                
                // Track duration for this activity type
                const currentDuration = parseInt(localStorage.getItem(durationKey) || '0');
                localStorage.setItem(durationKey, (currentDuration + duration).toString());
                
                // Update last used timestamp
                localStorage.setItem(lastUsedKey, now.toISOString());
                
                // Track GLOBAL daily limits (ALL activities count toward global totals)
                const totalActivitiesKey = `total_activities_${today}`;
                const totalDurationKey = `total_duration_${today}`;
                const totalXPKey = `total_xp_${today}`;
                const hourlyActivitiesKey = `activities_hour_${today}_${currentHour}`;
                
                // Track by tier for analytics
                const tierActivitiesKey = `${tier}_activities_${today}`;
                const tierDurationKey = `${tier}_duration_${today}`;
                const tierXPKey = `${tier}_xp_${today}`;
                
                // Increment global counters
                const totalActivities = parseInt(localStorage.getItem(totalActivitiesKey) || '0');
                localStorage.setItem(totalActivitiesKey, (totalActivities + 1).toString());
                
                const totalDuration = parseInt(localStorage.getItem(totalDurationKey) || '0');
                localStorage.setItem(totalDurationKey, (totalDuration + duration).toString());
                
                const totalXP = parseInt(localStorage.getItem(totalXPKey) || '0');
                localStorage.setItem(totalXPKey, (totalXP + xpGained).toString());
                
                const hourlyActivities = parseInt(localStorage.getItem(hourlyActivitiesKey) || '0');
                localStorage.setItem(hourlyActivitiesKey, (hourlyActivities + 1).toString());
                
                // Increment tier-specific counters
                const tierActivities = parseInt(localStorage.getItem(tierActivitiesKey) || '0');
                localStorage.setItem(tierActivitiesKey, (tierActivities + 1).toString());
                
                const tierDuration = parseInt(localStorage.getItem(tierDurationKey) || '0');
                localStorage.setItem(tierDurationKey, (tierDuration + duration).toString());
                
                const tierXP = parseInt(localStorage.getItem(tierXPKey) || '0');
                localStorage.setItem(tierXPKey, (tierXP + xpGained).toString());
                
                // Update global timestamp for rapid-fire detection
                localStorage.setItem('last_activity_timestamp', now.toISOString());
                
                // Clean up old tracking data (keep only last 7 days)
                this.cleanupOldTrackingData();
            }
            
            // Clean up old tracking data to prevent localStorage bloat
            cleanupOldTrackingData() {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                // Only run cleanup once per day
                const lastCleanup = localStorage.getItem('last_cleanup_date');
                const today = new Date().toDateString();
                if (lastCleanup === today) return;
                
                // Remove old tracking data
                Object.keys(localStorage).forEach(key => {
                    if (key.includes('activity_usage_') || 
                        key.includes('activity_duration_') || 
                        key.includes('total_activities_') || 
                        key.includes('total_duration_') || 
                        key.includes('total_xp_') ||
                        key.includes('activities_hour_')) {
                        
                        // Extract date from key and check if it's old
                        const dateMatch = key.match(/(\d{4}-\d{2}-\d{2})/);
                        if (dateMatch) {
                            const keyDate = new Date(dateMatch[1]);
                            if (keyDate < sevenDaysAgo) {
                                localStorage.removeItem(key);
                            }
                        }
                    }
                });
                
                localStorage.setItem('last_cleanup_date', today);
            }
            
            // Dynamic bonus calculations with diminishing returns
            getDeepWorkBonus() {
                const today = new Date().toDateString();
                const usageKey = `activity_usage_deep_work_${today}`;
                const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
                
                // Diminishing returns: 100%, 75%, 50% for 1st, 2nd, 3rd use
                switch(currentUsage) {
                    case 0: return 1.0;  // 2x XP (100% bonus)
                    case 1: return 0.75; // 1.75x XP (75% bonus)
                    case 2: return 0.5;  // 1.5x XP (50% bonus)
                    default: return 0.25; // 1.25x XP (25% bonus) - shouldn't happen due to daily limit
                }
            }
            
            getReadingBonus() {
                const today = new Date().toDateString();
                const usageKey = `activity_usage_reading_${today}`;
                const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
                
                // Diminishing returns for reading
                if (currentUsage >= 4) return 0.25; // Reduced bonus after 4 uses
                return 0.5; // Standard 50% bonus
            }
            
            getGroupBonus() {
                const today = new Date().toDateString();
                const usageKey = `activity_usage_group_${today}`;
                const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
                
                // Group activities maintain higher bonus since they're naturally limited
                switch(currentUsage) {
                    case 0: return 0.30; // 30% bonus
                    case 1: return 0.20; // 20% bonus
                    default: return 0.10; // 10% bonus
                }
            }
            
            getCreativeBonus() {
                const today = new Date().toDateString();
                const usageKey = `activity_usage_creative_${today}`;
                const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
                
                // Creative work maintains decent bonus with slight diminishing returns
                if (currentUsage >= 3) return 0.08; // Reduced after 3 uses
                return 0.10; // Standard 10% bonus
            }
            
            // Helper functions for ability conditions
            isConsecutiveDay(skillType) {
                // Check if this skill was used yesterday
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayKey = yesterday.toDateString();
                return localStorage.getItem(`skill_${skillType}_${yesterdayKey}`) === 'true';
            }
            
            isFirstActivityToday(skillType) {
                const today = new Date().toDateString();
                return !localStorage.getItem(`skill_${skillType}_first_${today}`);
            }
            
            isInFlow() {
                // Consider "flow state" if user has done 2+ activities today with good intensity
                return this.todayActivities >= 2 && this.dailyXP > 3000;
            }
            
            hasMultipleSkillsToday() {
                return this.skillsTrained.size >= 2;
            }
            
            getStreakMultiplier() {
                if (this.streak >= 30) return 1.25; // 25% bonus for 30+ days
                if (this.streak >= 14) return 1.2;  // 20% bonus for 2+ weeks
                if (this.streak >= 7) return 1.15;  // 15% bonus for 1+ week
                if (this.streak >= 3) return 1.1;   // 10% bonus for 3+ days
                return 1.0;
            }
            
            // NEW: Consistency bonuses for hitting daily goals
            getConsistencyMultiplier() {
                if (this.consistencyStreak >= 21) return 1.5;  // 50% bonus for 3+ weeks of consistency!
                if (this.consistencyStreak >= 14) return 1.35; // 35% bonus for 2+ weeks
                if (this.consistencyStreak >= 7) return 1.25;  // 25% bonus for 1+ week
                if (this.consistencyStreak >= 3) return 1.15;  // 15% bonus for 3+ days
                if (this.dailyGoalMet) return 1.1;             // 10% bonus for today's goal
                return 1.0;
            }
            
            logActivity(skillType, activity, duration, intensity, activityType = 'normal') {
                const skill = this.skills[skillType];
                
                const today = new Date().toDateString();
                if (this.lastActivity !== today) {
                    // Check if yesterday's goal was met for consistency tracking
                    if (this.lastActivity) {
                        if (this.dailyGoalMet) {
                            this.consistencyStreak++;
                        } else {
                            this.consistencyStreak = 0; // Reset streak if goal wasn't met
                        }
                    }
                    
                    this.streak++;
                    this.lastActivity = today;
                    this.todayActivities = 0;
                    this.skillsTrained = new Set();
                    this.dailyXP = 0;
                    this.dailyGoalMet = false;
                }
                
                this.skillsTrained.add(skillType);
                this.todayActivities++;
                
                // Mark first activity for Power Surge ability
                if (!localStorage.getItem(`skill_${skillType}_first_${today}`)) {
                    localStorage.setItem(`skill_${skillType}_first_${today}`, 'true');
                }
                
                // Mark skill usage for consecutive day tracking
                localStorage.setItem(`skill_${skillType}_${today}`, 'true');
                
                // Check if daily goal is met
                if (this.todayActivities >= this.dailyGoal) {
                    this.dailyGoalMet = true;
                }
                
                const xpCalc = this.calculateXP(skillType, duration, intensity, activityType);
                const oldLevel = skill.level;
                
                // Track activity type usage for anti-exploit system (with XP for global tracking)
                this.trackActivityTypeUsage(activityType, duration, xpCalc.finalXP, 'self-reported');
                
                skill.xp += xpCalc.finalXP;
                skill.totalXP += xpCalc.finalXP;
                this.totalXP += xpCalc.finalXP;
                this.dailyXP += xpCalc.finalXP;
                
                // Handle cross-skill XP bonuses from abilities
                this.applyCrossSkillBonuses(skillType, xpCalc.finalXP, activityType);
                
                let levelsGained = 0;
                while (skill.xp >= this.xpForLevel(skill.level + 1)) {
                    skill.xp -= this.xpForLevel(skill.level + 1);
                    skill.level++;
                    levelsGained++;
                }
                
                this.saveData();
                this.render();
                this.showMessage(skill, xpCalc, levelsGained, activityType);
            }
            
            // NEW: Apply cross-skill bonuses from abilities
            applyCrossSkillBonuses(primarySkill, baseXP, activityType) {
                const skill = this.skills[primarySkill];
                const bonusXP = Math.floor(baseXP * 0.1); // 10% of primary XP
                
                // Stable Stance (Power Lv17): Power activities give Balance XP
                if (primarySkill === 'power' && skill.level >= 17) {
                    this.skills.balance.xp += bonusXP;
                    this.skills.balance.totalXP += bonusXP;
                }
                
                // Tactical Analysis (Clarity Lv15): Problem-solving gives Spirit XP
                if (primarySkill === 'clarity' && skill.level >= 15 && activityType === 'problem_solving') {
                    this.skills.spirit.xp += bonusXP;
                    this.skills.spirit.totalXP += bonusXP;
                }
                
                // Graceful Movement (Balance Lv7): Balance activities give Spirit XP
                if (primarySkill === 'balance' && skill.level >= 7) {
                    this.skills.spirit.xp += bonusXP;
                    this.skills.spirit.totalXP += bonusXP;
                }
                
                // Deep Breathing (Clarity Lv17): Mindfulness boosts all other skills
                if (primarySkill === 'clarity' && skill.level >= 17 && activityType === 'mindfulness') {
                    const globalBonus = Math.floor(baseXP * 0.05); // 5% to all other skills
                    Object.keys(this.skills).forEach(skillKey => {
                        if (skillKey !== 'clarity') {
                            this.skills[skillKey].xp += globalBonus;
                            this.skills[skillKey].totalXP += globalBonus;
                        }
                    });
                }
            }
            
            // Check if skill should level up and handle level progression
            checkLevelUp(skillName) {
                const skill = this.skills[skillName];
                if (!skill) return;
                
                let levelsGained = 0;
                while (skill.xp >= this.xpForLevel(skill.level + 1)) {
                    skill.xp -= this.xpForLevel(skill.level + 1);
                    skill.level++;
                    levelsGained++;
                }
                
                // Show level up notification if levels were gained
                if (levelsGained > 0) {
                    this.addNotification(`🎉 ${skill.name} leveled up to ${skill.level}!`, 'success');
                }
                
                return levelsGained;
            }
            
            showMessage(skill, xpCalc, levelsGained, activityType) {
                const container = document.getElementById('message-container');
                
                let message = `<div class="message">
                    ${skill.emoji} <strong>${skill.name}</strong> gained ${xpCalc.finalXP.toLocaleString()} XP!<br>
                    <small>Base: ${xpCalc.baseXP.toLocaleString()} × Intensity: ${xpCalc.intensityMultiplier.toFixed(2)} × Streak: ${xpCalc.streakMultiplier.toFixed(2)} × Consistency: ${xpCalc.consistencyMultiplier.toFixed(2)} × Abilities: ${xpCalc.abilityMultiplier.toFixed(2)}</small>`;
                
                // Show ability bonuses if any were applied
                if (this.lastAbilityBonuses && this.lastAbilityBonuses.length > 0) {
                    message += `<br><small style="color: #f39c12;">⚡ Ability Bonuses: ${this.lastAbilityBonuses.join(', ')}</small>`;
                }
                
                message += `</div>`;
                
                // Add to dashboard notifications
                this.addNotification(`${skill.emoji} <strong>${skill.name}</strong> +${xpCalc.finalXP.toLocaleString()} XP`, 'success');
                
                if (levelsGained > 0) {
                    message += `<div class="message level-up">
                        🎉 ${skill.name} reached Level ${skill.level}! 🎉
                    </div>`;
                    this.addNotification(`🎉 ${skill.name} leveled up to ${skill.level}!`, 'success');
                }
                
                // Show daily goal achievement
                if (this.todayActivities === this.dailyGoal) {
                    message += `<div class="message level-up">
                        🎯 Daily Goal Achieved! Consistency bonus activated! 🎯
                    </div>`;
                    this.addNotification(`🎯 Daily Goal Achieved! Consistency bonus activated!`, 'success');
                }
                
                container.innerHTML = message;
                setTimeout(() => {
                    container.innerHTML = '';
                }, 8000);
            }
            
            showWelcome() {
                const container = document.getElementById('message-container');
                container.innerHTML = `<div class="message welcome">
                    🏔️ Welcome to The Unbroken Ascent!<br>
                    Build real habits, gain XP, level up skills!
                </div>`;
                setTimeout(() => {
                    container.innerHTML = '';
                }, 8000);
            }
            
            render() {
                this.renderSkills();
                this.renderStats();
                this.renderBossStatus();
                this.renderActivityUsageTracker();
                this.renderDailyLimitsTracker();
                this.renderDashboard();
                this.updateActivityTypes(); // Update available activity types based on skill levels
            }

            // Update available activity types based on current skill levels
            updateActivityTypes() {
                const select = document.getElementById('activity-type-select');
                if (!select) return;
                
                // Define activity types with their unlock requirements
                const activityTypes = [
                    {
                        value: 'normal',
                        label: '⚡ Normal Activity',
                        details: '6/day • 5-60min • any effort',
                        skill: null, // Always available
                        level: 0,
                        minDuration: 5,
                        maxDuration: 60
                    },
                    {
                        value: 'learning',
                        label: '📚 Learning & Study',
                        details: '3/day • 15-90min • moderate+ • Knowledge Boost',
                        skill: 'clarity',
                        level: 1,
                        description: '🔓 Basic Clarity skill',
                        minDuration: 15,
                        maxDuration: 90
                    },
                    {
                        value: 'reading',
                        label: '📖 Reading',
                        details: '4/day • 10-120min • easy to hard • Retention Bonus',
                        skill: 'clarity',
                        level: 1,
                        description: '🔓 Basic Clarity skill',
                        minDuration: 10,
                        maxDuration: 120
                    },
                    {
                        value: 'mindfulness',
                        label: '🧘 Mindfulness & Meditation',
                        details: '4/day • 3-45min • easy to hard • Clarity Boost',
                        skill: 'balance',
                        level: 1,
                        description: '🔓 Basic Balance skill',
                        minDuration: 3,
                        maxDuration: 45
                    },
                    {
                        value: 'social',
                        label: '🤝 Social Activity',
                        details: '3/day • 10-180min • easy to hard • Connection Bonus',
                        skill: 'spirit',
                        level: 1,
                        description: '🔓 Basic Spirit skill',
                        minDuration: 10,
                        maxDuration: 180
                    },
                    {
                        value: 'creative',
                        label: '🎨 Creative Work',
                        details: '3/day • 20-120min • any effort • Innovation Boost',
                        skill: 'harmony',
                        level: 1,
                        description: '🔓 Basic Harmony skill',
                        minDuration: 20,
                        maxDuration: 120
                    },
                    {
                        value: 'movement',
                        label: '🚶 Movement & Exercise',
                        details: '4/day • 10-90min • any effort • Vitality Boost',
                        skill: 'power',
                        level: 3,
                        description: '🔓 Unlocked by Power Level 3 "Steady Foundation" ability',
                        minDuration: 10,
                        maxDuration: 90
                    },
                    {
                        value: 'problem_solving',
                        label: '🧩 Problem Solving',
                        details: '3/day • 20-120min • moderate+ • Strategy Bonus',
                        skill: 'clarity',
                        level: 5,
                        description: '🔓 Unlocked by Clarity Level 5 "Distraction Shield" ability',
                        minDuration: 20,
                        maxDuration: 120
                    },
                    {
                        value: 'deep_work',
                        label: '🎯 Deep Work',
                        details: '2/day • 25-180min • hard+ • 2x XP Focus',
                        skill: 'clarity',
                        level: 7,
                        description: '🔓 Unlocked by Clarity Level 7 "Deep Work State" ability',
                        minDuration: 25,
                        maxDuration: 180
                    },
                    {
                        value: 'group',
                        label: '👥 Group Activity',
                        details: '2/day • 15-240min • moderate+ • Team Synergy',
                        skill: 'spirit',
                        level: 10,
                        description: '🔓 Unlocked by Spirit Level 10 "Calming Aura" ability',
                        minDuration: 15,
                        maxDuration: 240
                    },
                    {
                        value: 'skill_combo',
                        label: '� Skill Combination',
                        details: '2/day • 30-90min • moderate+ • Multi-Skill XP',
                        skill: 'harmony',
                        level: 12,
                        description: '🔓 Unlocked by Harmony Level 12 "Artistic Expression" ability',
                        minDuration: 30,
                        maxDuration: 90
                    },
                    {
                        value: 'power_combo',
                        label: '💥 Power Breakthrough',
                        details: '1/day • 30-120min • hard+ • Explosive Growth',
                        skill: 'power',
                        level: 15,
                        description: '🔓 Unlocked by Power Level 15 "Cross-Training Genius" ability',
                        minDuration: 30,
                        maxDuration: 120
                    },
                    {
                        value: 'flow_state',
                        label: '🌊 Flow State',
                        details: '2/day • 45-150min • any effort • Peak Performance',
                        skill: 'balance',
                        level: 22,
                        description: '🔓 Unlocked by Balance Level 22 "Flow State" ability',
                        minDuration: 45,
                        maxDuration: 150
                    },
                    {
                        value: 'leadership',
                        label: '👑 Leadership Activity',
                        details: '2/day • 30-180min • moderate+ • Influence Multiplier',
                        skill: 'spirit',
                        level: 20,
                        description: '🔓 Unlocked by Spirit Level 20 "Natural Leader" ability',
                        minDuration: 30,
                        maxDuration: 180
                    },
                    {
                        value: 'mastery_project',
                        label: '🏆 Mastery Project',
                        details: '1/day • 60-240min • hard+ • Legacy Building',
                        skill: 'harmony',
                        level: 25,
                        description: '🔓 Unlocked by Harmony Level 25 "Environmental Artist" ability',
                        minDuration: 60,
                        maxDuration: 240
                    }
                ];
                
                // Clear existing options
                select.innerHTML = '';
                
                // Add only unlocked activity types (hide locked ones completely)
                activityTypes.forEach(type => {
                    const isUnlocked = !type.skill || this.skills[type.skill].level >= type.level;
                    
                    // Only add the option if it's unlocked
                    if (isUnlocked) {
                        const option = document.createElement('option');
                        option.value = type.value;
                        // Format: "Icon Name (details)"
                        option.textContent = `${type.label} (${type.details})`;
                        
                        if (type.skill) {
                            option.setAttribute('data-skill', type.skill);
                        }
                        
                        select.appendChild(option);
                    }
                });
                
                console.log('🔄 Activity types updated - only showing unlocked activities');
            }

            // ...existing code...
            
            renderSkills() {
                console.log('🔧 renderSkills() called');
                const container = document.getElementById('skills-container');
                console.log('📦 Skills container:', container);
                
                if (!container) {
                    console.error('❌ Skills container not found!');
                    return;
                }
                
                container.innerHTML = '';
                
                console.log('🎯 Skills data:', this.skills);
                
                Object.entries(this.skills).forEach(([key, skill]) => {
                    const nextLevelXP = this.xpForLevel(skill.level + 1);
                    const progress = (skill.xp / nextLevelXP) * 100;
                    
                    const skillCard = document.createElement('div');
                    skillCard.className = 'skill-card';
                    skillCard.onclick = () => this.openSkillTree(key);
                    skillCard.innerHTML = `
                        <div class="skill-header">
                            <div class="skill-name">${skill.emoji} ${skill.name}</div>
                            <div class="skill-level">Lv ${skill.level}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="progress-text">${skill.xp.toLocaleString()} / ${nextLevelXP.toLocaleString()} XP</div>
                        <div style="font-size: 10px; color: #85929e; margin-top: 8px; text-align: center;">
                            🔍 Click to view skill tree & abilities
                        </div>
                    `;
                    container.appendChild(skillCard);
                });
            }
            
            renderStats() {
                document.getElementById('streak-display').textContent = `${this.streak} days`;
                document.getElementById('total-xp').textContent = this.totalXP.toLocaleString();
                document.getElementById('today-activities').textContent = this.todayActivities;
                
                // Update daily goal progress
                const goalStatus = document.getElementById('goal-status');
                if (goalStatus) {
                    const progress = Math.min(this.todayActivities / this.dailyGoal, 1) * 100;
                    const goalText = this.dailyGoalMet ? '✅ Goal Achieved!' : `${this.todayActivities}/${this.dailyGoal} activities`;
                    goalStatus.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span>Daily Goal:</span>
                            <span style="color: ${this.dailyGoalMet ? '#2ecc71' : '#f39c12'};">${goalText}</span>
                        </div>
                        <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin-bottom: 4px;">
                            <div style="width: ${progress}%; height: 100%; background: ${this.dailyGoalMet ? '#2ecc71' : '#f39c12'}; border-radius: 2px; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 10px; color: #bdc3c7;">Consistency streak: ${this.consistencyStreak} days</div>
                    `;
                }
            }
            
            renderBossStatus() {
                const bossElement = document.getElementById('boss-status');
                const avgLevel = Object.values(this.skills).reduce((sum, skill) => sum + skill.level, 0) / 5;
                
                if (avgLevel >= 100) {
                    bossElement.textContent = '👑 MASTERY ACHIEVED! You have conquered The Unbroken Ascent!';
                    bossElement.className = 'boss-status boss-ready';
                } else if (avgLevel >= 75) {
                    bossElement.textContent = '🏔️ LEGENDARY! Almost at the summit! Keep climbing!';
                    bossElement.className = 'boss-status boss-ready';
                } else if (avgLevel >= 50) {
                    bossElement.textContent = '⚔️ VETERAN! You have become a true warrior of habits!';
                    bossElement.className = 'boss-status boss-ready';
                } else if (avgLevel >= 25) {
                    bossElement.textContent = '🛡️ ADVANCED! You are building serious momentum!';
                    bossElement.className = 'boss-status boss-ready';
                } else if (avgLevel >= 10) {
                    bossElement.textContent = '🗡️ EXPERIENCED! The habits are becoming natural!';
                    bossElement.className = 'boss-status boss-ready';
                } else {
                    bossElement.textContent = `🌱 BEGINNER: Keep training! Average level ${avgLevel.toFixed(1)}/100`;
                    bossElement.className = 'boss-status';
                }
            }
            
            renderActivityUsageTracker() {
                const tracker = document.getElementById('activity-usage-tracker');
                if (!tracker) return;
                
                const today = new Date().toDateString();
                const restrictedTypes = ['deep_work', 'combo', 'group', 'creative'];
                const maxUsages = { 'deep_work': 3, 'combo': 2, 'group': 2, 'creative': 4 };
                
                let usageInfo = [];
                restrictedTypes.forEach(type => {
                    const usageKey = `activity_usage_${type}_${today}`;
                    const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
                    const maxUsage = maxUsages[type];
                    const remaining = maxUsage - currentUsage;
                    
                    if (currentUsage > 0 || remaining < maxUsage) {
                        const typeName = type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                        let status = remaining > 0 ? `${remaining} left` : '❌ Maxed';
                        if (remaining > 0) status = `✅ ${status}`;
                        
                        usageInfo.push(`${typeName}: ${status}`);
                    }
                });
                
                if (usageInfo.length > 0) {
                    tracker.innerHTML = `📊 <strong>Today's Bonus Activities:</strong> ${usageInfo.join(' | ')}`;
                } else {
                    tracker.innerHTML = `📊 <strong>Bonus Activities Available:</strong> Deep Work (3x), Creative (4x), Combo (2x), Group (2x)`;
                }
            }
            
            renderDailyLimitsTracker() {
                const tracker = document.getElementById('daily-limits-tracker');
                if (!tracker) return;
                
                const today = new Date().toDateString();
                
                // Get global usage
                const totalActivities = parseInt(localStorage.getItem(`total_activities_${today}`) || '0');
                const totalDuration = parseInt(localStorage.getItem(`total_duration_${today}`) || '0');
                const totalXP = parseInt(localStorage.getItem(`total_xp_${today}`) || '0');
                
                const currentHour = new Date().getHours();
                const hourlyActivities = parseInt(localStorage.getItem(`activities_hour_${today}_${currentHour}`) || '0');
                
                // Global limits
                const MAX_ACTIVITIES = 20;
                const MAX_DURATION = 12 * 60; // 12 hours
                const MAX_XP = 50000;
                const MAX_HOURLY = 6;
                
                // Calculate percentages and status
                const activityPercent = Math.round((totalActivities / MAX_ACTIVITIES) * 100);
                const durationPercent = Math.round((totalDuration / MAX_DURATION) * 100);
                const xpPercent = Math.round((totalXP / MAX_XP) * 100);
                const hourlyPercent = Math.round((hourlyActivities / MAX_HOURLY) * 100);
                
                // Status indicators
                const getStatus = (percent) => {
                    if (percent >= 100) return '🔴';
                    if (percent >= 80) return '🟠';
                    if (percent >= 50) return '🟡';
                    return '🟢';
                };
                
                const formatTime = (minutes) => {
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
                };
                
                tracker.innerHTML = `
                    <div style="margin-bottom: 8px;"><strong>Global Daily Limits:</strong></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <div>${getStatus(activityPercent)} Activities: ${totalActivities}/${MAX_ACTIVITIES} (${activityPercent}%)</div>
                        <div>${getStatus(durationPercent)} Time: ${formatTime(totalDuration)}/${formatTime(MAX_DURATION)} (${durationPercent}%)</div>
                        <div>${getStatus(xpPercent)} XP: ${totalXP.toLocaleString()}/${MAX_XP.toLocaleString()} (${xpPercent}%)</div>
                        <div>${getStatus(hourlyPercent)} This Hour: ${hourlyActivities}/${MAX_HOURLY} (${hourlyPercent}%)</div>
                    </div>
                    
                    <div style="margin-bottom: 8px;"><strong>Activity Type Limits:</strong></div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 4px; font-size: 10px;">
                        ${this.getActivityTypeLimitsDisplay()}
                    </div>
                    
                    <div style="margin-top: 8px; font-size: 10px; color: #95a5a6;">
                        🛡️ <strong>Anti-Exploit Active:</strong> These limits ensure realistic, sustainable habit building and prevent account farming.
                    </div>
                `;
            }
            
            getActivityTypeLimitsDisplay() {
                const today = new Date().toDateString();
                const activityTypes = [
                    { key: 'normal', name: 'Normal', max: 12 },
                    { key: 'deep_work', name: 'Deep Work', max: 3 },
                    { key: 'creative', name: 'Creative', max: 4 },
                    { key: 'focus', name: 'Focus', max: 6 },
                    { key: 'learning', name: 'Learning', max: 5 },
                    { key: 'reading', name: 'Reading', max: 4 },
                    { key: 'mindfulness', name: 'Mindful', max: 6 },
                    { key: 'social', name: 'Social', max: 4 },
                    { key: 'combo', name: 'Combo', max: 2 },
                    { key: 'group', name: 'Group', max: 2 }
                ];
                
                return activityTypes.map(type => {
                    const usageKey = `activity_usage_${type.key}_${today}`;
                    const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
                    const remaining = type.max - currentUsage;
                    
                    let status, color;
                    if (remaining <= 0) {
                        status = '🔴';
                        color = '#e74c3c';
                    } else if (remaining <= 1) {
                        status = '🟠';
                        color = '#f39c12';
                    } else if (remaining <= type.max / 2) {
                        status = '🟡';
                        color = '#f1c40f';
                    } else {
                        status = '🟢';
                        color = '#27ae60';
                    }
                    
                    return `<div style="color: ${color};">${status} ${type.name}: ${remaining}/${type.max}</div>`;
                }).join('');
            }
            
            renderDashboard() {
                // Update quick stats
                document.getElementById('dash-activities').textContent = this.todayActivities;
                document.getElementById('dash-xp').textContent = this.dailyXP.toLocaleString();
                document.getElementById('dash-streak').textContent = this.streak;
                
                const goalProgress = Math.min(this.todayActivities / this.dailyGoal, 1) * 100;
                document.getElementById('dash-goal').textContent = `${Math.round(goalProgress)}%`;
                
                // Update level overview
                const levelOverview = document.getElementById('dash-level-overview');
                if (levelOverview) {
                    const avgLevel = Object.values(this.skills).reduce((sum, skill) => sum + skill.level, 0) / 5;
                    const highestSkill = Object.entries(this.skills).reduce((highest, [key, skill]) => 
                        skill.level > highest.level ? skill : highest
                    );
                    
                    levelOverview.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Average Level:</span>
                            <span style="color: #f4d03f; font-weight: bold;">${avgLevel.toFixed(1)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Highest Skill:</span>
                            <span style="color: #f4d03f; font-weight: bold;">${highestSkill.emoji} ${highestSkill.name} Lv${highestSkill.level}</span>
                        </div>
                    `;
                }
            }
            
            // Add notification to dashboard feed
            addNotification(message, type = 'info') {
                const feed = document.getElementById('notification-feed');
                if (!feed) return;
                
                const notification = document.createElement('div');
                notification.className = `notification-item ${type}`;
                notification.innerHTML = message;
                
                // Add to top of feed
                feed.insertBefore(notification, feed.firstChild);
                
                // Keep only last 5 notifications
                while (feed.children.length > 5) {
                    feed.removeChild(feed.lastChild);
                }
            }
            
            saveData() {
                const data = {
                    skills: this.skills,
                    streak: this.streak,
                    lastActivity: this.lastActivity,
                    totalXP: this.totalXP,
                    todayActivities: this.todayActivities,
                    skillsTrained: Array.from(this.skillsTrained),
                    dailyXP: this.dailyXP,
                    dailyGoalMet: this.dailyGoalMet,
                    consistencyStreak: this.consistencyStreak,
                    dailyGoal: this.dailyGoal,
                    integrations: this.integrations,
                    settings: this.settings,
                    // Journal data
                    journalEntries: this.journalEntries,
                    journalStats: this.journalStats,
                    journalStreak: this.journalStreak,
                    // Lore data
                    loreData: this.loreData
                };
                
                try {
                    localStorage.setItem('unbrokenAscentWorking', JSON.stringify(data));
                } catch (error) {
                    console.error('❌ Error saving data:', error);
                }
            }
            
            loadData() {
                const saved = localStorage.getItem('unbrokenAscentWorking');
                
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        
                        this.skills = data.skills || this.skills;
                        this.streak = data.streak || 0;
                        this.lastActivity = data.lastActivity;
                        this.totalXP = data.totalXP || 0;
                        this.todayActivities = data.todayActivities || 0;
                        this.skillsTrained = new Set(data.skillsTrained || []);
                        this.dailyXP = data.dailyXP || 0;
                        this.dailyGoalMet = data.dailyGoalMet || false;
                        this.consistencyStreak = data.consistencyStreak || 0;
                        this.dailyGoal = data.dailyGoal || 2;
                        this.integrations = data.integrations || this.integrations;
                        this.settings = data.settings || this.settings;
                        
                        // Load journal data
                        this.journalEntries = data.journalEntries || [];
                        this.journalStats = data.journalStats || {
                            totalEntries: 0,
                            totalWords: 0,
                            totalXP: 0
                        };
                        this.journalStreak = data.journalStreak || 0;
                        
                        // Load lore data
                        this.loreData = data.loreData || {
                            currentDay: 1,
                            totalRead: 0,
                            xpEarned: 0,
                            streak: 0,
                            maxStreak: 0,
                            lastReadDate: null,
                            completedCycles: 0,
                            unlockedContent: []
                        };
                        
                    } catch (error) {
                        console.error('❌ Error parsing saved data:', error);
                    }
                }
                
                // Update integration UI after loading
                if (this.integrations) {
                    setTimeout(() => this.updateIntegrationUI(), 100);
                }
                
                // Update journal streak after loading
                this.updateJournalStreak();
            }
            
            // Parse ability description to separate experiential and mechanical parts
            parseAbilityDescription(description) {
                console.log('Parsing description:', description);
                
                // Split by "Habit Effect:" to separate sections
                const parts = description.split('Habit Effect:');
                
                if (parts.length < 2) {
                    // No mechanical details, return as-is
                    console.log('No Habit Effect found, returning as experiential only');
                    return {
                        experiential: description,
                        mechanical: null
                    };
                }
                
                const experiential = parts[0].trim();
                const mechanicalFull = parts[1].trim();
                
                // Split the mechanical part at "RPG:" if it exists
                const mechanicalParts = mechanicalFull.split('RPG:');
                const mechanicalHabit = mechanicalParts[0].trim();
                const mechanicalRPG = mechanicalParts.length > 1 ? mechanicalParts[1].trim() : null;
                
                const result = {
                    experiential: experiential || "Strengthens your character and capabilities.",
                    mechanical: {
                        habit: mechanicalHabit,
                        rpg: mechanicalRPG
                    }
                };
                
                console.log('Parsed result:', result);
                return result;
            }
            
            // Open skill tree modal
            openSkillTree(skillName) {
                const modal = document.getElementById('skillTreeModal');
                const skillTrees = this.getSkillTrees();
                const skillData = skillTrees[skillName];
                const currentLevel = this.skills[skillName].level;
                
                // Update modal title
                document.getElementById('skillTreeTitle').textContent = `${skillData.name} Skill Tree`;
                document.getElementById('skillTreeTitle').style.color = skillData.color;
                
                // Generate ability list grouped by tiers
                const content = document.getElementById('skillTreeAbilities');
                content.innerHTML = '';
                
                // Group abilities by tiers (every 10 levels)
                const tiers = {};
                skillData.abilities.forEach(ability => {
                    const tier = Math.floor((ability.level - 1) / 10) + 1;
                    if (!tiers[tier]) tiers[tier] = [];
                    tiers[tier].push(ability);
                });
                
                // Create tier sections
                Object.keys(tiers).forEach(tierNum => {
                    const tierSection = document.createElement('div');
                    tierSection.className = 'tier-section';
                    
                    const tierTitle = document.createElement('div');
                    tierTitle.className = 'tier-title';
                    tierTitle.textContent = `Tier ${tierNum} (Levels ${(tierNum - 1) * 10 + 1}-${tierNum * 10})`;
                    tierSection.appendChild(tierTitle);
                    
                    tiers[tierNum].forEach(ability => {
                        const abilityDiv = document.createElement('div');
                        abilityDiv.className = `ability-item ${currentLevel >= ability.level ? 'unlocked' : 'locked'}`;
                        
                        // Add special styling for milestone and ultimate abilities
                        if (ability.milestone) abilityDiv.classList.add('milestone-ability');
                        if (ability.ultimate) abilityDiv.classList.add('ultimate-ability');
                        
                        // Parse the ability description
                        const parsedDesc = this.parseAbilityDescription(ability.description);
                        
                        // Build the ability HTML
                        let abilityHTML = `
                            <div class="ability-level">Lv${ability.level}</div>
                            <div class="ability-details">
                                <div class="ability-name">${ability.name}</div>
                                <div class="ability-description">${parsedDesc.experiential}</div>
                        `;
                        
                        // Add mechanical details section if they exist
                        if (parsedDesc.mechanical && (parsedDesc.mechanical.habit || parsedDesc.mechanical.rpg)) {
                            const isVisible = this.settings.showMechanicalDetails ? 'show' : '';
                            abilityHTML += `
                                <div class="ability-mechanical-details ${isVisible}">
                                    ${parsedDesc.mechanical.habit ? `<div class="mechanical-benefit">🎯 ${parsedDesc.mechanical.habit}</div>` : ''}
                                    ${parsedDesc.mechanical.rpg ? `<div class="mechanical-detail">⚔️ ${parsedDesc.mechanical.rpg}</div>` : ''}
                                </div>
                            `;
                        }
                        
                        abilityHTML += `
                            </div>
                        `;
                        
                        abilityDiv.innerHTML = abilityHTML;
                        tierSection.appendChild(abilityDiv);
                    });
                    
                    content.appendChild(tierSection);
                });
                
                // Add milestone rewards section
                const milestoneSection = document.createElement('div');
                milestoneSection.className = 'milestone-rewards';
                const milestoneTitle = document.createElement('div');
                milestoneTitle.className = 'milestone-title';
                milestoneTitle.textContent = '🏆 Global Milestone Rewards';
                milestoneSection.appendChild(milestoneTitle);
                
                this.getMilestoneRewards().forEach(reward => {
                    const rewardDiv = document.createElement('div');
                    rewardDiv.className = `ability-item ${this.getAllSkillsAtLevel(reward.level) ? 'unlocked' : 'locked'}`;
                    
                    const parsedDesc = this.parseAbilityDescription(reward.description);
                    
                    let rewardHTML = `
                        <div class="ability-level">All ${reward.level}</div>
                        <div class="ability-details">
                            <div class="ability-name">${reward.title}</div>
                            <div class="ability-description">${parsedDesc.experiential}</div>
                    `;
                    
                    // Add mechanical details section if they exist
                    if (parsedDesc.mechanical && (parsedDesc.mechanical.habit || parsedDesc.mechanical.rpg)) {
                        const isVisible = this.settings.showMechanicalDetails ? 'show' : '';
                        rewardHTML += `
                            <div class="ability-mechanical-details ${isVisible}">
                                ${parsedDesc.mechanical.habit ? `<div class="mechanical-benefit">🎯 ${parsedDesc.mechanical.habit}</div>` : ''}
                                ${parsedDesc.mechanical.rpg ? `<div class="mechanical-detail">⚔️ ${parsedDesc.mechanical.rpg}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    rewardHTML += `
                        </div>
                    `;
                    
                    rewardDiv.innerHTML = rewardHTML;
                    milestoneSection.appendChild(rewardDiv);
                });
                
                content.appendChild(milestoneSection);
                
                modal.style.display = 'block';
            }
            
            // Close skill tree modal
            closeSkillTree() {
                document.getElementById('skillTreeModal').style.display = 'none';
            }
            
            // Check if all skills are at a certain level
            getAllSkillsAtLevel(targetLevel) {
                return Object.values(this.skills).every(skill => skill.level >= targetLevel);
            }
            
            // Integration System Methods
            toggleIntegration(appName) {
                const integration = this.integrations[appName];
                if (!integration) return;
                
                if (integration.connected) {
                    // Disconnect
                    integration.connected = false;
                    integration.lastSync = null;
                    this.showIntegrationMessage(`❌ Disconnected from ${this.getAppDisplayName(appName)}`);
                } else {
                    // Simulate connection process
                    this.showIntegrationMessage(`🔗 Connecting to ${this.getAppDisplayName(appName)}...`);
                    
                    // Simulate OAuth/API connection delay
                    setTimeout(() => {
                        integration.connected = true;
                        integration.lastSync = new Date().toISOString();
                        this.showIntegrationMessage(`✅ Connected to ${this.getAppDisplayName(appName)}! Auto-sync enabled.`);
                        this.updateIntegrationUI();
                        this.saveData();
                        
                        // Simulate initial sync with some demo activities
                        setTimeout(() => {
                            this.simulateIntegrationSync(appName);
                        }, 2000);
                    }, 1500);
                }
                
                this.updateIntegrationUI();
                this.saveData();
            }
            
            // Simple message method for integration notifications
            showIntegrationMessage(messageText) {
                const container = document.getElementById('message-container');
                const message = document.createElement('div');
                message.className = 'message';
                message.innerHTML = messageText;
                container.appendChild(message);
                
                // Also add to dashboard notifications
                this.addNotification(messageText, 'info');
                
                // Auto-remove after 4 seconds
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 4000);
            }
            
            getAppDisplayName(appName) {
                const displayNames = {
                    strava: 'Strava',
                    fitbit: 'Fitbit',
                    garmin: 'Garmin Connect',
                    'apple-health': 'Apple Health',
                    myfitnesspal: 'MyFitnessPal',
                    toggl: 'Toggl Track',
                    notion: 'Notion',
                    'rescue-time': 'RescueTime',
                    forest: 'Forest App',
                    goodreads: 'Goodreads',
                    headspace: 'Headspace',
                    calm: 'Calm',
                    'insight-timer': 'Insight Timer',
                    discord: 'Discord',
                    meetup: 'Meetup',
                    linkedin: 'LinkedIn',
                    github: 'GitHub',
                    spotify: 'Spotify',
                    dribbble: 'Dribbble',
                    behance: 'Behance'
                };
                return displayNames[appName] || appName;
            }
            
            updateIntegrationUI() {
                Object.keys(this.integrations).forEach(appName => {
                    const integration = this.integrations[appName];
                    const btn = document.getElementById(`${appName}-btn`);
                    const status = document.getElementById(`${appName}-status`);
                    
                    if (btn && status) {
                        if (integration.connected) {
                            btn.classList.add('connected');
                            status.textContent = 'Connected';
                            status.classList.add('connected');
                        } else {
                            btn.classList.remove('connected');
                            status.textContent = 'Connect';
                            status.classList.remove('connected');
                        }
                    }
                });
            }
            
            // Simulate automatic activity sync from connected apps
            simulateIntegrationSync(appName) {
                const integration = this.integrations[appName];
                if (!integration.connected) return;
                
                // Define verification levels and bypass capabilities
                const integrationVerification = {
                    // TIER 1: HARDWARE VERIFIED (Can bypass daily limits)
                    strava: { 
                        tier: 'verified', 
                        bypassLimits: true, 
                        activity: () => this.logVerifiedActivity('power', 'GPS-tracked cycling ride', 45, 7, 'normal', 'strava'),
                        reason: 'GPS and heart rate verified'
                    },
                    fitbit: { 
                        tier: 'verified', 
                        bypassLimits: true, 
                        activity: () => this.logVerifiedActivity('power', 'Step counter verified walk', 35, 4, 'normal', 'fitbit'),
                        reason: 'Hardware step/heart rate tracking'
                    },
                    garmin: { 
                        tier: 'verified', 
                        bypassLimits: true, 
                        activity: () => this.logVerifiedActivity('power', 'GPS-tracked running workout', 30, 8, 'focus', 'garmin'),
                        reason: 'Military-grade GPS and biometrics'
                    },
                    'apple-health': { 
                        tier: 'verified', 
                        bypassLimits: true, 
                        activity: () => this.logVerifiedActivity('power', 'Health app tracked workout', 40, 6, 'normal', 'apple-health'),
                        reason: 'Device sensors and health tracking'
                    },
                    myfitnesspal: { 
                        tier: 'verified', 
                        bypassLimits: 'partial', 
                        activity: () => this.logActivity('power', 'Nutrition tracking and meal prep', 20, 3, 'normal'),
                        reason: 'Consistent calorie and nutrition tracking'
                    },
                    
                    // TIER 2: TIME TRACKED (Can bypass some limits)
                    toggl: { 
                        tier: 'time-tracked', 
                        bypassLimits: 'partial', 
                        activity: () => this.logTimeTrackedActivity('clarity', 'Time-tracked focused work', 90, 7, 'deep_work', 'toggl'),
                        reason: 'Automatic time tracking (can\'t fake duration)'
                    },
                    forest: { 
                        tier: 'time-tracked', 
                        bypassLimits: 'partial', 
                        activity: () => this.logTimeTrackedActivity('clarity', 'Forest app focus session', 25, 8, 'deep_work', 'forest'),
                        reason: 'App-enforced focus time (phone locked)'
                    },
                    'rescue-time': { 
                        tier: 'time-tracked', 
                        bypassLimits: 'partial', 
                        activity: () => this.logTimeTrackedActivity('clarity', 'Productive computer work', 120, 6, 'deep_work', 'rescue-time'),
                        reason: 'Automatic computer activity tracking'
                    },
                    goodreads: { 
                        tier: 'verified', 
                        bypassLimits: 'partial', 
                        activity: () => this.logActivity('clarity', 'Reading progress logged', 45, 5, 'reading'),
                        reason: 'Reading progress and book completion tracking'
                    },
                    
                    // TIER 3: MEDITATION & WELLNESS VERIFIED
                    headspace: { 
                        tier: 'verified', 
                        bypassLimits: 'partial', 
                        activity: () => this.logActivity('balance', 'Guided meditation session', 15, 8, 'mindfulness'),
                        reason: 'Guided meditation completion verified'
                    },
                    calm: { 
                        tier: 'verified', 
                        bypassLimits: 'partial', 
                        activity: () => this.logActivity('balance', 'Sleep story or meditation', 20, 7, 'mindfulness'),
                        reason: 'App-guided wellness session'
                    },
                    'insight-timer': { 
                        tier: 'verified', 
                        bypassLimits: 'partial', 
                        activity: () => this.logActivity('balance', 'Meditation timer session', 25, 8, 'mindfulness'),
                        reason: 'Timer-based meditation tracking'
                    },
                    
                    // TIER 4: SOCIAL VERIFICATION
                    discord: { 
                        tier: 'social', 
                        bypassLimits: false, 
                        activity: () => this.logActivity('spirit', 'Community interaction on Discord', 30, 4, 'social'),
                        reason: 'Active community participation'
                    },
                    meetup: { 
                        tier: 'verified', 
                        bypassLimits: 'partial', 
                        activity: () => this.logActivity('spirit', 'Attended meetup event', 120, 8, 'group'),
                        reason: 'RSVP and check-in verified'
                    },
                    linkedin: { 
                        tier: 'social', 
                        bypassLimits: false, 
                        activity: () => this.logActivity('spirit', 'Professional networking', 25, 3, 'social'),
                        reason: 'Professional engagement tracking'
                    },
                    
                    // TIER 5: CREATIVE VERIFICATION
                    github: { 
                        tier: 'verified', 
                        bypassLimits: 'partial', 
                        activity: () => this.logActivity('harmony', 'Code commits and development', 90, 7, 'creative'),
                        reason: 'Git commits and code contributions'
                    },
                    spotify: { 
                        tier: 'social', 
                        bypassLimits: false, 
                        activity: () => this.logActivity('harmony', 'Music practice or creation', 45, 4, 'creative'),
                        reason: 'Music listening and playlist curation'
                    },
                    dribbble: { 
                        tier: 'social', 
                        bypassLimits: false, 
                        activity: () => this.logActivity('harmony', 'Design work posted', 60, 6, 'creative'),
                        reason: 'Design portfolio updates'
                    },
                    behance: { 
                        tier: 'social', 
                        bypassLimits: false, 
                        activity: () => this.logActivity('harmony', 'Creative project showcase', 75, 6, 'creative'),
                        reason: 'Professional creative work display'
                    }
                };
                
                const syncConfig = integrationVerification[appName];
                if (syncConfig && syncConfig.activity) {
                    syncConfig.activity();
                    integration.lastSync = new Date().toISOString();
                    
                    // Show different messages based on verification level
                    let syncMessage = `🔄 Auto-synced from ${this.getAppDisplayName(appName)}`;
                    if (syncConfig.tier === 'verified') {
                        syncMessage += ` ✅ (Hardware verified - bypass limits)`;
                    } else if (syncConfig.tier === 'time-tracked') {
                        syncMessage += ` ⏱️ (Time tracked - partial bypass)`;
                    } else {
                        syncMessage += ` ⚠️ (Self-reported - full limits apply)`;
                    }
                    
                    this.showIntegrationMessage(syncMessage);
                }
            }
            
            // Start automatic sync check every 5 minutes
            startAutoSync() {
                setInterval(() => {
                    this.checkForIntegrationUpdates();
                }, 5 * 60 * 1000); // 5 minutes
            }
            
            checkForIntegrationUpdates() {
                Object.keys(this.integrations).forEach(appName => {
                    const integration = this.integrations[appName];
                    if (integration.connected) {
                        // Simulate random chance of new activity (10% chance every 5 minutes)
                        if (Math.random() < 0.1) {
                            this.simulateIntegrationSync(appName);
                        }
                    }
                });
            }
            
            // Method called by sync functions - alias for render()
            updateDisplay() {
                this.render();
                this.renderDashboard();
                this.updateIntegrationStatus();
                
                // Update journal displays if journal tab is active
                const journalTab = document.getElementById('journal-tab');
                if (journalTab && journalTab.classList.contains('active')) {
                    this.renderJournalPrompt();
                    this.renderTodayEntries();
                    this.renderJournalStats();
                }
            }
            
            // Update integration connection status indicators
            updateIntegrationStatus() {
                Object.keys(this.integrations).forEach(appName => {
                    const integration = this.integrations[appName];
                    const statusElement = document.getElementById(`${appName}-status`);
                    const btnElement = document.getElementById(`${appName}-btn`);
                    
                    if (statusElement && btnElement) {
                        if (integration.connected) {
                            statusElement.textContent = 'Connected';
                            statusElement.classList.add('connected');
                            btnElement.classList.add('connected');
                        } else {
                            statusElement.textContent = 'Connect';
                            statusElement.classList.remove('connected');
                            btnElement.classList.remove('connected');
                        }
                    }
                });
            }
            
            // ========================================
            // JOURNAL SYSTEM
            // ========================================
            
            // Get the current journal prompt based on time of day
            getCurrentPrompt() {
                const now = new Date();
                const hour = now.getHours();
                
                // Morning prompt (5 AM - 11:59 AM)
                if (hour >= 5 && hour < 12) {
                    return {
                        type: 'morning',
                        time: '🌅 Morning',
                        title: 'Morning Intention Setting',
                        prompt: 'What are the 3 most important things you want to accomplish today, and why do they matter to you? How are you feeling right now?'
                    };
                }
                
                // Midday prompt (12 PM - 5:59 PM)
                if (hour >= 12 && hour < 18) {
                    return {
                        type: 'midday',
                        time: '☀️ Midday',
                        title: 'Midday Check-in',
                        prompt: 'How is your energy and focus right now? What\'s working well today, and what adjustments might help you finish strong?'
                    };
                }
                
                // Evening prompt (6 PM - 4:59 AM)
                return {
                    type: 'evening',
                    time: '🌙 Evening',
                    title: 'Evening Reflection',
                    prompt: 'What are you most grateful for today? What did you learn about yourself, and how did you grow? What would you do differently?'
                };
            }
            
            // Submit a journal entry
            submitJournalEntry(promptType, promptTitle, entryText) {
                // Enhanced content validation
                if (!entryText || entryText.trim().length < 20) {
                    this.addNotification('❌ Please write at least 20 characters for a meaningful reflection.');
                    if (window.showJournalNotification) {
                        window.showJournalNotification('❌ Please write at least 20 characters for a meaningful reflection.', 'error');
                    }
                    return false;
                }
                
                // Check for meaningful content (not just repeated characters)
                const cleanText = entryText.trim().toLowerCase();
                const words = cleanText.split(/\s+/).filter(word => word.length > 1);
                const uniqueWords = new Set(words);
                
                if (words.length < 5) {
                    this.addNotification('❌ Please write at least 5 words for a meaningful reflection.');
                    if (window.showJournalNotification) {
                        window.showJournalNotification('❌ Please write at least 5 words for a meaningful reflection.', 'error');
                    }
                    return false;
                }
                
                if (uniqueWords.size < 3) {
                    this.addNotification('❌ Please write more varied content. Avoid repeating the same words.');
                    if (window.showJournalNotification) {
                        window.showJournalNotification('❌ Please write more varied content. Avoid repeating the same words.', 'error');
                    }
                    return false;
                }
                
                // Check for spam patterns (repeated characters)
                const repeatedPattern = /(.)\1{4,}/; // 5 or more of the same character in a row
                if (repeatedPattern.test(cleanText)) {
                    this.addNotification('❌ Please avoid spam-like content. Write meaningful reflections.');
                    if (window.showJournalNotification) {
                        window.showJournalNotification('❌ Please avoid spam-like content. Write meaningful reflections.', 'error');
                    }
                    return false;
                }
                
                const now = new Date();
                const today = now.toDateString();
                
                // Check daily limits - only allow 3 entries per day (one per time period)
                const todayEntries = this.journalEntries.filter(entry => entry.date === today);
                
                // Check if user already completed this specific prompt type today
                const existingEntry = todayEntries.find(entry => entry.promptType === promptType);
                if (existingEntry) {
                    this.addNotification(`✅ You've already completed your ${promptType} reflection today! Try again tomorrow or during a different time period.`);
                    if (window.showJournalNotification) {
                        window.showJournalNotification(`✅ You've already completed your ${promptType} reflection today! Try again tomorrow or during a different time period.`, 'error');
                    }
                    return false;
                }
                
                // Check if user has reached daily limit of 3 entries
                if (todayEntries.length >= 3) {
                    this.addNotification('📚 Daily journal limit reached! You\'ve completed all 3 time periods (morning, midday, evening). Come back tomorrow!');
                    if (window.showJournalNotification) {
                        window.showJournalNotification('📚 Daily journal limit reached! You\'ve completed all 3 time periods (morning, midday, evening). Come back tomorrow!', 'error');
                    }
                    return false;
                }
                
                // Calculate word count and XP
                const wordCount = entryText.trim().split(/\s+/).length;
                const baseXP = 50; // Base XP for reflection
                const wordBonus = Math.min(Math.floor(wordCount / 10) * 5, 25); // +5 XP per 10 words, max +25
                const finalXP = baseXP + wordBonus;
                
                // Create journal entry
                const journalEntry = {
                    id: Date.now().toString(),
                    date: today,
                    timestamp: now.toISOString(),
                    promptType: promptType,
                    promptTitle: promptTitle,
                    entryText: entryText.trim(),
                    wordCount: wordCount,
                    xpGained: finalXP
                };
                
                // Add entry
                this.journalEntries.unshift(journalEntry); // Add to beginning
                
                // Update stats
                this.journalStats.totalEntries++;
                this.journalStats.totalWords += wordCount;
                this.journalStats.totalXP += finalXP;
                
                // Give Clarity XP
                this.skills.clarity.xp += finalXP;
                this.skills.clarity.totalXP += finalXP;
                this.totalXP += finalXP;
                
                // Check for level up
                this.checkLevelUp('clarity');
                
                // Update journal streak
                this.updateJournalStreak();
                
                // Save data
                this.saveData();
                
                // Update displays
                this.updateDisplay();
                
                // Show success message
                this.addNotification(`📖 Reflection complete! +${finalXP} Clarity XP (${wordCount} words)`);
                if (window.showJournalNotification) {
                    window.showJournalNotification(`🎉 Reflection complete! +${finalXP} Clarity XP (${wordCount} words)`, 'success');
                }
                
                // Refresh journal displays
                this.renderJournalPrompt();
                this.renderTodayEntries();
                this.renderJournalStats();
                
                return true;
            }
            
            // Update journal streak
            updateJournalStreak() {
                const today = new Date().toDateString();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();
                
                const hasEntryToday = this.journalEntries.some(entry => entry.date === today);
                const hasEntryYesterday = this.journalEntries.some(entry => entry.date === yesterdayStr);
                
                if (hasEntryToday) {
                    if (hasEntryYesterday || this.journalStreak === 0) {
                        this.journalStreak = Math.max(1, this.journalStreak + 1);
                    }
                } else if (!hasEntryYesterday && this.journalStreak > 0) {
                    this.journalStreak = 0;
                }
            }
            
            // Render current journal prompt
            renderJournalPrompt() {
                const currentPrompt = this.getCurrentPrompt();
                
                const timeElement = document.getElementById('current-prompt-time');
                const titleElement = document.getElementById('current-prompt-title');
                const textElement = document.getElementById('current-prompt-text');
                
                if (timeElement) timeElement.textContent = currentPrompt.time;
                if (titleElement) titleElement.textContent = currentPrompt.title;
                if (textElement) textElement.textContent = currentPrompt.prompt;
                
                // Clear the textarea
                const textArea = document.getElementById('journal-input');
                if (textArea) {
                    textArea.value = '';
                    textArea.setAttribute('data-prompt-type', currentPrompt.type);
                    textArea.setAttribute('data-prompt-title', currentPrompt.title);
                }
                
                // Check if already completed today
                const today = new Date().toDateString();
                const existingEntry = this.journalEntries.find(entry => 
                    entry.date === today && entry.promptType === currentPrompt.type
                );
                
                const submitBtn = document.querySelector('.journal-submit-btn');
                if (existingEntry && submitBtn) {
                    submitBtn.textContent = '✅ Already completed today';
                    submitBtn.disabled = true;
                } else if (submitBtn) {
                    submitBtn.textContent = '💫 Submit Reflection (+50 Clarity XP)';
                    submitBtn.disabled = false;
                }
            }
            
            // Render today's entries
            renderTodayEntries() {
                const today = new Date().toDateString();
                const todayEntries = this.journalEntries.filter(entry => entry.date === today);
                const container = document.getElementById('today-entries');
                
                // Update daily progress indicators
                this.updateDailyProgress(todayEntries);
                
                if (!container) return;
                
                if (todayEntries.length === 0) {
                    container.innerHTML = `
                        <div class="journal-empty-state">
                            <div class="journal-empty-icon">✨</div>
                            <div class="journal-empty-text">No entries yet today</div>
                            <div class="journal-empty-subtext">Complete your first reflection to start building clarity!</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = todayEntries.map(entry => `
                        <div class="journal-entry">
                            <div class="journal-entry-header">
                                <div class="journal-entry-prompt">${entry.promptTitle}</div>
                                <div class="journal-entry-date">${new Date(entry.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                            </div>
                            <div class="journal-entry-text">${entry.entryText}</div>
                        </div>
                    `).join('');
                }
            }
            
            // Update daily progress indicators
            updateDailyProgress(todayEntries = null) {
                if (!todayEntries) {
                    const today = new Date().toDateString();
                    todayEntries = this.journalEntries.filter(entry => entry.date === today);
                }
                
                const currentPrompt = this.getCurrentPrompt();
                const completedTypes = new Set(todayEntries.map(entry => entry.promptType));
                
                ['morning', 'midday', 'evening'].forEach(type => {
                    const indicator = document.querySelector(`.time-indicator[data-type="${type}"]`);
                    if (indicator) {
                        const statusEl = indicator.querySelector('.status');
                        indicator.classList.remove('completed', 'current');
                        
                        if (completedTypes.has(type)) {
                            statusEl.textContent = '✓';
                            indicator.classList.add('completed');
                        } else if (currentPrompt.type === type) {
                            statusEl.textContent = '🔥';
                            indicator.classList.add('current');
                        } else {
                            statusEl.textContent = '○';
                        }
                    }
                });
            }
            
            // Render journal stats
            renderJournalStats() {
                const streakElement = document.getElementById('journal-streak');
                const totalElement = document.getElementById('journal-total');
                const xpElement = document.getElementById('journal-xp');
                const wordsElement = document.getElementById('journal-words');
                
                if (streakElement) streakElement.textContent = this.journalStreak;
                if (totalElement) totalElement.textContent = this.journalStats.totalEntries;
                if (xpElement) xpElement.textContent = this.journalStats.totalXP.toLocaleString();
                if (wordsElement) wordsElement.textContent = this.journalStats.totalWords.toLocaleString();
            }
            
            // Filter and render past entries
            filterJournalEntries() {
                const dateFilter = document.getElementById('journal-date-filter')?.value || '7';
                const promptFilter = document.getElementById('journal-prompt-filter')?.value || 'all';
                const container = document.getElementById('past-entries');
                
                if (!container) return;
                
                let filteredEntries = [...this.journalEntries];
                
                // Filter by date
                if (dateFilter !== 'all') {
                    const daysAgo = parseInt(dateFilter);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
                    
                    filteredEntries = filteredEntries.filter(entry => 
                        new Date(entry.timestamp) >= cutoffDate
                    );
                }
                
                // Filter by prompt type
                if (promptFilter !== 'all') {
                    filteredEntries = filteredEntries.filter(entry => 
                        entry.promptType === promptFilter
                    );
                }
                
                // Exclude today's entries (they're shown separately)
                const today = new Date().toDateString();
                filteredEntries = filteredEntries.filter(entry => entry.date !== today);
                
                if (filteredEntries.length === 0) {
                    container.innerHTML = `
                        <div class="journal-empty-state">
                            <div class="journal-empty-icon">📖</div>
                            <div class="journal-empty-text">No past entries found</div>
                            <div class="journal-empty-subtext">Try adjusting your filters or start journaling more!</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = filteredEntries.map(entry => `
                        <div class="journal-entry">
                            <div class="journal-entry-header">
                                <div class="journal-entry-prompt">${entry.promptTitle}</div>
                                <div class="journal-entry-date">${new Date(entry.timestamp).toLocaleDateString()}</div>
                            </div>
                            <div class="journal-entry-text">${entry.entryText}</div>
                        </div>
                    `).join('');
                }
            }
            
            // Log verified activity (hardware-tracked like Strava, Fitbit, Garmin)
            // These bypass most limits but still have anti-abuse protections
            logVerifiedActivity(skill, activity, duration, intensity, activityType, source) {
                console.log(`🔐 Verified activity from ${source}:`, { skill, activity, duration, intensity, activityType });
                
                // Check basic global limits for verified activities (very relaxed)
                const globalLimits = this.checkGlobalDailyLimits('verified');
                if (!globalLimits.canLog) {
                    this.addNotification(`🚫 ${globalLimits.reason}`);
                    return { success: false, reason: 'verified_global_limit' };
                }
                
                // Basic validation still applies
                if (duration < 5 || duration > 480 || intensity < 1 || intensity > 10) { // Allow up to 8 hours for verified
                    this.addNotification('🚫 Verified activity failed basic validation (5-480 min, intensity 1-10)');
                    return { success: false, reason: 'verified_validation' };
                }
                
                // Calculate XP using the standard formula
                const baseXP = Math.floor(duration * intensity * 0.8);
                const bonusMultiplier = this.getStreakMultiplier();
                const finalXP = Math.floor(baseXP * bonusMultiplier);
                
                // Add XP directly - minimal limits for verified activities
                this.skills[skill].xp += finalXP;
                this.skills[skill].totalXP += finalXP;
                this.totalXP += finalXP;
                
                // Check for level ups
                this.checkLevelUp(skill);
                
                // Track activity for stats AND global limits (verified activities still count toward global totals)
                this.trackActivityTypeUsage(activityType, duration, finalXP, 'verified');
                this.todayActivities.push({
                    skill,
                    activity,
                    duration,
                    intensity,
                    xp: finalXP,
                    timestamp: new Date().toISOString(),
                    type: activityType,
                    source: source,
                    verified: true,
                    bypassedLimits: true
                });
                
                // Update displays
                this.updateDisplay();
                this.saveData();
                
                // Special notification for verified activities
                this.addNotification(`🔐 ${source.toUpperCase()}: +${finalXP} XP (${skill}) - Verified bypass!`);
                
                // Update streak since this counts as valid activity
                this.updateStreak();
                
                return { success: true, xp: finalXP, bypassed: true };
            }
            
            // Log time-tracked activity (Toggl, Forest app, Headspace, etc.)
            // These have partial bypass - reduced limits but still some restrictions
            logTimeTrackedActivity(skill, activity, duration, intensity, activityType, source) {
                console.log(`⏱️ Time-tracked activity from ${source}:`, { skill, activity, duration, intensity, activityType });
                
                const today = new Date().toDateString();
                
                // Check global limits for time-tracked activities (relaxed)
                const globalLimits = this.checkGlobalDailyLimits('time-tracked');
                if (!globalLimits.canLog) {
                    this.addNotification(`🚫 ${globalLimits.reason}`);
                    return { success: false, reason: 'time_tracked_global_limit' };
                }
                
                // Relaxed limits for time-tracked activities (50% more generous than normal)
                const relaxedRestrictions = {
                    'deep_work': { max: 3, cooldown: 90, maxDuration: 270 }, // Instead of 2, 180min, 180min
                    'focus': { max: 4, cooldown: 60, maxDuration: 240 },     // Instead of 3, 90min, 180min  
                    'mindfulness': { max: 4, cooldown: 30, maxDuration: 180 }, // New category for meditation
                    'learning': { max: 4, cooldown: 45, maxDuration: 240 }   // Instead of 3, 60min, 180min
                };
                
                // Check time-tracked specific limits
                const restriction = relaxedRestrictions[activityType];
                if (restriction) {
                    const usageKey = `activity_usage_${activityType}_${today}`;
                    const durationKey = `activity_duration_${activityType}_${today}`;
                    const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
                    const currentDuration = parseInt(localStorage.getItem(durationKey) || '0');
                    
                    // Check count limit (relaxed)
                    if (currentUsage >= restriction.max) {
                        const message = `⏱️ TIME-TRACKED LIMIT REACHED!\n\n📊 ${activityType.replace('_', ' ').toUpperCase()} Usage:\n• Count: ${currentUsage}/${restriction.max} (relaxed limit for time-tracked)\n• Duration: ${Math.floor(currentDuration / 60)}h ${currentDuration % 60}m\n\n🚫 Even time-tracked activities have realistic limits!\n\n💡 Try a different activity type or take a break.`;
                        alert(message);
                        this.addNotification(`⏱️ ${activityType} daily limit reached (time-tracked)`);
                        return { success: false, reason: 'time_tracked_limit' };
                    }
                    
                    // Check duration limit (relaxed)
                    if (currentDuration + duration > restriction.maxDuration) {
                        const remaining = restriction.maxDuration - currentDuration;
                        const message = `⏱️ TIME-TRACKED DURATION LIMIT!\n\n📊 ${activityType.replace('_', ' ').toUpperCase()} Duration:\n• Current: ${Math.floor(currentDuration / 60)}h ${currentDuration % 60}m\n• Requesting: ${Math.floor(duration / 60)}h ${duration % 60}m\n• Daily limit: ${Math.floor(restriction.maxDuration / 60)}h ${restriction.maxDuration % 60}m\n• Remaining: ${Math.floor(remaining / 60)}h ${remaining % 60}m\n\n💡 Time-tracked activities get extra time but still have realistic limits!`;
                        alert(message);
                        this.addNotification(`⏱️ ${activityType} duration limit exceeded (time-tracked)`);
                        return { success: false, reason: 'time_tracked_duration' };
                    }
                }
                
                // Calculate XP with time-tracked bonus
                const baseXP = Math.floor(duration * intensity * 0.9); // 10% bonus for being time-tracked
                const bonusMultiplier = this.getStreakMultiplier();
                const finalXP = Math.floor(baseXP * bonusMultiplier);
                
                // Add XP
                this.skills[skill].xp += finalXP;
                this.skills[skill].totalXP += finalXP;
                this.totalXP += finalXP;
                
                // Check for level ups
                this.checkLevelUp(skill);
                
                // Update usage tracking (time-tracked activities count toward global limits)
                if (restriction) {
                    const usageKey = `activity_usage_${activityType}_${today}`;
                    const durationKey = `activity_duration_${activityType}_${today}`;
                    const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
                    const currentDuration = parseInt(localStorage.getItem(durationKey) || '0');
                    
                    localStorage.setItem(usageKey, (currentUsage + 1).toString());
                    localStorage.setItem(durationKey, (currentDuration + duration).toString());
                }
                
                // Track global usage
                this.trackActivityTypeUsage(activityType, duration, finalXP, 'time-tracked');
                
                // Track activity
                this.todayActivities.push({
                    skill,
                    activity,
                    duration,
                    intensity,
                    xp: finalXP,
                    timestamp: new Date().toISOString(),
                    type: activityType,
                    source: source,
                    timeTracked: true,
                    relaxedLimits: true
                });
                
                // Update displays
                this.updateDisplay();
                this.saveData();
                
                // Special notification for time-tracked activities
                this.addNotification(`⏱️ ${source.toUpperCase()}: +${finalXP} XP (${skill}) - Time-tracked!`);
                
                // Update streak
                this.updateStreak();
                
                return { success: true, xp: finalXP, timeTracked: true };
            }
            
            // ===== LORE SYSTEM METHODS =====
            
            initializeLoreSystem() {
                // Initialize lore data if not exists
                if (!this.loreData) {
                    this.loreData = {
                        currentDay: 1,
                        totalRead: 0,
                        xpEarned: 0,
                        streak: 0,
                        maxStreak: 0,
                        lastReadDate: null,
                        completedCycles: 0,
                        unlockedContent: []
                    };
                }
                
                // Load and render lore
                this.updateLoreDisplay();
            }
            
            getLoreEntry(day) {
                const loreEntries = [
                    { 
                        title: "The World Before", 
                        content: "Once, Vitalon thrived. People pursued dreams with joy, not desperation. Athletes trained for the love of movement. Scholars studied to satisfy curiosity. Artists created because beauty demanded existence. Communities gathered because humans are meant to connect. Then someone decided that suffering was a problem to be solved, not a teacher to be heard.",
                        hint: "Your real-world curiosity grants Clarity XP just as it did in old Vitalon",
                        quiz: {
                            question: "What was the key difference between old Vitalon and later times?",
                            options: [
                                "People were stronger and smarter",
                                "People pursued dreams with joy, not desperation", 
                                "There were more resources available",
                                "Technology was more advanced"
                            ],
                            correct: 1
                        }
                    },
                    { 
                        title: "The Brilliant Dr. Khorvast", 
                        content: "Valen Khorvast watched his mother fade after his father's death. Her artist hands grew still. Her bright eyes dimmed. At twelve, he swore no one should suffer from lost purpose. He became Vitalon's youngest doctorate at 23, founded the Institute of Human Potential at 30. Everyone called him brilliant. No one called him happy.",
                        hint: "Intense motivation often hides deep pain. Balance your drive with self-compassion",
                        quiz: {
                            question: "What motivated Dr. Khorvast to create the Institute?",
                            options: [
                                "Fame and recognition",
                                "Scientific curiosity", 
                                "Watching his mother fade after losing purpose",
                                "Government funding"
                            ],
                            correct: 2
                        }
                    },
                    { 
                        title: "Project Ascension", 
                        content: "\"We can measure purpose,\" Dr. Elena Winters announced. \"We can amplify it. We can share it.\" The Institute's breakthrough promised to end depression forever. No more listlessness. No more existential dread. No more humans failing to reach potential. The government funded it immediately. The public demanded it desperately. Only one researcher asked, \"Should we?\"",
                        hint: "Quick fixes to deep problems often create deeper problems",
                        quiz: {
                            question: "What was Project Ascension's main promise?",
                            options: [
                                "To make people stronger",
                                "To end depression forever",
                                "To increase intelligence", 
                                "To extend human lifespan"
                            ],
                            correct: 1
                        }
                    },
                    { 
                        title: "The Day of Silence", 
                        content: "Dr. Khorvast was presenting Project Ascension's launch when he stopped mid-sentence. \"Why am I speaking?\" he asked the crowd. Then quieter: \"Why am I breathing?\" Within minutes, the auditorium fell silent. Within hours, the city. The cure for purposelessness had inverted, becoming a plague that drained all purpose. They called it the Languor.",
                        hint: "The Institute ruins hold powerful items, but beware the lingering Languor fields",
                        quiz: {
                            question: "What did they call the plague that drained all purpose?",
                            options: [
                                "The Silence",
                                "The Void",
                                "The Languor",
                                "The Emptiness"
                            ],
                            correct: 2
                        }
                    },
                    { 
                        title: "The Sixteen Who Stood", 
                        content: "When Meridian fell, sixteen people kept moving. Not from immunity, but from habit too strong to break. Valen's 4 AM workouts. Darius's Olympic training. Elena's note-taking. Seraphina's meditation. They found each other in the only lit building - a gym where Valen mindlessly lifted weights with dead eyes. Together, they discovered something: purpose isn't why you act. It's what happens when you do.",
                        hint: "Consistency in small actions builds resistance to greater challenges",
                        quiz: {
                            question: "How many people initially resisted the Languor?",
                            options: [
                                "Twelve",
                                "Sixteen", 
                                "Twenty",
                                "Eight"
                            ],
                            correct: 1
                        }
                    }
                    // I'll add more entries in the next part to keep this manageable
                ];
                
                // Add remaining entries (Days 6-30)
                const remainingEntries = [
                    { 
                        title: "The First Discipline - Power", 
                        content: "Darius Ward, Olympic weightlifter, made the first breakthrough. \"The body doesn't care about meaning,\" he said, mid-squat. \"It just knows: lift or be crushed.\" Physical training became the First Discipline. Not to become strong, but because the act of trying created strength. Every rep was a tiny rebellion against the Languor's whisper of \"why bother?\"",
                        hint: "Your morning workout is literally fighting off supernatural depression",
                        quiz: {
                            question: "Who developed the First Discipline of Power?",
                            options: ["Valen Khorvast", "Darius Ward", "Elena Winters", "Seraphina Zhou"],
                            correct: 1
                        }
                    },
                    { 
                        title: "The Second Discipline - Clarity", 
                        content: "Aureus Bright was organizing books when the Languor hit. He kept organizing because his autistic mind needed order. In that need, he found power. \"Learn something, anything,\" he taught. \"Not because it matters, but because learning itself is the point.\" Knowledge became armor against the fog of purposelessness.",
                        hint: "Reading these entries at the same time daily builds stronger streak bonuses",
                        quiz: {
                            question: "What became 'armor against the fog of purposelessness'?",
                            options: ["Physical strength", "Knowledge", "Meditation", "Social connection"],
                            correct: 1
                        }
                    }
                ];
                
                // Combine arrays
                const allEntries = [...loreEntries, ...remainingEntries];
                
                // Add generic entries for remaining days (to be filled out later)
                while (allEntries.length < 30) {
                    const dayNum = allEntries.length + 1;
                    allEntries.push({
                        title: `Chronicle ${dayNum}`,
                        content: "More chronicles are being prepared by the scribes of Vitalon. Return tomorrow for new wisdom.",
                        hint: "Patience is a virtue valued in all realms",
                        quiz: {
                            question: "What virtue is valued in all realms?",
                            options: ["Strength", "Speed", "Patience", "Intelligence"],
                            correct: 2
                        }
                    });
                }
                
                return allEntries[day - 1] || allEntries[29]; // Default to Day 30 if beyond range
            }
            
            updateLoreDisplay() {
                // Update day counter and streak
                document.getElementById('lore-day-counter').textContent = `Day ${this.loreData.currentDay}`;
                document.getElementById('lore-streak-count').textContent = this.loreData.streak;
                
                // Load today's lore entry
                const todayEntry = this.getLoreEntry(this.loreData.currentDay);
                const passageElement = document.getElementById('lore-passage');
                
                if (passageElement) {
                    passageElement.innerHTML = `
                        <h4 style="color: #3498db; margin-bottom: 15px;">Day ${this.loreData.currentDay}: ${todayEntry.title}</h4>
                        <div style="margin-bottom: 20px; line-height: 1.6;">${todayEntry.content}</div>
                        <div style="font-style: italic; color: #f39c12; padding: 10px; background: rgba(243, 156, 18, 0.1); border-radius: 8px; border-left: 3px solid #f39c12;">
                            💡 <strong>Hint:</strong> ${todayEntry.hint}
                        </div>
                    `;
                }
                
                // Update stats
                document.getElementById('lore-total-read').textContent = this.loreData.totalRead;
                document.getElementById('lore-xp-earned').textContent = this.loreData.xpEarned.toLocaleString();
                document.getElementById('lore-max-streak').textContent = this.loreData.maxStreak;
                document.getElementById('lore-cycle-progress').textContent = `${this.loreData.currentDay}/30`;
                
                // Update read button state
                this.updateLoreButtonState();
                
                // Show unlock section if there are unlocks
                if (this.loreData.unlockedContent.length > 0) {
                    document.getElementById('lore-unlocks').style.display = 'block';
                    this.renderUnlockedContent();
                }
                
                // Show welcome message for first-time visitors
                if (this.loreData.totalRead === 0) {
                    setTimeout(() => {
                        this.addNotification('📜 Welcome to the Chronicles of Vitalon! Read daily for Clarity XP and deep lore.', 'info');
                    }, 500);
                }
            }
            
            updateLoreButtonState() {
                const readBtn = document.getElementById('lore-read-btn');
                const rereadBtn = document.getElementById('lore-reread-btn');
                const quizSection = document.getElementById('lore-quiz');
                const today = new Date().toDateString();
                
                if (readBtn && rereadBtn && quizSection) {
                    if (this.loreData.lastReadDate === today) {
                        // Already read today
                        readBtn.style.display = 'none';
                        rereadBtn.style.display = 'block';
                        quizSection.style.display = 'none';
                    } else {
                        // Can read today
                        readBtn.style.display = 'block';
                        rereadBtn.style.display = 'none';
                        quizSection.style.display = 'none';
                    }
                }
            }
            
            markLoreAsRead() {
                const today = new Date().toDateString();
                
                // Check if already read today
                if (this.loreData.lastReadDate === today) {
                    this.addNotification('📚 You\'ve already gained XP for today\'s chronicle!', 'warning');
                    return;
                }
                
                // Award XP to Clarity skill
                const xpGained = 100;
                this.skills.clarity.xp += xpGained;
                this.skills.clarity.totalXP += xpGained;
                this.totalXP += xpGained;
                
                // Update lore data
                this.loreData.lastReadDate = today;
                this.loreData.totalRead++;
                this.loreData.xpEarned += xpGained;
                
                // Update streak
                this.updateLoreStreak();
                
                // Check for level up
                const levelsGained = this.checkLevelUp('clarity');
                
                // Check for unlocks
                this.checkLoreUnlocks();
                
                // Advance to next day (with cycle)
                this.loreData.currentDay = this.loreData.currentDay >= 30 ? 1 : this.loreData.currentDay + 1;
                
                // Save and update display
                this.saveData();
                this.updateDisplay();
                this.updateLoreDisplay();
                
                // Show notification
                this.addNotification(`📜 Chronicle completed! +${xpGained} Clarity XP (Streak: ${this.loreData.streak})`, 'success');
                
                if (levelsGained > 0) {
                    this.addNotification(`🎉 Clarity leveled up to ${this.skills.clarity.level}!`, 'success');
                }
                
                // Hide quiz
                document.getElementById('lore-quiz').style.display = 'none';
            }
            
            showLoreQuiz() {
                const quizSection = document.getElementById('lore-quiz');
                const todayEntry = this.getLoreEntry(this.loreData.currentDay);
                
                if (!todayEntry.quiz) {
                    // No quiz for this entry, just mark as read
                    this.markLoreAsRead();
                    return;
                }
                
                // Show quiz
                quizSection.style.display = 'block';
                
                // Set up quiz
                document.getElementById('quiz-question').textContent = todayEntry.quiz.question;
                
                const optionsContainer = document.getElementById('quiz-options');
                optionsContainer.innerHTML = '';
                
                todayEntry.quiz.options.forEach((option, index) => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'quiz-option';
                    optionElement.textContent = option;
                    optionElement.onclick = () => this.selectQuizOption(index, todayEntry.quiz.correct);
                    optionsContainer.appendChild(optionElement);
                });
                
                // Hide result initially
                document.getElementById('quiz-result').style.display = 'none';
                
                // Scroll to quiz
                quizSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            selectQuizOption(selectedIndex, correctIndex) {
                const options = document.querySelectorAll('.quiz-option');
                const resultDiv = document.getElementById('quiz-result');
                
                // Clear previous selections
                options.forEach(opt => {
                    opt.classList.remove('selected', 'correct', 'incorrect');
                });
                
                // Mark selected option
                options[selectedIndex].classList.add('selected');
                
                // Show correct/incorrect results
                if (selectedIndex === correctIndex) {
                    options[selectedIndex].classList.add('correct');
                    resultDiv.className = 'quiz-result correct';
                    resultDiv.innerHTML = '✅ <strong>Correct!</strong> You truly read the chronicle. Claiming your Clarity XP...';
                    resultDiv.style.display = 'block';
                    
                    // Auto-complete after correct answer
                    setTimeout(() => {
                        this.markLoreAsRead();
                    }, 1500);
                } else {
                    options[selectedIndex].classList.add('incorrect');
                    options[correctIndex].classList.add('correct');
                    resultDiv.className = 'quiz-result incorrect';
                    resultDiv.innerHTML = '❌ <strong>Not quite.</strong> Re-read the chronicle carefully and try again.';
                    resultDiv.style.display = 'block';
                    
                    // Hide quiz after a delay to encourage re-reading
                    setTimeout(() => {
                        document.getElementById('lore-quiz').style.display = 'none';
                    }, 3000);
                }
                
                // Disable all options after selection
                options.forEach(opt => {
                    opt.style.pointerEvents = 'none';
                });
            }
            
            rereadLore() {
                // Allow rereading without XP gain
                this.addNotification('📖 Reflecting on today\'s wisdom...', 'info');
            }
            
            updateLoreStreak() {
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (!this.loreData.lastReadDate) {
                    // First time reading
                    this.loreData.streak = 1;
                } else if (this.loreData.lastReadDate === yesterday.toDateString()) {
                    // Consecutive day
                    this.loreData.streak++;
                } else if (this.loreData.lastReadDate !== today.toDateString()) {
                    // Broken streak or same day (reset to 1 for new reading)
                    this.loreData.streak = 1;
                }
                
                // Update max streak
                if (this.loreData.streak > this.loreData.maxStreak) {
                    this.loreData.maxStreak = this.loreData.streak;
                }
            }
            
            checkLoreUnlocks() {
                const unlocks = [];
                
                // Streak-based unlocks
                if (this.loreData.streak >= 7 && !this.loreData.unlockedContent.includes('week_warrior')) {
                    unlocks.push({
                        id: 'week_warrior',
                        title: '📅 Week Warrior',
                        content: 'Completed 7 consecutive days of lore reading. Consistency is the foundation of all growth.',
                        reward: '+5% Clarity XP bonus for one week'
                    });
                }
                
                if (this.loreData.streak >= 30 && !this.loreData.unlockedContent.includes('lore_keeper')) {
                    unlocks.push({
                        id: 'lore_keeper',
                        title: '📚 Lore Keeper',
                        content: 'Mastered the complete 30-day cycle. You now understand the deeper patterns of Vitalon.',
                        reward: '+5% permanent Clarity XP bonus'
                    });
                }
                
                // Total reads unlocks
                if (this.loreData.totalRead >= 60 && !this.loreData.unlockedContent.includes('twice_told')) {
                    unlocks.push({
                        id: 'twice_told',
                        title: '🔄 Twice-Told Tales',
                        content: 'Completed two full cycles. Repetition reveals new truths each time.',
                        reward: 'Access to Hidden Chronicles'
                    });
                }
                
                // Add new unlocks
                unlocks.forEach(unlock => {
                    this.loreData.unlockedContent.push(unlock.id);
                    this.addNotification(`🔓 Unlocked: ${unlock.title}`, 'success');
                });
                
                if (unlocks.length > 0) {
                    this.renderUnlockedContent();
                }
            }
            
            renderUnlockedContent() {
                const container = document.getElementById('lore-unlocks-grid');
                if (!container) return;
                
                const unlockDefinitions = {
                    week_warrior: {
                        title: '📅 Week Warrior',
                        content: 'Completed 7 consecutive days of lore reading. Consistency is the foundation of all growth.',
                        reward: '+5% Clarity XP bonus for one week'
                    },
                    lore_keeper: {
                        title: '📚 Lore Keeper',
                        content: 'Mastered the complete 30-day cycle. You now understand the deeper patterns of Vitalon.',
                        reward: '+5% permanent Clarity XP bonus'
                    },
                    twice_told: {
                        title: '🔄 Twice-Told Tales',
                        content: 'Completed two full cycles. Repetition reveals new truths each time.',
                        reward: 'Access to Hidden Chronicles'
                    }
                };
                
                container.innerHTML = this.loreData.unlockedContent.map(unlockId => {
                    const unlock = unlockDefinitions[unlockId];
                    if (!unlock) return '';
                    
                    return `
                        <div class="lore-unlock-card">
                            <div class="lore-unlock-title">${unlock.title}</div>
                            <div class="lore-unlock-content">
                                <div style="margin-bottom: 8px;">${unlock.content}</div>
                                <div style="font-size: 11px; color: #f39c12; font-weight: bold;">
                                    Reward: ${unlock.reward}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Developer cheat function for testing
            devMaxStats() {
                console.log('🚀 DEV CHEAT: Maxing out all stats for testing...');
                
                // Max out all skills
                Object.keys(this.skills).forEach(skillKey => {
                    this.skills[skillKey].level = 100;
                    this.skills[skillKey].xp = this.xpForLevel(100);
                    this.skills[skillKey].totalXP = this.xpForLevel(100);
                });
                
                // Max out other stats
                this.streak = 365;
                this.consistencyStreak = 365;
                this.totalXP = 50000;
                this.dailyXP = 2000;
                this.todayActivities = 20;
                this.skillsTrained = new Set(['power', 'clarity', 'balance', 'spirit', 'harmony']);
                this.dailyGoalMet = true;
                
                // Max out journal stats
                this.journalStreak = 100;
                this.journalStats.totalEntries = 200;
                this.journalStats.totalWords = 50000;
                this.journalStats.totalXP = 5000;
                
                // Max out lore stats
                this.loreData.currentDay = 30;
                this.loreData.totalRead = 30;
                this.loreData.xpEarned = 3000;
                this.loreData.streak = 30;
                this.loreData.unlockedContent = ['week_warrior', 'lore_keeper', 'twice_told'];
                
                // Force refresh of all displays
                this.renderSkills();
                this.updateActivityTypes();
                this.renderUnlockedContent();
                
                // Update any visible displays
                const event = new Event('resize');
                window.dispatchEvent(event);
                
                this.addNotification('🚀 DEV CHEAT: All stats maxed out! All activity types unlocked.');
                console.log('✅ DEV CHEAT: Complete! Check the Activity tab for all unlocked options.');
            }
        }
        
        const game = new UnbrokenAscent();
        
        // Make game globally accessible
        window.game = game;
        
        // Initialize settings toggle after game loads
        setTimeout(() => {
            const toggle = document.getElementById('show-details-toggle');
            if (toggle && game.settings) {
                toggle.checked = game.settings.showMechanicalDetails;
            }
        }, 100);
        
        // Debug: Check if game loaded properly
        console.log('🎮 Game object created:', game);
        console.log('🔧 Skills available:', Object.keys(game.skills));
        
        function logActivity() {
            try {
                // Safely get DOM elements with error checking
                const skillElement = document.getElementById('skill-select');
                const activityElement = document.getElementById('activity-input');
                const durationElement = document.getElementById('duration-input');
                const intensityElement = document.getElementById('intensity-input');
                const activityTypeElement = document.getElementById('activity-type-select');
                
                if (!skillElement || !activityElement || !durationElement || !intensityElement || !activityTypeElement) {
                    game.addNotification('❌ Form elements not found. Please refresh the page.');
                    return;
                }
                
                const skill = skillElement.value;
                const activity = sanitizeInput(activityElement.value.trim());
                const duration = parseInt(durationElement.value);
                const intensity = parseInt(intensityElement.value);
                const activityType = activityTypeElement.value;
                
                // Get activity type info for validation
                const activityTypeInfo = getActivityTypeInfo(activityType);
                
                // Validate inputs
                if (!activity) {
                    const message = '❌ MISSING ACTIVITY DESCRIPTION!\n\nPlease enter a description of what you did.\n\n💡 Examples:\n• "Morning run in the park"\n• "Reading JavaScript book"\n• "Meditation session"\n• "Guitar practice"';
                    alert(message);
                    game.addNotification('❌ Please enter an activity description!');
                    return;
                }
                
                if (activity.length > 100) {
                    const message = `❌ DESCRIPTION TOO LONG!\n\nYour description is ${activity.length} characters.\nMaximum allowed: 100 characters.\n\n💡 Keep it short and descriptive!`;
                    alert(message);
                    game.addNotification('❌ Activity description too long (max 100 characters)!');
                    return;
                }
                
                // Dynamic duration validation based on activity type
                const minDuration = activityTypeInfo ? activityTypeInfo.minDuration : 3;
                const maxDuration = activityTypeInfo ? activityTypeInfo.maxDuration : 240;
                
                if (isNaN(duration) || duration < minDuration || duration > maxDuration) {
                    const activityName = activityTypeInfo ? activityTypeInfo.label.replace(/^[^\s]+ /, '') : 'this activity';
                    const message = `❌ INVALID DURATION FOR ${activityName.toUpperCase()}!\n\nFor ${activityName}, duration must be between ${minDuration} and ${maxDuration} minutes.\n\n💡 Activity Time Guidelines:\n• ${minDuration}-${Math.min(15, maxDuration)}min = Quick session\n• ${Math.min(15, minDuration)}-${Math.min(30, maxDuration)}min = Standard session\n• ${Math.min(30, minDuration)}-${Math.min(60, maxDuration)}min = Extended session\n• ${Math.min(60, minDuration)}-${maxDuration}min = Deep session`;
                    alert(message);
                    game.addNotification(`❌ Duration must be between ${minDuration} and ${maxDuration} minutes for this activity type!`);
                    return;
                }
                
                // Validate effort level (now 1-4 instead of 1-10)
                if (isNaN(intensity) || intensity < 1 || intensity > 4) {
                    const message = '❌ INVALID EFFORT LEVEL!\n\nEffort level must be between 1 and 4.\n\n💡 Effort Scale:\n• 1 = Easy (light effort, relaxed)\n• 2 = Moderate (steady effort, focused)\n• 3 = Hard (high effort, challenging)\n• 4 = Extreme (maximum effort, peak performance)';
                    alert(message);
                    game.addNotification('❌ Effort level must be between 1 and 4!');
                    return;
                }
                
                // Check minimum effort level for activity type
                const requiredEffort = getRequiredEffortForActivityType(activityType);
                const maxEffort = getMaxEffortForActivityType(activityType);
                
                if (intensity < requiredEffort) {
                    const effortNames = ['', 'Easy', 'Moderate', 'Hard', 'Extreme'];
                    const message = `❌ INSUFFICIENT EFFORT LEVEL!\n\n${activityTypeInfo ? activityTypeInfo.label.replace(/^[^\s]+ /, '') : 'This activity'} requires at least "${effortNames[requiredEffort]}" effort level.\n\nYour selected level: "${effortNames[intensity]}"\nRequired level: "${effortNames[requiredEffort]}" or higher\n\n💡 Higher effort activities provide better rewards!`;
                    alert(message);
                    game.addNotification(`❌ This activity type requires at least ${effortNames[requiredEffort]} effort level!`);
                    return;
                }
                
                if (intensity > maxEffort) {
                    const effortNames = ['', 'Easy', 'Moderate', 'Hard', 'Extreme'];
                    const activityName = activityTypeInfo ? activityTypeInfo.label.replace(/^[^\s]+ /, '') : 'this activity';
                    const message = `❌ UNREALISTIC EFFORT LEVEL!\n\n"${effortNames[intensity]}" effort doesn't make sense for ${activityName}.\n\nMaximum realistic level: "${effortNames[maxEffort]}"\n\n💡 Example: ${getEffortDescription(activityType, maxEffort)}`;
                    alert(message);
                    game.addNotification(`❌ Maximum realistic effort for this activity is ${effortNames[maxEffort]}!`);
                    return;
                }
            
                // Validate activity type matches selected skill
                if (!validateActivityTypeForSkill(skill, activityType)) {
                    const message = `❌ INCOMPATIBLE ACTIVITY TYPE!\n\nThe activity type "${activityType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}" doesn't match the skill "${skill}".\n\n💡 Each skill has specific activity types:\n• Power: Fitness, sports, physical activities\n• Clarity: Mental work, learning, reading\n• Social: Group activities, communication\n• Creative: Art, music, writing projects\n• Grit: Challenging tasks, perseverance\n\nThe dropdown will reset to show valid options.`;
                    alert(message);
                    game.addNotification('❌ Activity type does not match selected skill! Please choose a compatible activity type.');
                    filterActivityTypes(); // Reset the dropdown
                    return;
                }
                
                // Check activity type restrictions before logging
                if (!game.canUseActivityType(activityType, duration, intensity, 'self-reported')) {
                    // Get current status for detailed feedback
                    const today = new Date().toDateString();
                    const globalLimits = game.checkGlobalDailyLimits('self-reported');
                    
                    // Check what specific limit was hit and show detailed popup
                    if (!globalLimits.canLog) {
                        const totalActivities = parseInt(localStorage.getItem(`total_activities_${today}`) || '0');
                        const totalDuration = parseInt(localStorage.getItem(`total_duration_${today}`) || '0');
                        const totalXP = parseInt(localStorage.getItem(`total_xp_${today}`) || '0');
                        const currentHour = new Date().getHours();
                        const hourlyActivities = parseInt(localStorage.getItem(`activities_hour_${today}_${currentHour}`) || '0');
                        
                        const formatTime = (minutes) => {
                            const hours = Math.floor(minutes / 60);
                            const mins = minutes % 60;
                            return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
                        };
                        
                        let detailedMessage = `🚫 DAILY LIMIT REACHED!\n\n${globalLimits.reason}\n\n📊 Your Current Usage Today:\n`;
                        detailedMessage += `• Activities: ${totalActivities}/8 (Focus on quality!)\n`;
                        detailedMessage += `• Total Time: ${formatTime(totalDuration)}/6h (Sustainable pace)\n`;
                        detailedMessage += `• XP Earned: ${totalXP.toLocaleString()}/15,000 (Steady progress)\n`;
                        detailedMessage += `• This Hour: ${hourlyActivities}/3 (Allow focus time)\n\n`;
                        detailedMessage += `🎯 These limits reflect what an average person can realistically sustain.\n\n`;
                        detailedMessage += `💡 Quality over quantity - come back tomorrow refreshed!`;
                        
                        alert(detailedMessage);
                        game.addNotification(`🚫 ${globalLimits.reason}`);
                        return;
                    }
                    
                    // Check if it's a time-based restriction
                    if (!game.validateRealisticTiming(duration)) {
                        const totalDurationToday = parseInt(localStorage.getItem(`total_duration_${today}`) || '0');
                        const hoursClaimedToday = totalDurationToday / 60;
                        const lastActivityTime = localStorage.getItem('last_activity_timestamp');
                        let timeMessage = `⏰ REALISTIC TIMING CHECK!\n\n`;
                        
                        if (hoursClaimedToday + (duration/60) > 8) {
                            timeMessage += `🕐 You've already logged ${hoursClaimedToday.toFixed(1)} hours today.\n`;
                            timeMessage += `Adding ${(duration/60).toFixed(1)}h would exceed our 8-hour daily focus limit.\n\n`;
                            timeMessage += `💡 Average people need time for breaks, meals, sleep, and life!`;
                        } else if (lastActivityTime) {
                            const timeSince = (new Date() - new Date(lastActivityTime)) / (1000 * 60);
                            timeMessage += `⚡ You logged an activity ${timeSince.toFixed(1)} minutes ago.\n`;
                            timeMessage += `Please wait at least 5 minutes between activities.\n\n`;
                            timeMessage += `💡 This allows time to transition, reflect, and prepare for your next activity.`;
                        }
                        
                        alert(timeMessage);
                        game.addNotification('⏰ Realistic timing limits - see popup for details');
                        return;
                    }
                    
                    // Check if it's an intensity fraud issue
                    if (!game.validateIntensityRealism(activityType, duration, intensity)) {
                        let intensityMessage = `🎯 UNREALISTIC INTENSITY!\n\n`;
                        
                        if (intensity >= 9 && duration > 60) {
                            intensityMessage += `🔥 Intensity ${intensity} for ${duration} minutes isn't sustainable for average people.\n`;
                            intensityMessage += `Realistic high-intensity limits:\n`;
                            intensityMessage += `• Intensity 10: Max 30 minutes\n`;
                            intensityMessage += `• Intensity 9: Max 1 hour\n`;
                            intensityMessage += `• Intensity 8: Max 1.5 hours\n\n`;
                            intensityMessage += `💡 Even elite athletes need recovery time!`;
                        } else if (['reading', 'mindfulness', 'learning'].includes(activityType) && intensity > 6) {
                            intensityMessage += `📚 ${activityType.charAt(0).toUpperCase() + activityType.slice(1)} at intensity ${intensity} seems too high.\n`;
                            intensityMessage += `These activities are typically more contemplative:\n`;
                            intensityMessage += `• Reading: Usually intensity 2-6\n`;
                            intensityMessage += `• Mindfulness: Usually intensity 2-5\n`;
                            intensityMessage += `• Learning: Usually intensity 3-7\n\n`;
                            intensityMessage += `💡 High intensity isn't always better - consistency matters more!`;
                        }
                        
                        alert(intensityMessage);
                        game.addNotification('🎯 Unrealistic intensity - see popup for details');
                        return;
                    }
                    
                    // Activity type specific restrictions with current usage
                    const usageKey = `activity_usage_${activityType}_${today}`;
                    const durationKey = `activity_duration_${activityType}_${today}`;
                    const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
                    const currentDuration = parseInt(localStorage.getItem(durationKey) || '0');
                    
                    // Updated realistic restrictions matching the validation system
                    const restrictions = {
                        'normal': { max: 4, cooldown: '20 minutes', maxDuration: 240, skill: 'Power' },
                        'deep_work': { max: 2, cooldown: '3 hours', maxDuration: 180, skill: 'Clarity' },
                        'combo': { max: 1, cooldown: '6 hours', maxDuration: 120, skill: 'Grit' },
                        'group': { max: 2, cooldown: '2 hours', maxDuration: 240, skill: 'Social' },
                        'creative': { max: 3, cooldown: '90 minutes', maxDuration: 240, skill: 'Creative' },
                        'focus': { max: 3, cooldown: '90 minutes', maxDuration: 180, skill: 'Power' },
                        'learning': { max: 3, cooldown: '1 hour', maxDuration: 180, skill: 'Clarity' },
                        'reading': { max: 4, cooldown: '30 minutes', maxDuration: 180, skill: 'Clarity' },
                        'mindfulness': { max: 4, cooldown: '30 minutes', maxDuration: 90, skill: 'Any' },
                        'social': { max: 3, cooldown: '45 minutes', maxDuration: 180, skill: 'Social' }
                    };
                    
                    const restriction = restrictions[activityType] || restrictions['normal'];
                    const activityName = activityType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    let restrictionMessage = `🔒 ${activityName.toUpperCase()} ACTIVITY RESTRICTED!\n\n`;
                    restrictionMessage += `📊 Current Usage Today:\n`;
                    restrictionMessage += `• Count: ${currentUsage}/${restriction.max} activities\n`;
                    
                    if (restriction.maxDuration) {
                        const formatTime = (minutes) => {
                            const hours = Math.floor(minutes / 60);
                            const mins = minutes % 60;
                            return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
                        };
                        restrictionMessage += `• Duration: ${formatTime(currentDuration)}/${formatTime(restriction.maxDuration)}\n`;
                    }
                    
                    const lastUsedKey = `activity_last_${activityType}`;
                    const lastUsed = localStorage.getItem(lastUsedKey);
                    if (lastUsed) {
                        const timeSinceLastUse = (new Date() - new Date(lastUsed)) / (1000 * 60);
                        restrictionMessage += `• Last used: ${Math.floor(timeSinceLastUse)} minutes ago\n`;
                    }
                    
                    restrictionMessage += `\n🚫 Limits for ${activityName}:\n`;
                    restrictionMessage += `• Max ${restriction.max} per day\n`;
                    restrictionMessage += `• ${restriction.cooldown} cooldown between uses\n`;
                    if (restriction.maxDuration) {
                        const formatTime = (minutes) => {
                            const hours = Math.floor(minutes / 60);
                            const mins = minutes % 60;
                            return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
                        };
                        restrictionMessage += `• Max ${formatTime(restriction.maxDuration)} total duration per day\n`;
                    }
                    
                    restrictionMessage += `\n💡 What you can do:\n`;
                    restrictionMessage += `• Try a different activity type\n`;
                    restrictionMessage += `• Wait for the cooldown to end\n`;
                    restrictionMessage += `• Come back tomorrow\n`;
                    restrictionMessage += `• Check Profile tab for all current limits\n\n`;
                    restrictionMessage += `🎯 These limits ensure sustainable, realistic habit building!`;
                    
                    alert(restrictionMessage);
                    game.addNotification(`🔒 ${activityName} restricted - see popup for details`);
                    return;
                }
                
                // Log the activity
                game.logActivity(skill, activity, duration, intensity, activityType);
                
                // Clear the input safely
                if (activityElement) {
                    activityElement.value = '';
                }
                
            } catch (error) {
                console.error('Error logging activity:', error);
                game.addNotification('❌ An error occurred while logging activity. Please try again.');
            }
        }
        
        // Helper function to get activity type information
        function getActivityTypeInfo(activityType) {
            const activityTypes = [
                {
                    value: 'normal',
                    label: '⚡ Normal Activity',
                    minDuration: 5,
                    maxDuration: 60
                },
                {
                    value: 'learning',
                    label: '📚 Learning & Study',
                    minDuration: 15,
                    maxDuration: 90
                },
                {
                    value: 'reading',
                    label: '📖 Reading',
                    minDuration: 10,
                    maxDuration: 120
                },
                {
                    value: 'mindfulness',
                    label: '🧘 Mindfulness & Meditation',
                    minDuration: 3,
                    maxDuration: 45
                },
                {
                    value: 'social',
                    label: '🤝 Social Activity',
                    minDuration: 10,
                    maxDuration: 180
                },
                {
                    value: 'creative',
                    label: '🎨 Creative Work',
                    minDuration: 20,
                    maxDuration: 120
                },
                {
                    value: 'deep_work',
                    label: '🎯 Deep Work',
                    minDuration: 25,
                    maxDuration: 180
                },
                {
                    value: 'group',
                    label: '👥 Group Activity',
                    minDuration: 15,
                    maxDuration: 240
                },
                {
                    value: 'combo',
                    label: '💥 Power Combo',
                    minDuration: 30,
                    maxDuration: 120
                }
            ];
            
            return activityTypes.find(type => type.value === activityType);
        }

        // Helper function to get required effort level for activity type
        function getRequiredEffortForActivityType(activityType) {
            const effortRequirements = {
                'normal': 1,        // Easy+ (flexible baseline)
                'reading': 1,       // Easy+ (relaxed to focused reading)
                'mindfulness': 1,   // Easy+ (gentle to deep meditation)
                'learning': 2,      // Moderate+ (requires focus)
                'social': 1,        // Easy+ (casual chat to intense discussion)
                'creative': 1,      // Easy+ (doodling to intensive creation)
                'group': 2,         // Moderate+ (group dynamics require engagement)
                'deep_work': 3,     // Hard+ (by definition requires intense focus)
                'combo': 3          // Hard+ (challenging multi-skill activity)
            };
            
            return effortRequirements[activityType] || 1;
        }

        // Helper function to get maximum realistic effort level for activity type
        function getMaxEffortForActivityType(activityType) {
            const maxEffortLevels = {
                'normal': 4,        // Easy to Extreme (depends on activity)
                'reading': 3,       // Easy to Hard (focused reading, not "extreme")
                'mindfulness': 3,   // Easy to Hard (deep meditation, not "extreme")
                'learning': 4,      // Easy to Extreme (cramming/intense study sessions)
                'social': 3,        // Easy to Hard (intense networking/presentations)
                'creative': 4,      // Easy to Extreme (creative flow states can be intense)
                'group': 4,         // Easy to Extreme (team sports, intense collaborations)
                'deep_work': 4,     // Hard to Extreme (peak performance work)
                'combo': 4          // Hard to Extreme (maximum challenge activities)
            };
            
            return maxEffortLevels[activityType] || 4;
        }

        // Helper function to get effort level description for activity type
        function getEffortDescription(activityType, effortLevel) {
            const descriptions = {
                'reading': {
                    1: '😌 Leisurely reading, casual browsing',
                    2: '⚡ Focused reading, taking notes', 
                    3: '🔥 Intensive study, complex material'
                },
                'mindfulness': {
                    1: '😌 Gentle breathing, light awareness',
                    2: '⚡ Focused meditation, guided practice',
                    3: '🔥 Deep contemplation, challenging practice'
                },
                'learning': {
                    1: '😌 Light review, casual learning',
                    2: '⚡ Focused study, active practice',
                    3: '🔥 Intensive memorization, complex concepts',
                    4: '💪 Exam prep, mastering difficult material'
                },
                'social': {
                    1: '😌 Casual chat, relaxed socializing',
                    2: '⚡ Engaging conversation, active listening',
                    3: '🔥 Presentations, intense discussions'
                },
                'creative': {
                    1: '😌 Casual sketching, light creativity',
                    2: '⚡ Focused creation, structured work',
                    3: '🔥 Intensive art, complex projects',
                    4: '💪 Creative breakthroughs, flow state'
                },
                'normal': {
                    1: '😌 Light activity, gentle movement',
                    2: '⚡ Moderate activity, steady effort',
                    3: '🔥 Vigorous activity, challenging pace',
                    4: '💪 Maximum effort, peak performance'
                }
            };
            
            const activityDescriptions = descriptions[activityType] || descriptions['normal'];
            return activityDescriptions[effortLevel] || `Level ${effortLevel} effort`;
        }

        // Update duration input limits when activity type changes
        function updateDurationLimits() {
            const activityTypeSelect = document.getElementById('activity-type-select');
            const durationInput = document.getElementById('duration-input');
            const durationHint = document.getElementById('duration-hint');
            
            if (!activityTypeSelect || !durationInput) return;
            
            const activityType = activityTypeSelect.value;
            const activityInfo = getActivityTypeInfo(activityType);
            
            if (activityInfo) {
                durationInput.min = activityInfo.minDuration;
                durationInput.max = activityInfo.maxDuration;
                
                // Update the hint
                if (durationHint) {
                    durationHint.textContent = `${activityInfo.minDuration}-${activityInfo.maxDuration} minutes for ${activityInfo.label.replace(/^[^\s]+ /, '')}`;
                }
                
                // Adjust current value if it's outside the new range
                const currentValue = parseInt(durationInput.value);
                if (currentValue < activityInfo.minDuration) {
                    durationInput.value = activityInfo.minDuration;
                } else if (currentValue > activityInfo.maxDuration) {
                    durationInput.value = activityInfo.maxDuration;
                }
            }
            
            // Also update effort level options
            updateEffortLevelOptions();
        }

        // Update effort level dropdown based on activity type
        function updateEffortLevelOptions() {
            const activityTypeSelect = document.getElementById('activity-type-select');
            const intensitySelect = document.getElementById('intensity-input');
            const effortExamples = document.getElementById('effort-examples');
            
            if (!activityTypeSelect || !intensitySelect) return;
            
            const activityType = activityTypeSelect.value;
            const minEffort = getRequiredEffortForActivityType(activityType);
            const maxEffort = getMaxEffortForActivityType(activityType);
            const currentValue = parseInt(intensitySelect.value);
            
            // Update options availability
            Array.from(intensitySelect.options).forEach((option, index) => {
                const level = index + 1;
                if (level < minEffort || level > maxEffort) {
                    option.disabled = true;
                    option.style.color = '#7f8c8d';
                } else {
                    option.disabled = false;
                    option.style.color = '#ffffff';
                }
            });
            
            // Adjust selected value if it's outside the valid range
            if (currentValue < minEffort) {
                intensitySelect.value = minEffort;
            } else if (currentValue > maxEffort) {
                intensitySelect.value = maxEffort;
            }
            
            // Update effort examples
            if (effortExamples) {
                let examples = '';
                for (let level = minEffort; level <= maxEffort; level++) {
                    examples += getEffortDescription(activityType, level) + '<br>';
                }
                effortExamples.innerHTML = examples;
            }
        }

        // Tutorial System
        let currentTutorialStep = 0;
        const tutorialSteps = [
            {
                title: "🏔️ Welcome to The Unbroken Ascent",
                content: `
                    <h3>Transform Your Life with Real Habits!</h3>
                    <p>This isn't just another habit tracker - it's a complete RPG system that makes building real habits fun and rewarding.</p>
                    <div class="tutorial-visual">🎮⚡🏆</div>
                    <p>You'll level up 5 core life skills, unlock special abilities, and track meaningful progress as you build an unbreakable foundation of success.</p>
                `,
                highlight: null
            },
            {
                title: "💪 The Five Core Skills",
                content: `
                    <h3>Master These Life-Changing Skills</h3>
                    <div class="tutorial-feature-grid">
                        <div class="tutorial-feature">
                            <span class="tutorial-feature-icon">💪</span>
                            <div class="tutorial-feature-text">Power<br>Physical & Fitness</div>
                        </div>
                        <div class="tutorial-feature">
                            <span class="tutorial-feature-icon">🧠</span>
                            <div class="tutorial-feature-text">Clarity<br>Mental & Learning</div>
                        </div>
                        <div class="tutorial-feature">
                            <span class="tutorial-feature-icon">🧘</span>
                            <div class="tutorial-feature-text">Balance<br>Mindfulness & Peace</div>
                        </div>
                        <div class="tutorial-feature">
                            <span class="tutorial-feature-icon">🤝</span>
                            <div class="tutorial-feature-text">Spirit<br>Social & Connection</div>
                        </div>
                        <div class="tutorial-feature">
                            <span class="tutorial-feature-icon">🎨</span>
                            <div class="tutorial-feature-text">Harmony<br>Creative & Expression</div>
                        </div>
                    </div>
                    <p>Each skill starts at Level 1 and can grow to Level 100, unlocking special abilities and bonuses along the way!</p>
                `,
                highlight: null,
                tab: 'skills'
            },
            {
                title: "⚔️ Logging Activities",
                content: `
                    <h3>Turn Real Actions into XP Gains!</h3>
                    <p>Every real activity you do becomes XP in the game. Whether it's a workout, reading session, meditation, or creative project - you get rewarded!</p>
                    <div class="tutorial-visual">📈</div>
                    <p><strong>How it works:</strong></p>
                    <p>1. Choose which skill to train<br>
                    2. Describe what you did<br>
                    3. Select activity type for bonuses<br>
                    4. Set duration and effort level<br>
                    5. Gain XP and level up!</p>
                `,
                highlight: null,
                tab: 'activity'
            },
            {
                title: "🎯 Activity Types & Bonuses",
                content: `
                    <h3>Unlock Special Activity Types!</h3>
                    <p>As you level up skills, you unlock specialized activity types with unique bonuses and abilities:</p>
                    <div class="tutorial-visual">🔓</div>
                    <p><strong>🧘 Mindfulness:</strong> Balance Lv1 - Clarity boost for all activities<br>
                    <strong>📚 Learning:</strong> Clarity Lv1 - Enhanced knowledge retention<br>
                    <strong>🚶 Movement:</strong> Power Lv3 - Vitality boost throughout the day<br>
                    <strong>🧩 Problem Solving:</strong> Clarity Lv5 - Strategy bonus for complex tasks<br>
                    <strong>🎯 Deep Work:</strong> Clarity Lv7 - 2x XP for focused sessions<br>
                    <strong>👥 Group Activity:</strong> Spirit Lv10 - Team synergy multiplier<br>
                    <strong>� Skill Combination:</strong> Harmony Lv12 - Multi-skill XP bonus<br>
                    <strong>💥 Power Breakthrough:</strong> Power Lv15 - Explosive growth sessions<br>
                    <strong>👑 Leadership:</strong> Spirit Lv20 - Influence multiplier<br>
                    <strong>🌊 Flow State:</strong> Balance Lv22 - Peak performance mode<br>
                    <strong>🏆 Mastery Project:</strong> Harmony Lv25 - Legacy building</p>
                    <p>Each type has unique benefits beyond just XP - they create real-world habit improvements!</p>
                `,
                highlight: null,
                tab: 'activity'
            },
            {
                title: "📖 Daily Lore & Wisdom",
                content: `
                    <h3>Ancient Wisdom for Modern Growth</h3>
                    <p>Each day, discover profound wisdom from the ancient mountain monastery of Vitalon. These aren't just stories - they're practical life philosophy!</p>
                    <div class="tutorial-visual">📜</div>
                    <p><strong>Features:</strong></p>
                    <p>• Daily wisdom passages<br>
                    • Interactive comprehension quizzes<br>
                    • Unlock special rewards for consistency<br>
                    • 30-day complete cycle with bonuses</p>
                    <p>Reading lore gives Clarity XP and helps build a growth mindset!</p>
                `,
                highlight: null,
                tab: 'lore'
            },
            {
                title: "📝 Reflection Journal",
                content: `
                    <h3>Track Your Inner Journey</h3>
                    <p>The journal system helps you reflect on your progress, set goals, and maintain mindfulness about your growth.</p>
                    <div class="tutorial-visual">✍️</div>
                    <p><strong>Journal Features:</strong></p>
                    <p>• Daily reflection prompts<br>
                    • Mood tracking with emojis<br>
                    • Streak building for consistency<br>
                    • Word count and XP rewards<br>
                    • Search and filter past entries</p>
                    <p>Regular journaling boosts multiple skills and provides mental clarity!</p>
                `,
                highlight: null,
                tab: 'journal'
            },
            {
                title: "🚀 Ready to Begin Your Ascent!",
                content: `
                    <h3>Your Journey Starts Now!</h3>
                    <p>You now have everything you need to begin transforming your life with The Unbroken Ascent system.</p>
                    <div class="tutorial-visual">🌟</div>
                    <p><strong>Quick Start Tips:</strong></p>
                    <p>1. Start with just 1-2 activities per day<br>
                    2. Focus on building consistency over intensity<br>
                    3. Read daily lore for wisdom and XP<br>
                    4. Use the journal to reflect on your growth<br>
                    5. Celebrate every level up - you earned it!</p>
                    <p><strong>Remember:</strong> This is about real progress in real life. The game just makes it more fun and rewarding!</p>
                `,
                highlight: null
            }
        ];

        function startTutorial() {
            // Mark tutorial as started
            localStorage.setItem('tutorialSeen', 'true');
            currentTutorialStep = 0;
            const modal = document.getElementById('tutorialModal');
            modal.style.display = 'flex';
            
            // Mobile-specific optimizations
            if (window.innerWidth <= 768) {
                // Prevent body scroll on mobile when tutorial is open
                document.body.style.overflow = 'hidden';
                
                // Ensure modal is positioned correctly on mobile
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                
                console.log('Mobile tutorial optimizations applied');
            }
            
            updateTutorialStep();
            
            // Add notification
            if (typeof game !== 'undefined') {
                game.addNotification('🎯 Tutorial started! Learn the system step by step.', 'success');
            }
        }

        function updateTutorialStep() {
            const step = tutorialSteps[currentTutorialStep];
            const modal = document.getElementById('tutorialModal');
            
            // Update content
            document.getElementById('tutorialTitle').innerHTML = step.title;
            document.getElementById('tutorialContent').innerHTML = step.content;
            document.getElementById('tutorialStep').textContent = currentTutorialStep + 1;
            document.getElementById('tutorialTotal').textContent = tutorialSteps.length;
            
            // Get button elements
            const prevBtn = document.getElementById('tutorialPrev');
            const nextBtn = document.getElementById('tutorialNext');
            const finishBtn = document.getElementById('tutorialFinish');
            const skipBtn = document.getElementById('tutorialSkip');
            
            // Update navigation buttons visibility using CSS classes
            if (prevBtn) {
                if (currentTutorialStep > 0) {
                    prevBtn.classList.add('show');
                    prevBtn.classList.remove('hide');
                } else {
                    prevBtn.classList.add('hide');
                    prevBtn.classList.remove('show');
                }
                console.log(`Previous button: step ${currentTutorialStep}, showing: ${prevBtn.classList.contains('show')}`);
            }
            
            if (nextBtn) {
                if (currentTutorialStep < tutorialSteps.length - 1) {
                    nextBtn.classList.add('show');
                    nextBtn.classList.remove('hide');
                    console.log(`Next button: step ${currentTutorialStep}, should show (${currentTutorialStep} < ${tutorialSteps.length - 1})`);
                } else {
                    nextBtn.classList.add('hide');
                    nextBtn.classList.remove('show');
                    console.log(`Next button: step ${currentTutorialStep}, hiding because it's the last step`);
                }
            }
            
            if (finishBtn) {
                if (currentTutorialStep === tutorialSteps.length - 1) {
                    finishBtn.classList.add('show');
                    finishBtn.classList.remove('hide');
                    console.log(`Finish button: showing on final step ${currentTutorialStep}`);
                } else {
                    finishBtn.classList.add('hide');
                    finishBtn.classList.remove('show');
                    console.log(`Finish button: hiding on step ${currentTutorialStep}`);
                }
            }
            
            if (skipBtn) {
                skipBtn.classList.add('show');
                skipBtn.classList.remove('hide');
            }
            
            console.log(`Tutorial step ${currentTutorialStep + 1}/${tutorialSteps.length}`);
            console.log('Button visibility:', {
                prev: prevBtn ? (prevBtn.classList.contains('show') ? 'visible' : 'hidden') : 'not found',
                next: nextBtn ? (nextBtn.classList.contains('show') ? 'visible' : 'hidden') : 'not found',
                finish: finishBtn ? (finishBtn.classList.contains('show') ? 'visible' : 'hidden') : 'not found'
            });
            
            // Mobile-specific enhancements: Force re-render buttons after a short delay
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    // Force re-render of button visibility on mobile
                    [prevBtn, nextBtn, finishBtn, skipBtn].forEach(btn => {
                        if (btn) {
                            const isVisible = btn.classList.contains('show');
                            btn.style.display = isVisible ? 'inline-block' : 'none';
                            console.log(`Mobile fix: ${btn.id} display set to ${btn.style.display}`);
                        }
                    });
                }, 100);
            }
            
            // Switch to relevant tab if specified
            if (step.tab) {
                setTimeout(() => {
                    switchTab(step.tab);
                    // Add extra delay for highlight after tab switch
                    if (step.highlight) {
                        setTimeout(() => {
                            updateTutorialHighlight(step.highlight);
                        }, 200);
                    }
                }, 500);
            } else {
                // Update highlight if specified and no tab switch needed
                updateTutorialHighlight(step.highlight);
            }
        }

        function updateTutorialHighlight(selector) {
            // Orange highlight box disabled - too buggy on mobile
            const highlight = document.getElementById('tutorialHighlight');
            const overlay = document.getElementById('tutorialOverlay');
            
            // Always hide highlight elements
            if (highlight) highlight.style.display = 'none';
            if (overlay) overlay.style.display = 'none';
            
            console.log(`Tutorial highlight: disabled (selector was "${selector}")`);
        }

        function tutorialNextStep() {
            if (currentTutorialStep < tutorialSteps.length - 1) {
                currentTutorialStep++;
                updateTutorialStep();
            }
        }

        function tutorialPreviousStep() {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                updateTutorialStep();
            }
        }

        function tutorialSkip() {
            if (confirm('Are you sure you want to skip the tutorial? You can replay it anytime from Settings.')) {
                tutorialFinish();
            }
        }

        function tutorialFinish() {
            document.getElementById('tutorialModal').style.display = 'none';
            document.getElementById('tutorialHighlight').style.display = 'none';
            document.getElementById('tutorialOverlay').style.display = 'none';
            
            // Restore mobile settings
            if (window.innerWidth <= 768) {
                document.body.style.overflow = 'auto';
                console.log('Mobile tutorial cleanup completed');
            }
            
            // Mark tutorial as completed
            localStorage.setItem('tutorialCompleted', 'true');
            
            // Switch to activity tab to get started
            switchTab('activity');
            
            // Welcome message
            if (typeof game !== 'undefined') {
                game.addNotification('🎉 Welcome to The Unbroken Ascent! Start by logging your first activity.', 'success');
            }
        }

        // Check if tutorial should auto-start on page load
        function checkTutorialAutoStart() {
            const tutorialSeen = localStorage.getItem('tutorialSeen');
            const tutorialCompleted = localStorage.getItem('tutorialCompleted');
            
            // Auto-start tutorial for first-time users
            if (!tutorialSeen && !tutorialCompleted) {
                setTimeout(() => {
                    startTutorial();
                }, 2000); // Wait 2 seconds after page load
            }
        }

        // Function to restart tutorial for testing
        function restartTutorial() {
            localStorage.removeItem('tutorialSeen');
            localStorage.removeItem('tutorialCompleted');
            startTutorial();
        }

        // Add restart tutorial to window for console access
        window.restartTutorial = restartTutorial;

        // Input sanitization function
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.replace(/[<>'"&]/g, '').trim();
        }
        
        // Validate that activity type is compatible with selected skill
        function validateActivityTypeForSkill(skill, activityType) {
            if (activityType === 'normal') return true; // Normal is always valid
            
            const skillActivityTypes = {
                power: ['combo'], // Power Combo is the only specialized type for Power
                clarity: ['deep_work', 'learning', 'reading'],
                balance: ['mindfulness'],
                spirit: ['social', 'group'],
                harmony: ['creative']
            };
            
            // However, all skills can use 'normal' activity type for basic activities
            return skillActivityTypes[skill] && skillActivityTypes[skill].includes(activityType);
        }
        
        // Tab system functions
        function switchTab(tabName) {
            try {
                console.log('🔄 Switching to tab:', tabName);
                
                // Hide all tab contents
                const tabContents = document.querySelectorAll('.tab-content');
                tabContents.forEach(tab => tab.classList.remove('active'));
                
                // Remove active class from all tab buttons
                const tabBtns = document.querySelectorAll('.tab-btn');
                tabBtns.forEach(btn => btn.classList.remove('active'));
                
                // Show selected tab
                const selectedTab = document.getElementById(`${tabName}-tab`);
                if (selectedTab) {
                    selectedTab.classList.add('active');
                    console.log('✅ Activated tab:', tabName);
                } else {
                    console.error('❌ Tab not found:', `${tabName}-tab`);
                }
                
                // Activate the correct tab button
                const selectedBtn = document.querySelector(`button[onclick*="'${tabName}'"]`);
                if (selectedBtn) {
                    selectedBtn.classList.add('active');
                    console.log('✅ Activated button for:', tabName);
                } else {
                    console.error('❌ Button not found for:', tabName);
                }
                
                // Special handling for specific tabs
                if (tabName === 'journal') {
                    setTimeout(() => {
                        if (typeof initializeJournal === 'function') initializeJournal();
                    }, 100);
                }
                
                if (tabName === 'skills' && window.game && typeof window.game.renderSkills === 'function') {
                    console.log('🎯 Re-rendering skills...');
                    setTimeout(() => window.game.renderSkills(), 100);
                }
                
                if (tabName === 'activity' && window.game && typeof window.game.updateActivityTypes === 'function') {
                    console.log('🔄 Updating available activity types...');
                    setTimeout(() => {
                        window.game.updateActivityTypes();
                        filterActivityTypes(); // Also filter based on selected skill
                    }, 100);
                }
                
                // Initialize lore when switching to it
                if (tabName === 'lore') {
                    setTimeout(() => initializeLoreTab(), 100);
                }
                
                // Handle legacy tab redirects
                if (tabName === 'integrations' || tabName === 'sync') {
                    // Redirect to settings tab
                    setTimeout(() => switchTab('settings'), 0);
                    return;
                }
                
                // Initialize settings tab (update integration UI)
                if (tabName === 'settings') {
                    setTimeout(() => {
                        if (game && game.updateIntegrationUI) {
                            game.updateIntegrationUI();
                        }
                    }, 100);
                }
                
            } catch (error) {
                console.error('❌ Error in switchTab:', error);
            }
        }
        
        // Integration management functions
        function toggleIntegration(appName) {
            game.toggleIntegration(appName);
        }
        
        function resetProgress() {
            if (confirm('🔄 Reset all progress?')) {
                localStorage.removeItem('unbrokenAscentWorking');
                location.reload();
            }
        }
        
        function resetProfile() {
            if (confirm('🔥 WARNING: This will reset EVERYTHING to default (progress, integrations, settings). Are you sure?')) {
                if (confirm('🚨 FINAL WARNING: This action cannot be undone. Reset entire profile?')) {
                    // Clear all localStorage data
                    localStorage.clear();
                    
                    // Reset all integration states
                    Object.keys(game.integrations).forEach(app => {
                        game.integrations[app].connected = false;
                        game.integrations[app].lastSync = null;
                    });
                    
                    // Add a notification about the reset
                    game.addNotification('🔥 Profile reset to default settings. Welcome back!');
                    
                    // Reload the page to start fresh
                    location.reload();
                }
            }
        }
        
        // PC Game Sync Functions
        let gameConnected = false;
        let autoSyncInterval = null;
        
        function connectToGame() {
            try {
                const connectBtn = document.getElementById('sync-connect-btn');
                const statusDot = document.getElementById('sync-status-dot');
                const statusText = document.getElementById('sync-status-text');
                const statusDetails = document.getElementById('sync-status-details');
                
                if (!connectBtn || !statusDot || !statusText || !statusDetails) {
                    game.addNotification('❌ Sync interface not found. Please refresh the page.');
                    return;
                }
                
                connectBtn.textContent = '🔄 Connecting...';
                connectBtn.disabled = true;
                statusDot.className = 'sync-status-indicator syncing';
                statusText.textContent = 'Connecting...';
                statusDetails.textContent = 'Establishing connection to PC game';
                
                // Simulate connection process with retry logic
                const attemptConnection = (retries = 3) => {
                    // Simulate random connection failure for realism
                    const connectionSuccess = Math.random() > 0.1; // 90% success rate
                    
                    if (connectionSuccess || retries <= 0) {
                        if (connectionSuccess) {
                            gameConnected = true;
                            connectBtn.textContent = '🔌 Disconnect';
                            connectBtn.disabled = false;
                            connectBtn.onclick = disconnectFromGame;
                            statusDot.className = 'sync-status-indicator connected';
                            statusText.textContent = 'Connected';
                            statusDetails.textContent = 'Connected to The Unbroken Ascent PC - Version 1.2.3';
                            
                            // Safely enable sync buttons
                            const syncFromBtn = document.getElementById('sync-from-btn');
                            const syncToBtn = document.getElementById('sync-to-btn');
                            const autoSyncBtn = document.getElementById('auto-sync-btn');
                            
                            if (syncFromBtn) syncFromBtn.disabled = false;
                            if (syncToBtn) syncToBtn.disabled = false;
                            if (autoSyncBtn) autoSyncBtn.disabled = false;
                            
                            addSyncHistoryItem('Connected to PC game');
                            game.addNotification('🎮 Connected to PC game successfully!');
                            
                            // Auto-enable auto-sync if checkbox is checked
                            const autoSyncCheckbox = document.getElementById('auto-sync-enabled');
                            if (autoSyncCheckbox && autoSyncCheckbox.checked) {
                                startAutoSync();
                            }
                        } else {
                            // Connection failed
                            connectBtn.textContent = '🎮 Connect to PC Game';
                            connectBtn.disabled = false;
                            statusDot.className = 'sync-status-indicator';
                            statusText.textContent = 'Connection Failed';
                            statusDetails.textContent = 'Could not connect to PC game. Make sure the game is running.';
                            
                            addSyncHistoryItem('Connection failed');
                            game.addNotification('❌ Failed to connect to PC game. Please make sure the game is running.');
                        }
                    } else {
                        // Retry connection
                        setTimeout(() => attemptConnection(retries - 1), 1000);
                    }
                };
                
                setTimeout(() => attemptConnection(), 2000);
                
            } catch (error) {
                console.error('Error connecting to game:', error);
                game.addNotification('❌ An error occurred while connecting to PC game.');
            }
        }
        
        function disconnectFromGame() {
            gameConnected = false;
            stopAutoSync();
            
            const connectBtn = document.getElementById('sync-connect-btn');
            const statusDot = document.getElementById('sync-status-dot');
            const statusText = document.getElementById('sync-status-text');
            const statusDetails = document.getElementById('sync-status-details');
            
            connectBtn.textContent = '🎮 Connect to PC Game';
            connectBtn.onclick = connectToGame;
            statusDot.className = 'sync-status-indicator';
            statusText.textContent = 'Not Connected';
            statusDetails.textContent = 'Connect to your PC game to sync progress';
            
            // Disable sync buttons
            document.getElementById('sync-from-btn').disabled = true;
            document.getElementById('sync-to-btn').disabled = true;
            document.getElementById('auto-sync-btn').disabled = true;
            
            addSyncHistoryItem('Disconnected from PC game');
            game.addNotification('🔌 Disconnected from PC game');
        }
        
        function syncFromGame() {
            if (!gameConnected) {
                game.addNotification('❌ Not connected to PC game');
                return;
            }
            
            try {
                const btn = document.getElementById('sync-from-btn');
                if (!btn) {
                    game.addNotification('❌ Sync button not found');
                    return;
                }
                
                btn.textContent = '⬇️ Downloading...';
                btn.disabled = true;
                showLoadingSpinner('sync-tab', true);
                
                // Create backup before sync
                createBackup();
                
                // Simulate downloading data from PC game with realistic progress
                setTimeout(() => {
                    try {
                        // In a real implementation, this would fetch actual game data
                        const currentTotal = Object.values(game.skills).reduce((sum, skill) => sum + skill.level, 0);
                        const pcGameData = {
                            skills: {
                                power: { 
                                    level: Math.max(game.skills.power.level, Math.min(100, game.skills.power.level + Math.floor(Math.random() * 3))), 
                                    xp: game.skills.power.xp + Math.floor(Math.random() * 8000) + 2000 
                                },
                                clarity: { 
                                    level: Math.max(game.skills.clarity.level, Math.min(100, game.skills.clarity.level + Math.floor(Math.random() * 2))), 
                                    xp: game.skills.clarity.xp + Math.floor(Math.random() * 5000) + 1500 
                                },
                                balance: { 
                                    level: Math.max(game.skills.balance.level, Math.min(100, game.skills.balance.level + Math.floor(Math.random() * 2))), 
                                    xp: game.skills.balance.xp + Math.floor(Math.random() * 3000) + 1000 
                                },
                                spirit: { 
                                    level: Math.max(game.skills.spirit.level, Math.min(100, game.skills.spirit.level + Math.floor(Math.random() * 2))), 
                                    xp: game.skills.spirit.xp + Math.floor(Math.random() * 2500) + 800 
                                },
                                harmony: { 
                                    level: Math.max(game.skills.harmony.level, Math.min(100, game.skills.harmony.level + Math.floor(Math.random() * 3))), 
                                    xp: game.skills.harmony.xp + Math.floor(Math.random() * 6000) + 2500 
                                }
                            },
                            lastSync: new Date().toISOString(),
                            syncVersion: '1.2.3'
                        };
                        
                        // Detect conflicts
                        const conflicts = detectSyncConflicts(game.skills, pcGameData.skills);
                        
                        if (conflicts.length > 0) {
                            const conflictResolution = document.getElementById('conflict-resolution');
                            const autoResolve = conflictResolution ? conflictResolution.checked : true;
                            
                            if (autoResolve) {
                                // Auto-resolve: PC game takes priority
                                resolveSyncConflicts(pcGameData.skills, 'pc');
                                game.addNotification(`⚠️ ${conflicts.length} conflicts detected and auto-resolved (PC game priority)`);
                            } else {
                                // Manual resolution needed
                                if (confirm(`⚠️ ${conflicts.length} conflicts detected:\n${conflicts.join('\n')}\n\nPC game takes priority. Continue?`)) {
                                    resolveSyncConflicts(pcGameData.skills, 'pc');
                                } else {
                                    btn.textContent = '⬇️ Download from PC Game';
                                    btn.disabled = false;
                                    showLoadingSpinner('sync-tab', false);
                                    return;
                                }
                            }
                        } else {
                            // No conflicts, safe to apply
                            applySyncData(pcGameData.skills);
                        }
                        
                        const totalXPGained = Object.values(pcGameData.skills).reduce((sum, skill) => 
                            sum + (skill.xp - game.skills[Object.keys(game.skills).find(k => game.skills[k].name === skill.name || k === Object.keys(pcGameData.skills).find(pk => pcGameData.skills[pk] === skill))].xp), 0
                        );
                        
                        game.saveData();
                        game.updateDisplay();
                        
                        btn.textContent = '⬇️ Download from PC Game';
                        btn.disabled = false;
                        showLoadingSpinner('sync-tab', false);
                        
                        addSyncHistoryItem(`Downloaded progress from PC game (+${totalXPGained.toLocaleString()} XP)`);
                        game.addNotification(`⬇️ Progress synced from PC game! +${totalXPGained.toLocaleString()} XP gained!`);
                        
                    } catch (error) {
                        console.error('Error in sync process:', error);
                        btn.textContent = '⬇️ Download from PC Game';
                        btn.disabled = false;
                        showLoadingSpinner('sync-tab', false);
                        game.addNotification('❌ Sync failed. Please try again.');
                    }
                }, 1500);
                
            } catch (error) {
                console.error('Error starting sync:', error);
                game.addNotification('❌ Failed to start sync process.');
            }
        }
        
        // Detect conflicts between local and remote data
        function detectSyncConflicts(localSkills, remoteSkills) {
            const conflicts = [];
            
            Object.keys(localSkills).forEach(skillKey => {
                if (remoteSkills[skillKey]) {
                    const local = localSkills[skillKey];
                    const remote = remoteSkills[skillKey];
                    
                    if (local.level > remote.level) {
                        conflicts.push(`${local.name}: Local level ${local.level} > PC level ${remote.level}`);
                    }
                    
                    if (local.xp > remote.xp && local.level <= remote.level) {
                        conflicts.push(`${local.name}: Local XP ${local.xp} > PC XP ${remote.xp} at same level`);
                    }
                }
            });
            
            return conflicts;
        }
        
        // Resolve sync conflicts based on strategy
        function resolveSyncConflicts(remoteSkills, strategy = 'pc') {
            if (strategy === 'pc') {
                // PC game takes priority
                applySyncData(remoteSkills);
            } else if (strategy === 'mobile') {
                // Keep mobile data (do nothing)
                return;
            } else if (strategy === 'merge') {
                // Take the higher values
                Object.keys(game.skills).forEach(skillKey => {
                    if (remoteSkills[skillKey]) {
                        const local = game.skills[skillKey];
                        const remote = remoteSkills[skillKey];
                        
                        game.skills[skillKey].level = Math.max(local.level, remote.level);
                        game.skills[skillKey].xp = Math.max(local.xp, remote.xp);
                        game.skills[skillKey].totalXP = Math.max(local.totalXP || 0, remote.totalXP || 0);
                    }
                });
            }
        }
        
        // Apply sync data to game state
        function applySyncData(remoteSkills) {
            Object.keys(game.skills).forEach(skillKey => {
                if (remoteSkills[skillKey]) {
                    const remote = remoteSkills[skillKey];
                    game.skills[skillKey].level = remote.level;
                    game.skills[skillKey].xp = remote.xp;
                    game.skills[skillKey].totalXP = remote.totalXP || game.skills[skillKey].totalXP;
                }
            });
        }
        
        function syncToGame() {
            if (!gameConnected) return;
            
            const btn = document.getElementById('sync-to-btn');
            btn.textContent = '⬆️ Uploading...';
            btn.disabled = true;
            
            // Simulate uploading data to PC game
            setTimeout(() => {
                btn.textContent = '⬆️ Upload to PC Game';
                btn.disabled = false;
                
                addSyncHistoryItem('Uploaded progress to PC game');
                game.addNotification('⬆️ Progress synced to PC game successfully!');
            }, 1200);
        }
        
        function autoSync() {
            if (!gameConnected) return;
            
            // Perform bidirectional sync
            syncFromGame();
            setTimeout(() => {
                syncToGame();
            }, 2000);
        }
        
        function toggleAutoSync() {
            const checkbox = document.getElementById('auto-sync-enabled');
            if (checkbox.checked && gameConnected) {
                startAutoSync();
            } else {
                stopAutoSync();
            }
        }
        
        function startAutoSync() {
            if (autoSyncInterval) stopAutoSync();
            
            autoSyncInterval = setInterval(() => {
                if (gameConnected) {
                    autoSync();
                    addSyncHistoryItem('Auto-sync performed');
                }
            }, 5 * 60 * 1000); // 5 minutes
            
            document.getElementById('auto-sync-btn').textContent = '🔄 Auto-Sync (ON)';
            game.addNotification('🔄 Auto-sync enabled (every 5 minutes)');
        }
        
        function stopAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
            document.getElementById('auto-sync-btn').textContent = '🔄 Auto-Sync';
        }
        
        function exportSaveData() {
            try {
                // Create backup
                createBackup();
                
                const saveData = {
                    version: '1.2.3',
                    exportDate: new Date().toISOString(),
                    appType: 'The Unbroken Ascent - Mobile Companion',
                    gameData: {
                        skills: game.skills,
                        streaks: game.streaks,
                        integrations: game.integrations,
                        notifications: game.notifications.slice(-50), // Only keep last 50 notifications
                        activities: game.activities || [],
                        dailyGoal: game.dailyGoal,
                        consistencyStreak: game.consistencyStreak,
                        totalXP: game.totalXP
                    },
                    metadata: {
                        totalLevels: Object.values(game.skills).reduce((sum, skill) => sum + skill.level, 0),
                        averageLevel: Object.values(game.skills).reduce((sum, skill) => sum + skill.level, 0) / 5,
                        connectedIntegrations: Object.values(game.integrations).filter(i => i.connected).length
                    }
                };
                
                const dataStr = JSON.stringify(saveData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `unbroken-ascent-save-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                game.addNotification('📦 Save data exported successfully!');
                addSyncHistoryItem('Exported save data');
                
            } catch (error) {
                console.error('Error exporting save data:', error);
                game.addNotification('❌ Failed to export save data. Please try again.');
            }
        }
        
        function importSaveData() {
            const fileInput = document.getElementById('save-file-input');
            if (fileInput) {
                fileInput.click();
            } else {
                game.addNotification('❌ File input not found. Please refresh the page.');
            }
        }
        
        function handleSaveFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.name.endsWith('.json')) {
                game.addNotification('❌ Please select a valid JSON save file.');
                return;
            }
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                game.addNotification('❌ Save file too large (max 5MB).');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const saveData = JSON.parse(e.target.result);
                    
                    // Validate save file structure
                    const validation = validateSaveFile(saveData);
                    if (!validation.valid) {
                        throw new Error(validation.error);
                    }
                    
                    // Check version compatibility
                    if (saveData.version && saveData.version !== '1.2.3') {
                        game.addNotification(`⚠️ Save file version (${saveData.version}) may not be fully compatible with current version (1.2.3).`);
                    }
                    
                    // Create backup before import
                    createBackup();
                    
                    // Confirm import with detailed info
                    const metadata = saveData.metadata || {};
                    const confirmMsg = `📥 Import save data?\n\nFile Info:\n• Total Levels: ${metadata.totalLevels || 'Unknown'}\n• Average Level: ${metadata.averageLevel?.toFixed(1) || 'Unknown'}\n• Connected Apps: ${metadata.connectedIntegrations || 'Unknown'}\n\nThis will overwrite your current progress.`;
                    
                    if (confirm(confirmMsg)) {
                        // Apply imported data with validation
                        if (saveData.gameData.skills) {
                            // Validate and sanitize skills data
                            Object.keys(saveData.gameData.skills).forEach(skillKey => {
                                if (game.skills[skillKey]) {
                                    const importedSkill = saveData.gameData.skills[skillKey];
                                    game.skills[skillKey].level = Math.max(1, Math.min(100, parseInt(importedSkill.level) || 1));
                                    game.skills[skillKey].xp = Math.max(0, parseInt(importedSkill.xp) || 0);
                                    game.skills[skillKey].totalXP = Math.max(0, parseInt(importedSkill.totalXP) || 0);
                                }
                            });
                        }
                        
                        if (saveData.gameData.streaks !== undefined) {
                            game.streaks = Math.max(0, parseInt(saveData.gameData.streaks) || 0);
                        }
                        
                        if (saveData.gameData.integrations) {
                            // Safely merge integrations
                            Object.keys(saveData.gameData.integrations).forEach(appKey => {
                                if (game.integrations[appKey]) {
                                    game.integrations[appKey].connected = Boolean(saveData.gameData.integrations[appKey].connected);
                                    game.integrations[appKey].lastSync = saveData.gameData.integrations[appKey].lastSync || null;
                                }
                            });
                        }
                        
                        if (saveData.gameData.dailyGoal !== undefined) {
                            game.dailyGoal = Math.max(1, Math.min(20, parseInt(saveData.gameData.dailyGoal) || 2));
                        }
                        
                        if (saveData.gameData.consistencyStreak !== undefined) {
                            game.consistencyStreak = Math.max(0, parseInt(saveData.gameData.consistencyStreak) || 0);
                        }
                        
                        game.saveData();
                        game.updateDisplay();
                        
                        game.addNotification('📥 Save data imported successfully!');
                        addSyncHistoryItem('Imported save data');
                    }
                } catch (error) {
                    console.error('Error importing save file:', error);
                    game.addNotification(`❌ Error importing save file: ${error.message}`);
                }
            };
            
            reader.onerror = function() {
                game.addNotification('❌ Error reading save file. Please try again.');
            };
            
            reader.readAsText(file);
            
            // Reset the input
            event.target.value = '';
        }
        
        // Validate save file structure
        function validateSaveFile(saveData) {
            if (!saveData || typeof saveData !== 'object') {
                return { valid: false, error: 'Invalid save file format' };
            }
            
            if (!saveData.gameData || typeof saveData.gameData !== 'object') {
                return { valid: false, error: 'Missing game data in save file' };
            }
            
            // Check for required fields
            const requiredFields = ['skills'];
            for (const field of requiredFields) {
                if (!saveData.gameData[field]) {
                    return { valid: false, error: `Missing required field: ${field}` };
                }
            }
            
            // Validate skills structure
            const skills = saveData.gameData.skills;
            const requiredSkills = ['power', 'clarity', 'balance', 'spirit', 'harmony'];
            for (const skillKey of requiredSkills) {
                if (!skills[skillKey] || typeof skills[skillKey] !== 'object') {
                    return { valid: false, error: `Invalid or missing skill: ${skillKey}` };
                }
            }
            
            return { valid: true };
        }
        
        // Create backup of current data
        function createBackup() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    gameData: {
                        skills: game.skills,
                        streaks: game.streaks,
                        integrations: game.integrations,
                        totalXP: game.totalXP
                    }
                };
                
                localStorage.setItem('unbrokenAscentBackup', JSON.stringify(backupData));
                
            } catch (error) {
                console.error('Error creating backup:', error);
            }
        }
        
        function addSyncHistoryItem(action) {
            const historyContainer = document.getElementById('sync-history');
            const historyItem = document.createElement('div');
            historyItem.className = 'sync-history-item';
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            historyItem.innerHTML = `
                <span class="sync-history-time">${timeStr}</span>
                <span class="sync-history-action">${action}</span>
            `;
            
            // Add to top and limit to 10 items
            historyContainer.insertBefore(historyItem, historyContainer.firstChild);
            while (historyContainer.children.length > 10) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        }
        
        document.getElementById('activity-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                logActivity();
            }
        });

        // Filter activity types based on selected skill
        document.getElementById('skill-select').addEventListener('change', function() {
            filterActivityTypes();
        });

        function filterActivityTypes() {
            const selectedSkill = document.getElementById('skill-select').value;
            const activityTypeSelect = document.getElementById('activity-type-select');
            const activityTypeHint = document.getElementById('activity-type-hint');
            const options = activityTypeSelect.querySelectorAll('option');
            
            // Reset to normal activity when skill changes
            activityTypeSelect.value = 'normal';
            
            options.forEach(option => {
                const optionSkill = option.getAttribute('data-skill');
                
                if (option.value === 'normal') {
                    // Normal activity is always available
                    option.disabled = false;
                    option.style.display = '';
                } else if (optionSkill === selectedSkill) {
                    // Enable options for the selected skill
                    option.disabled = false;
                    option.style.display = '';
                } else if (optionSkill) {
                    // Disable and hide options for other skills
                    option.disabled = true;
                    option.style.display = 'none';
                }
            });
            
            // Update hint text based on selected skill
            const skillNames = {
                power: 'Power (Fitness)',
                clarity: 'Clarity (Mental)', 
                balance: 'Balance (Mindfulness)',
                spirit: 'Spirit (Social)',
                harmony: 'Harmony (Creative)'
            };
            
            activityTypeHint.textContent = `Showing activity types for ${skillNames[selectedSkill]}. Unlock ability bonuses with specific types!`;
        }

        // Initialize filtering on page load
        filterActivityTypes();
        
        // Add event listener for skill changes to filter activity types
        const skillSelect = document.getElementById('skill-select');
        if (skillSelect) {
            skillSelect.addEventListener('change', filterActivityTypes);
        }
        
        // Add event listener for activity type changes to update duration limits
        const activityTypeSelect = document.getElementById('activity-type-select');
        if (activityTypeSelect) {
            activityTypeSelect.addEventListener('change', updateDurationLimits);
            // Set initial duration limits
            updateDurationLimits();
        }

        // Close modal when clicking outside of it
        document.getElementById('skillTreeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                game.closeSkillTree();
            }
        });
        
        // Additional Utility Functions
        
        // Format date consistently across the app
        function formatDate(date, format = 'short') {
            if (!date) return 'Never';
            const d = new Date(date);
            
            if (format === 'short') {
                return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
            } else if (format === 'time') {
                return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (format === 'full') {
                return d.toLocaleDateString([], { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
            return d.toLocaleDateString();
        }
        
        // Show loading spinner for async operations
        function showLoadingSpinner(elementId, show = true) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (show) {
                element.style.opacity = '0.6';
                element.style.pointerEvents = 'none';
            } else {
                element.style.opacity = '1';
                element.style.pointerEvents = 'auto';
            }
        }
        
        // Handle offline mode detection
        function handleOfflineMode() {
            const isOnline = navigator.onLine;
            
            if (!isOnline) {
                game.addNotification('📵 You are offline. Some features may be limited.');
                
                // Disable sync functions when offline
                const syncButtons = ['sync-connect-btn', 'sync-from-btn', 'sync-to-btn', 'auto-sync-btn'];
                syncButtons.forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) {
                        btn.disabled = true;
                        btn.title = 'Requires internet connection';
                    }
                });
            } else {
                game.addNotification('🌐 You are back online!');
                
                // Re-enable sync functions when back online
                if (gameConnected) {
                    const syncButtons = ['sync-from-btn', 'sync-to-btn', 'auto-sync-btn'];
                    syncButtons.forEach(btnId => {
                        const btn = document.getElementById(btnId);
                        if (btn) {
                            btn.disabled = false;
                            btn.title = '';
                        }
                    });
                }
            }
        }
        
        // Export debug information for troubleshooting
        function exportDebugInfo() {
            try {
                const debugInfo = {
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    gameState: {
                        skills: game.skills,
                        streak: game.streak,
                        totalXP: game.totalXP,
                        todayActivities: game.todayActivities,
                        dailyGoal: game.dailyGoal,
                        consistencyStreak: game.consistencyStreak
                    },
                    integrations: Object.fromEntries(
                        Object.entries(game.integrations).map(([key, value]) => [
                            key, 
                            { connected: value.connected, lastSync: value.lastSync }
                        ])
                    ),
                    syncStatus: {
                        gameConnected: gameConnected,
                        autoSyncRunning: autoSyncInterval !== null
                    },
                    localStorage: {
                        hasData: localStorage.getItem('unbrokenAscentWorking') !== null,
                        hasBackup: localStorage.getItem('unbrokenAscentBackup') !== null,
                        dataSize: (localStorage.getItem('unbrokenAscentWorking') || '').length
                    },
                    performance: {
                        memoryUsage: performance.memory ? {
                            used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + ' MB',
                            total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024) + ' MB'
                        } : 'Not available'
                    }
                };
                
                const debugStr = JSON.stringify(debugInfo, null, 2);
                const debugBlob = new Blob([debugStr], { type: 'application/json' });
                const url = URL.createObjectURL(debugBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `unbroken-ascent-debug-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                game.addNotification('🔧 Debug information exported successfully!');
                
            } catch (error) {
                console.error('Error exporting debug info:', error);
                game.addNotification('❌ Failed to export debug information.');
            }
        }
        
        // Validate activity type mapping completeness
        function validateActivityTypeMapping() {
            const allActivityTypes = [
                'normal', 'combo', 'focus', 'learning', 'deep_work', 'problem_solving', 
                'reading', 'mindfulness', 'balance_physical', 'movement', 'social', 
                'helping_others', 'group', 'creative', 'environment'
            ];
            
            const mappedTypes = new Set();
            const skillActivityTypes = {
                power: ['combo'],
                clarity: ['focus', 'learning', 'deep_work', 'problem_solving', 'reading', 'mindfulness'],
                balance: ['balance_physical', 'movement'],
                spirit: ['social', 'helping_others', 'group'],
                harmony: ['creative', 'environment']
            };
            
            Object.values(skillActivityTypes).forEach(types => {
                types.forEach(type => mappedTypes.add(type));
            });
            
            const unmappedTypes = allActivityTypes.filter(type => 
                type !== 'normal' && !mappedTypes.has(type)
            );
            
            if (unmappedTypes.length > 0) {
                console.warn('Unmapped activity types:', unmappedTypes);
                return false;
            }
            
            return true;
        }
        
        // Initialize offline mode detection
        window.addEventListener('online', handleOfflineMode);
        window.addEventListener('offline', handleOfflineMode);
        
        // Validate activity type mapping on load
        if (!validateActivityTypeMapping()) {
            console.warn('Activity type mapping validation failed');
        }
        
        // Performance monitoring
        if (performance.mark) {
            performance.mark('app-loaded');
        }
        
        // Console helper for debugging
        window.debugGame = {
            exportDebug: exportDebugInfo,
            validateMapping: validateActivityTypeMapping,
            game: game,
            syncStatus: () => ({ gameConnected, autoSyncInterval: autoSyncInterval !== null }),
            testNotification: (msg) => game.addNotification(msg || '🧪 Test notification'),
            clearData: () => {
                if (confirm('Clear all data? This cannot be undone!')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        };
        
        // Show current limits popup (called from Activity tab button)
        function showCurrentLimits() {
            const today = new Date().toDateString();
            
            // Get current usage across all tiers
            const totalActivities = parseInt(localStorage.getItem(`total_activities_${today}`) || '0');
            const totalDuration = parseInt(localStorage.getItem(`total_duration_${today}`) || '0');
            const totalXP = parseInt(localStorage.getItem(`total_xp_${today}`) || '0');
            const currentHour = new Date().getHours();
            const hourlyActivities = parseInt(localStorage.getItem(`activities_hour_${today}_${currentHour}`) || '0');
            
            // Get tier-specific usage
            const verifiedActivities = parseInt(localStorage.getItem(`verified_activities_${today}`) || '0');
            const timeTrackedActivities = parseInt(localStorage.getItem(`time-tracked_activities_${today}`) || '0');
            const selfReportedActivities = parseInt(localStorage.getItem(`self-reported_activities_${today}`) || '0');
            
            const verifiedDuration = parseInt(localStorage.getItem(`verified_duration_${today}`) || '0');
            const timeTrackedDuration = parseInt(localStorage.getItem(`time-tracked_duration_${today}`) || '0');
            const selfReportedDuration = parseInt(localStorage.getItem(`self-reported_duration_${today}`) || '0');
            
            const verifiedXP = parseInt(localStorage.getItem(`verified_xp_${today}`) || '0');
            const timeTrackedXP = parseInt(localStorage.getItem(`time-tracked_xp_${today}`) || '0');
            const selfReportedXP = parseInt(localStorage.getItem(`self-reported_xp_${today}`) || '0');
            
            const formatTime = (minutes) => {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
            };
            
            // Build comprehensive limits message with anti-exploit tiers
            let message = `📊 YOUR CURRENT DAILY LIMITS\n(Anti-Exploit Multi-Tier System)\n\n`;
            
            // Global totals
            message += `🌍 TOTAL USAGE (ALL TIERS):\n`;
            message += `• Activities: ${totalActivities} total\n`;
            message += `• Duration: ${formatTime(totalDuration)} total\n`;
            message += `• XP Earned: ${totalXP.toLocaleString()} total\n`;
            message += `• This Hour: ${hourlyActivities}/varies per tier\n\n`;
            
            // Tier breakdown
            message += `🔐 TIER 1 - VERIFIED (Hardware-tracked):\n`;
            message += `• Activities: ${verifiedActivities}/15 (${Math.round((verifiedActivities/15)*100)}%)\n`;
            message += `• Duration: ${formatTime(verifiedDuration)}/12h (${Math.round((verifiedDuration/720)*100)}%)\n`;
            message += `• XP: ${verifiedXP.toLocaleString()}/40,000 (${Math.round((verifiedXP/40000)*100)}%)\n`;
            message += `• Rate: Up to 6/hour - Bypass most limits!\n\n`;
            
            message += `⏱️ TIER 2 - TIME-TRACKED (App-verified):\n`;
            message += `• Activities: ${timeTrackedActivities}/12 (${Math.round((timeTrackedActivities/12)*100)}%)\n`;
            message += `• Duration: ${formatTime(timeTrackedDuration)}/9h (${Math.round((timeTrackedDuration/540)*100)}%)\n`;
            message += `• XP: ${timeTrackedXP.toLocaleString()}/25,000 (${Math.round((timeTrackedXP/25000)*100)}%)\n`;
            message += `• Rate: Up to 4/hour - Relaxed limits\n\n`;
            
            message += `📝 TIER 3 - SELF-REPORTED (Standard):\n`;
            message += `• Activities: ${selfReportedActivities}/8 (${Math.round((selfReportedActivities/8)*100)}%)\n`;
            message += `• Duration: ${formatTime(selfReportedDuration)}/6h (${Math.round((selfReportedDuration/360)*100)}%)\n`;
            message += `• XP: ${selfReportedXP.toLocaleString()}/15,000 (${Math.round((selfReportedXP/15000)*100)}%)\n`;
            message += `• Rate: Up to 3/hour - Full limits apply\n\n`;
            
            // Activity type limits 
            message += `🎯 ACTIVITY TYPE LIMITS (Tier 3 only):\n`;
            const activityTypes = [
                { key: 'normal', name: 'Normal (Power)', max: 4, cooldown: '20min', maxDuration: 240 },
                { key: 'focus', name: 'Focus (Power)', max: 3, cooldown: '90min', maxDuration: 180 },
                { key: 'deep_work', name: 'Deep Work (Clarity)', max: 2, cooldown: '3h', maxDuration: 180 },
                { key: 'learning', name: 'Learning (Clarity)', max: 3, cooldown: '1h', maxDuration: 180 },
                { key: 'reading', name: 'Reading (Clarity)', max: 4, cooldown: '30min', maxDuration: 180 },
                { key: 'creative', name: 'Creative (Creative)', max: 3, cooldown: '90min', maxDuration: 240 },
                { key: 'group', name: 'Group (Social)', max: 2, cooldown: '2h', maxDuration: 240 },
                { key: 'social', name: 'Social (Social)', max: 3, cooldown: '45min', maxDuration: 180 },
                { key: 'combo', name: 'Combo (Grit)', max: 1, cooldown: '6h', maxDuration: 120 },
                { key: 'mindfulness', name: 'Mindfulness (Any)', max: 4, cooldown: '30min', maxDuration: 90 }
            ];
            
            activityTypes.forEach(type => {
                const usageKey = `activity_usage_${type.key}_${today}`;
                const durationKey = `activity_duration_${type.key}_${today}`;
                const lastUsedKey = `activity_last_${type.key}`;
                
                const currentUsage = parseInt(localStorage.getItem(usageKey) || '0');
                const currentDuration = parseInt(localStorage.getItem(durationKey) || '0');
                const lastUsed = localStorage.getItem(lastUsedKey);
                
                const remaining = type.max - currentUsage;
                let status = remaining > 0 ? '✅' : '🔴';
                
                message += `${status} ${type.name}: ${remaining}/${type.max}`;
                
                if (type.maxDuration) {
                    const durationRemaining = type.maxDuration - currentDuration;
                    message += ` (${formatTime(durationRemaining)} time left)`;
                }
                
                // Show cooldown status
                if (lastUsed && remaining > 0) {
                    const timeSinceLastUse = (new Date() - new Date(lastUsed)) / (1000 * 60);
                    const cooldownMinutes = type.cooldown.includes('h') ? 
                        parseInt(type.cooldown) * 60 : 
                        parseInt(type.cooldown);
                    
                    if (timeSinceLastUse < cooldownMinutes) {
                        const timeLeft = cooldownMinutes - timeSinceLastUse;
                        message += ` - Cooldown: ${Math.ceil(timeLeft)}min left`;
                    } else {
                        message += ` - Ready to use!`;
                    }
                }
                
                message += `\n`;
            });
            
            message += `\n🛡️ ANTI-EXPLOIT PROTECTIONS:\n`;
            message += `• 3-tier verification system (Verified > Time-tracked > Self-reported)\n`;
            message += `• Hardware-tracked activities get higher limits but still realistic\n`;
            message += `• App-verified time gets relaxed but reasonable limits\n`;
            message += `• Self-reported activities have full restrictions\n`;
            message += `• Max 16 hours total activity per day (physical reality)\n`;
            message += `• 5-minute minimum between activities (transition time)\n`;
            message += `• Intensity & duration limits based on human capacity\n\n`;
            
            message += `💡 INTEGRATION BENEFITS:\n`;
            message += `• Connect Strava/Fitbit/Garmin for verified bypass\n`;
            message += `• Use Toggl/Forest/Headspace for relaxed limits\n`;
            message += `• All activities still count toward your progress!\n\n`;
            
            message += `🎯 Built for real humans with real apps, not exploit farms!`;
            
            // Show the popup alert
            alert(message);
        }
        
        // Test function to demonstrate limit enforcement (for development/testing)
        function testLimitEnforcement() {
            const testMessages = [
                "🎉 This is a test of the error popup system!\n\nWhen you hit limits in the app, you'll see detailed popups like this with:\n• Current usage statistics\n• What limits you've hit\n• Helpful guidance on what to do next\n\nTry logging multiple activities quickly to see the real limits in action!",
                "⚠️ EXAMPLE: Daily Activity Limit Reached!\n\n📊 Current Usage:\n• Activities: 8/8 (100%)\n• Total Time: 6h 0m/6h\n• XP Earned: 15,000/15,000\n\n🚫 You've reached realistic daily limits!\n\n💡 Quality over quantity - come back tomorrow!",
                "🔒 EXAMPLE: Deep Work Activity Restricted!\n\n📊 Current Usage:\n• Count: 2/2 activities\n• Duration: 3h 0m/3h total\n• Last used: 90 minutes ago\n\n🚫 Limits for Deep Work:\n• Max 2 per day (realistic for average person)\n• 3 hour cooldown between uses\n\n💡 Try a different activity type or wait for cooldown!"
            ];
            
            const randomMessage = testMessages[Math.floor(Math.random() * testMessages.length)];
            alert(randomMessage);
        }
        
        console.log('🎮 The Unbroken Ascent loaded successfully!');
        
        // Make functions globally accessible
        window.submitJournalEntry = submitJournalEntry;
        window.initializeJournal = initializeJournal;
        window.updateCharCount = updateCharCount;
        window.showJournalNotification = showJournalNotification;
        window.game = game;
        
        // Setup journal event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const journalInput = document.getElementById('journal-input');
            if (journalInput) {
                journalInput.addEventListener('input', updateCharCount);
                journalInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        submitJournalEntry();
                    }
                });
            }
            
            // Setup intensity guide toggle
            const intensityLabel = document.querySelector('label[for="intensity-input"], label:has(+ #intensity-input)');
            if (intensityLabel) {
                const infoIcon = intensityLabel.querySelector('span[title="Click for intensity guide"]');
                if (infoIcon) {
                    infoIcon.addEventListener('click', function() {
                        const guide = document.getElementById('intensity-guide');
                        if (guide) {
                            guide.style.display = guide.style.display === 'none' ? 'block' : 'none';
                        }
                    });
                    infoIcon.style.cursor = 'pointer';
                }
            }
            
            // Try to initialize journal if it's the active tab on page load
            setTimeout(() => {
                const journalTab = document.getElementById('journal-tab');
                if (journalTab && journalTab.classList.contains('active')) {
                    initializeJournal();
                }
            }, 1000);
            
            // Check if tutorial should auto-start for new users
            checkTutorialAutoStart();
        });

        // Developer Menu Functions
        function showDevMenu() {
            document.getElementById('devMenuModal').style.display = 'block';
        }

        function hideDevMenu() {
            document.getElementById('devMenuModal').style.display = 'none';
            // Reset password section
            document.getElementById('devPasswordSection').style.display = 'block';
            document.getElementById('devMenuContent').style.display = 'none';
            document.getElementById('devPassword').value = '';
        }

        function checkDevPassword() {
            const password = document.getElementById('devPassword').value.toLowerCase();
            if (password === 'unbroken') {
                document.getElementById('devPasswordSection').style.display = 'none';
                document.getElementById('devMenuContent').style.display = 'block';
                game.addNotification('🔓 Developer mode activated!', 'success');
            } else {
                game.addNotification('❌ Incorrect password!');
                document.getElementById('devPassword').value = '';
            }
        }

        // Quick Stats Functions
        function devSetSkillLevels(level) {
            Object.keys(game.skills).forEach(skillKey => {
                game.skills[skillKey].level = level;
                game.skills[skillKey].xp = game.xpForLevel(level);
                game.skills[skillKey].totalXP = game.xpForLevel(level);
            });
            game.renderSkills();
            game.updateActivityTypes();
            game.addNotification(`🚀 All skills set to Level ${level}!`, 'success');
        }

        function devSetIndividualSkill(skillName) {
            const inputId = skillName + 'Level';
            const level = parseInt(document.getElementById(inputId).value);
            if (level >= 1 && level <= 100) {
                game.skills[skillName].level = level;
                game.skills[skillName].xp = game.xpForLevel(level);
                game.skills[skillName].totalXP = game.xpForLevel(level);
                game.renderSkills();
                game.updateActivityTypes();
                game.addNotification(`💪 ${game.skills[skillName].name} set to Level ${level}!`, 'success');
            } else {
                game.addNotification('❌ Level must be between 1 and 100!');
            }
        }

        // XP & Streaks Functions
        function devAddXP(amount) {
            game.totalXP += amount;
            game.dailyXP += amount;
            // Distribute XP across all skills
            const xpPerSkill = Math.floor(amount / 5);
            Object.keys(game.skills).forEach(skillKey => {
                game.skills[skillKey].xp += xpPerSkill;
                game.skills[skillKey].totalXP += xpPerSkill;
                // Check for level ups
                while (game.skills[skillKey].xp >= game.xpForLevel(game.skills[skillKey].level + 1)) {
                    game.skills[skillKey].xp -= game.xpForLevel(game.skills[skillKey].level + 1);
                    game.skills[skillKey].level++;
                }
            });
            game.renderSkills();
            game.updateActivityTypes();
            game.addNotification(`📈 Added ${amount.toLocaleString()} XP!`, 'success');
        }

        function devSetStreak(days) {
            game.streak = days;
            game.consistencyStreak = days;
            game.addNotification(`🔥 Streak set to ${days} days!`, 'success');
        }

        // Content Unlocks Functions
        function devUnlockAllActivities() {
            // Set all skills to level 15+ to unlock all activities
            Object.keys(game.skills).forEach(skillKey => {
                if (game.skills[skillKey].level < 15) {
                    game.skills[skillKey].level = 15;
                    game.skills[skillKey].xp = game.xpForLevel(15);
                    game.skills[skillKey].totalXP = game.xpForLevel(15);
                }
            });
            game.renderSkills();
            game.updateActivityTypes();
            game.addNotification('🔓 All activity types unlocked!', 'success');
        }

        function devCompleteLore() {
            game.loreData.currentDay = 30;
            game.loreData.totalRead = 30;
            game.loreData.xpEarned = 3000;
            game.loreData.streak = 30;
            game.loreData.unlockedContent = ['week_warrior', 'lore_keeper', 'twice_told'];
            game.renderUnlockedContent();
            game.addNotification('📚 All lore content completed!', 'success');
        }

        function devMaxJournal() {
            game.journalStreak = 100;
            game.journalStats.totalEntries = 200;
            game.journalStats.totalWords = 50000;
            game.journalStats.totalXP = 5000;
            game.addNotification('📝 Journal stats maxed out!', 'success');
        }

        function devUnlockAllIntegrations() {
            // Enable all integrations
            Object.keys(game.integrations).forEach(appName => {
                game.integrations[appName].enabled = true;
            });
            if (game.updateIntegrationUI) {
                game.updateIntegrationUI();
            }
            game.addNotification('🔗 All integrations enabled!', 'success');
        }

        // Reset Functions
        function devResetToday() {
            const today = new Date().toDateString();
            game.todayActivities = 0;
            game.skillsTrained = new Set();
            game.dailyXP = 0;
            game.dailyGoalMet = false;
            // Clear localStorage for today
            Object.keys(localStorage).forEach(key => {
                if (key.includes(today)) {
                    localStorage.removeItem(key);
                }
            });
            game.addNotification('🔄 Today\'s activities reset!', 'success');
        }

        function devResetSkills() {
            Object.keys(game.skills).forEach(skillKey => {
                game.skills[skillKey].level = 1;
                game.skills[skillKey].xp = 0;
                game.skills[skillKey].totalXP = 0;
            });
            game.renderSkills();
            game.updateActivityTypes();
            game.addNotification('🔄 All skills reset to Level 1!', 'success');
        }

        function devResetEverything() {
            if (confirm('⚠️ This will reset ALL progress! Are you sure?')) {
                if (confirm('🚨 FINAL WARNING: This cannot be undone! Reset everything?')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }

        // Test Scenarios
        function devNewPlayerTest() {
            devResetSkills();
            game.streak = 0;
            game.totalXP = 0;
            game.todayActivities = 0;
            game.addNotification('🆕 New player scenario loaded!', 'success');
        }

        function devMidGameTest() {
            devSetSkillLevels(25);
            game.streak = 30;
            game.totalXP = 50000;
            game.addNotification('🎮 Mid-game scenario loaded!', 'success');
        }

        function devEndGameTest() {
            devSetSkillLevels(80);
            game.streak = 200;
            game.totalXP = 500000;
            devCompleteLore();
            devMaxJournal();
            game.addNotification('👑 End-game scenario loaded!', 'success');
        }

        function devRandomProgress() {
            Object.keys(game.skills).forEach(skillKey => {
                const randomLevel = Math.floor(Math.random() * 50) + 1;
                game.skills[skillKey].level = randomLevel;
                game.skills[skillKey].xp = game.xpForLevel(randomLevel);
                game.skills[skillKey].totalXP = game.xpForLevel(randomLevel);
            });
            game.streak = Math.floor(Math.random() * 100) + 1;
            game.renderSkills();
            game.updateActivityTypes();
            game.addNotification('🎲 Random progression generated!', 'success');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('devMenuModal');
            if (event.target === modal) {
                hideDevMenu();
            }
        }

        // Settings Toggle Functions
        function toggleShowDetails(checked) {
            console.log('toggleShowDetails called with:', checked);
            
            if (window.game) {
                window.game.settings.showMechanicalDetails = checked;
                window.game.saveData();
                
                console.log('Settings updated:', window.game.settings);
                
                // Update all mechanical details visibility immediately
                const mechanicalDetails = document.querySelectorAll('.ability-mechanical-details');
                console.log('Found mechanical details elements:', mechanicalDetails.length);
                
                mechanicalDetails.forEach(detail => {
                    if (checked) {
                        detail.classList.add('show');
                        console.log('Added show class to element');
                    } else {
                        detail.classList.remove('show');
                        console.log('Removed show class from element');
                    }
                });
                
                window.game.addNotification(
                    checked ? '🔧 Mechanical details enabled' : '🔧 Simplified view enabled', 
                    'success'
                );
            } else {
                console.error('Game object not found!');
            }
        }
    </script>
</body>
</html>
